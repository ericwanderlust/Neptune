<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧水务监测系统 v3.0 - 模块化版本</title>
    
    <!-- 第三方库 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@2.3.0/dist/leaflet-measure.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="common_styles.css">
    
    <!-- 投影库 -->
    <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.0/dist/proj4.js"></script>
    
    <style>
        /* 模块化版本特定样式 */
        .version-badge {
            position: fixed;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: fadeInDown 0.6s ease-out;
        }
        
        .loading-progress {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4A90B8, #74b9ff);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }
        
        .loading-status-text {
            text-align: center;
            margin-top: 10px;
            color: var(--text-dark);
            font-size: 14px;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate3d(0, -20px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }
        
        /* 增强的加载界面 */
        #loadingIndicator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        #loadingIndicator h3 {
            color: white;
        }
        
        .loading-spinner {
            position: relative;
            width: 60px;
            height: 60px;
            margin: 0 auto 30px;
        }
        
        .loading-spinner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .module-info {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* 管道样式 */
        .water-pipe {
            cursor: pointer;
            z-index: 1000 !important;
        }
        
        .water-pipe:hover {
            filter: brightness(1.2);
        }
        
        /* 确保地图覆盖层正确显示 */
        .leaflet-overlay-pane {
            z-index: 1000;
        }
        
        .leaflet-overlay-pane svg {
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <!-- 版本标识 -->
    <div class="version-badge">
        <i class="fas fa-rocket"></i> v3.0 模块化架构
    </div>

    <!-- 增强的加载界面 -->
    <div id="loadingIndicator" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; font-family: 'Microsoft YaHei', sans-serif;">
        <div class="loading-spinner"></div>
        <h3 id="loadingTitle">🚀 智慧水务监测系统</h3>
        <div class="loading-status-text" id="loadingStatus">正在初始化模块化架构...</div>
        
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
        
        <div class="module-info">
            <div>模块化 • 高性能 • 易维护</div>
            <div style="margin-top: 5px;">
                <i class="fas fa-cube"></i> 核心模块 
                <i class="fas fa-paint-brush"></i> 可视化 
                <i class="fas fa-sliders-h"></i> 控制器 
                <i class="fas fa-chart-bar"></i> 面板
            </div>
        </div>
    </div>

    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-left">
                <div class="logo">
                    <i class="fas fa-water"></i>
                    <span>智慧水务监测系统</span>
                </div>
                <div class="nav-links">
                    <!-- 动态菜单将由NavigationManager生成 -->
                </div>
            </div>
            <div class="navbar-right">
                <div class="user-info">
                    <!-- 用户信息将由NavigationManager生成 -->
                </div>
                <div class="current-time-container">
                    <i class="fas fa-clock"></i>
                    <span class="current-time"></span>
                </div>
                <button class="btn btn-sm btn-danger" onclick="window.location.href='login.html'">
                    <i class="fas fa-sign-out-alt"></i> 退出
                </button>
            </div>
        </div>
    </nav>

    <!-- 主体内容 -->
    <div class="main-container">
        <!-- 左侧面板 -->
        <aside class="left-panel" id="leftPanel">
            <div class="panel-content-wrapper">
                <div class="panel-content-inner" id="left-panel-content">
                    <!-- 由 LayerControl 模块动态生成 -->
                </div>
            </div>
            <button class="panel-toggle" onclick="togglePanel('leftPanel')">
                <i class="fas fa-chevron-left"></i>
            </button>
        </aside>

        <!-- 地图容器 -->
        <main class="map-container">
            <div id="map"></div>
            
            <!-- 地图工具栏 -->
            <div class="map-toolbar"></div>
            
            <!-- 图例 -->
            <div id="map-legend" class="leaflet-control"></div>
            
            <!-- 播放控件由 SimPlayback 模块动态生成 -->
        </main>

        <!-- 右侧面板 -->
        <aside class="right-panel collapsed" id="rightPanel">
            <button class="panel-toggle right-panel-toggle" onclick="togglePanel('rightPanel')">
                <i class="fas fa-chevron-right"></i>
            </button>
            <div class="panel-content-wrapper" id="right-panel-wrapper" style="display: none;">
                <div class="panel-tabs">
                    <button class="panel-tab active" onclick="RightPanel.switchTab(event, 'properties')">属性</button>
                    <button class="panel-tab" onclick="RightPanel.switchTab(event, 'analysis')">分析</button>
                    <button class="panel-tab" onclick="RightPanel.switchTab(event, 'upload')">模型</button>
                </div>
                <div class="panel-content">
                    <div id="propertiesPanel" class="tab-content active">
                        <div id="noSelection" style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                            <i class="fas fa-mouse-pointer" style="font-size: 32px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>点击地图上的设施查看详细信息</p>
                        </div>
                        <div id="selectedFacility" style="display: none;"></div>
                    </div>
                    <div id="analysisPanel" class="tab-content"></div>
                    <div id="uploadPanel" class="tab-content"></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- 第三方库脚本 -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylinedecorator.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@2.3.0/dist/leaflet-measure.min.js"></script>
    
    <!-- 基础组件（保持兼容） -->
    <script src="common.js"></script>
    
    <!-- 🧱 模块化架构 - 核心模块 -->
    <script src="modules/core/app.js"></script>
    <!-- 其他模块将由 App.js 动态加载 -->

    <script>
        // 🚀 启动应用
        console.log('🚀 启动智慧水务监测系统 v3.0');
        
        // 进度更新函数
        function updateProgress(progress, message) {
            const progressBar = document.getElementById('loadingProgressBar');
            const statusEl = document.getElementById('loadingStatus');
            
            if (progressBar) progressBar.style.width = progress + '%';
            if (statusEl) statusEl.textContent = message;
        }

        // 模拟启动进度
        const startupSteps = [
            { progress: 10, message: '初始化事件总线...' },
            { progress: 20, message: '加载配置文件...' },
            { progress: 30, message: '初始化地图管理器...' },
            { progress: 40, message: '加载数据解析器...' },
            { progress: 50, message: '初始化可视化模块...' },
            { progress: 60, message: '加载控制模块...' },
            { progress: 70, message: '初始化面板模块...' },
            { progress: 80, message: '加载水力模型数据...' },
            { progress: 90, message: '渲染地图界面...' },
            { progress: 100, message: '系统就绪！' }
        ];

        let currentStep = 0;
        
        function simulateProgress() {
            if (currentStep < startupSteps.length) {
                const step = startupSteps[currentStep];
                updateProgress(step.progress, step.message);
                currentStep++;
                setTimeout(simulateProgress, 300);
            }
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', () => {
            // 开始进度模拟
            simulateProgress();
            
            // 启动系统（防重复）
            if (systemStarted || systemStarting) {
                console.log('⚠️ 系统已启动或正在启动中，跳过重复启动');
                return;
            }
            
            systemStarting = true;
            console.log('🚀 开始启动智慧水务监测系统...');
            
            // 简化启动：直接使用基础模式，避免复杂的竞争条件
            setTimeout(() => {
                if (systemStarted) {
                    console.log('✅ 系统已启动，跳过');
                    return;
                }
                
                console.log('🔄 启动基础兼容模式...');
                startFallbackMode();
            }, 500);
            
            // 初始化左侧面板内容
            initLeftPanel();
        });

        // 全局启动状态管理
        let systemStarted = false;
        let systemStarting = false;
        let mapInitialized = false;
        let mapInitializing = false;

        // 基础模式启动（兼容性）
        function startFallbackMode() {
            if (systemStarted) {
                console.log('系统已启动，跳过基础模式启动');
                return;
            }
            
            console.log('🔄 启动基础兼容模式...');
            systemStarting = true;
            updateProgress(90, '初始化基础地图...');
            
            try {
                // 初始化基础导航系统
                if (typeof NavigationManager !== 'undefined') {
                    NavigationManager.init();
                }
                
                // 初始化时间显示
                if (typeof Clock !== 'undefined') {
                    Clock.init();
                } else {
                    // 手动更新时间
                    setInterval(() => {
                        const timeEl = document.querySelector('.current-time');
                        if (timeEl) {
                            timeEl.textContent = new Date().toLocaleString('zh-CN');
                        }
                    }, 1000);
                }
                
                // 初始化基础地图（防重复）
                if (typeof L !== 'undefined' && !mapInitialized && !mapInitializing) {
                    initializeMap();
                } else if (mapInitialized) {
                    console.log('地图已经初始化，跳过重复初始化');
                    updateProgress(100, '系统已就绪！');
                    hideLoadingIndicator();
                } else {
                    console.log('Leaflet未加载或地图正在初始化中');
                    updateProgress(100, '等待资源加载完成...');
                    hideLoadingIndicator();
                }
                
                // 标记系统启动完成
                systemStarted = true;
                systemStarting = false;
                console.log('✅ 基础模式启动完成');
                
            } catch (error) {
                console.error('❌ 基础模式启动失败:', error);
                systemStarting = false;
                updateProgress(100, '启动遇到问题，但页面可用');
                hideLoadingIndicator();
            }
        }

        // 隐藏加载指示器
        function hideLoadingIndicator() {
            setTimeout(() => {
                const loadingEl = document.getElementById('loadingIndicator');
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
            }, 1000);
        }

        // 地图初始化函数
        function initializeMap() {
            if (mapInitialized || mapInitializing) {
                console.log('地图已初始化或正在初始化中，跳过');
                return;
            }
            
            mapInitializing = true;
            console.log('开始初始化地图...');
            
            try {
                // 确保地图容器存在且有尺寸
                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    // 清空容器内容防止冲突
                    mapContainer.innerHTML = '';
                    
                    // 强制设置容器尺寸
                    mapContainer.style.width = '100%';
                    mapContainer.style.height = '100%';
                    
                    try {
                        const map = L.map(mapContainer, {
                                center: [22.261, 114.246],
                                zoom: 16,
                                zoomControl: true,
                                attributionControl: false,
                                preferCanvas: true // 提高性能
                            });
                            
                            // 多个地图底图备用方案
                            const tileLayers = [
                                {
                                    name: 'CARTO Light',
                                    url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                                    options: { attribution: '© CARTO', maxZoom: 19, subdomains: 'abcd' }
                                },
                                {
                                    name: 'OpenStreetMap',
                                    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                                    options: { attribution: '© OpenStreetMap', maxZoom: 19, subdomains: 'abc' }
                                },
                                {
                                    name: 'CARTO Positron',
                                    url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
                                    options: { attribution: '© CARTO', maxZoom: 19, subdomains: 'abcd' }
                                }
                            ];
                            
                            let tileLayerLoaded = false;
                            let currentTileIndex = 0;
                            
                            function loadTileLayer() {
                                if (currentTileIndex >= tileLayers.length) {
                                    console.error('所有地图服务都加载失败，使用本地地图');
                                    showLocalMap(map);
                                    return;
                                }
                                
                                const tileData = tileLayers[currentTileIndex];
                                console.log(`尝试加载地图服务: ${tileData.name}`);
                                
                                const tileLayer = L.tileLayer(tileData.url, {
                                    ...tileData.options,
                                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==', // 1x1 透明像素
                                    timeout: 10000
                                });
                                
                                // 监听瓦片加载事件
                                let tilesLoaded = 0;
                                let tilesTotal = 0;
                                let loadTimeout;
                                
                                tileLayer.on('loading', () => {
                                    tilesLoaded = 0;
                                    tilesTotal = 0;
                                    clearTimeout(loadTimeout);
                                    loadTimeout = setTimeout(() => {
                                        if (!tileLayerLoaded) {
                                            console.warn(`地图服务 ${tileData.name} 加载超时`);
                                            map.removeLayer(tileLayer);
                                            currentTileIndex++;
                                            loadTileLayer();
                                        }
                                    }, 8000);
                                });
                                
                                tileLayer.on('tileload', () => {
                                    tilesLoaded++;
                                    if (tilesLoaded >= 1 && !tileLayerLoaded) {
                                        tileLayerLoaded = true;
                                        clearTimeout(loadTimeout);
                                        console.log(`地图服务 ${tileData.name} 加载成功`);
                                    }
                                });
                                
                                tileLayer.on('tileerror', () => {
                                    if (!tileLayerLoaded) {
                                        console.warn(`地图服务 ${tileData.name} 瓦片加载错误`);
                                        setTimeout(() => {
                                            if (!tileLayerLoaded) {
                                                map.removeLayer(tileLayer);
                                                currentTileIndex++;
                                                loadTileLayer();
                                            }
                                        }, 2000);
                                    }
                                });
                                
                                tileLayer.addTo(map);
                            }
                            
                            // 开始加载地图底图
                            loadTileLayer();
                            
                            // 存储地图实例到全局变量
                            window.mapInstance = map;
                            
                            // 添加水力设施数据
                            addWaterFacilities(map);
                            
                            // 添加地图控件
                            L.control.scale({
                                position: 'bottomright',
                                imperial: false
                            }).addTo(map);
                            
                            console.log('基础地图已加载完成');
                            
                            // 延迟刷新地图尺寸
                            setTimeout(() => {
                                map.invalidateSize();
                            }, 100);
                            
                        } catch (mapError) {
                            console.error('地图初始化失败:', mapError);
                            mapInitializing = false;
                            showMapError(mapContainer, mapError.message);
                            return;
                        }
                    } else {
                        console.error('地图容器不存在');
                        mapInitializing = false;
                        return;
                    }
                    
                    // 标记地图初始化完成
                    mapInitialized = true;
                    mapInitializing = false;
                    
                    // 初始化主题管理器
                    if (typeof ThemeManager !== 'undefined') {
                        ThemeManager.init();
                    }
                    
                    updateProgress(100, '地图初始化完成！');
                    
                    // 隐藏加载界面
                    setTimeout(() => {
                        const loadingEl = document.getElementById('loadingIndicator');
                        if (loadingEl) {
                            loadingEl.style.display = 'none';
                        }
                        console.log('地图已成功初始化');
                    }, 1000);
                    
            } catch (error) {
                console.error('地图初始化过程失败:', error);
                mapInitializing = false;
                updateProgress(100, '初始化失败：' + error.message);
                
                // 隐藏加载界面
                setTimeout(() => {
                    const loadingEl = document.getElementById('loadingIndicator');
                    if (loadingEl) {
                        loadingEl.style.display = 'none';
                    }
                }, 1000);
            }
        }

        // 面板切换功能（兼容性）
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const icon = panel.querySelector('.panel-toggle i');
            const isLeft = panelId === 'leftPanel';
            
            panel.classList.toggle('collapsed');
            const isCollapsed = panel.classList.contains('collapsed');

            if (isLeft) {
                icon.className = `fas ${isCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'}`;
            } else {
                icon.className = `fas ${isCollapsed ? 'fa-chevron-left' : 'fa-chevron-right'}`;
                document.getElementById('right-panel-wrapper').style.display = isCollapsed ? 'none' : 'flex';
            }
        }

        // 更新设施面板（兼容性）
        function updateFacilityPanel(facility) {
            const propertiesPanel = document.getElementById('propertiesPanel');
            const noSelection = document.getElementById('noSelection');
            const selectedFacility = document.getElementById('selectedFacility');
            
            if (propertiesPanel && noSelection && selectedFacility) {
                // 隐藏无选择提示，显示设施信息
                noSelection.style.display = 'none';
                selectedFacility.style.display = 'block';
                
                // 确保右侧面板展开
                const rightPanel = document.getElementById('rightPanel');
                if (rightPanel && rightPanel.classList.contains('collapsed')) {
                    togglePanel('rightPanel');
                }
                
                // 生成设施详细信息
                let facilityHtml = `
                    <div class="facility-header">
                        <h3 style="color: var(--primary); margin-bottom: 10px;">
                            ${getFacilityIcon(facility.type)} ${facility.name}
                        </h3>
                        <span class="badge badge-primary">${facility.type}</span>
                    </div>
                    
                    <div class="facility-details" style="margin-top: 20px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 10px;">实时数据</h4>
                `;
                
                if (facility.pressure) {
                    facilityHtml += `
                        <div class="detail-item">
                            <span class="detail-label">压力:</span>
                            <span class="detail-value">${facility.pressure} bar</span>
                        </div>
                    `;
                }
                
                if (facility.flow) {
                    facilityHtml += `
                        <div class="detail-item">
                            <span class="detail-label">流量:</span>
                            <span class="detail-value">${facility.flow} m³/h</span>
                        </div>
                    `;
                }
                
                if (facility.status) {
                    facilityHtml += `
                        <div class="detail-item">
                            <span class="detail-label">状态:</span>
                            <span class="detail-value status-${facility.status === '运行中' ? 'running' : 'normal'}">${facility.status}</span>
                        </div>
                    `;
                }
                
                if (facility.level) {
                    facilityHtml += `
                        <div class="detail-item">
                            <span class="detail-label">水位:</span>
                            <span class="detail-value">${facility.level}% 
                                <div class="progress" style="width: 100px; display: inline-block; margin-left: 10px;">
                                    <div class="progress-bar" style="width: ${facility.level}%;"></div>
                                </div>
                            </span>
                        </div>
                    `;
                }
                
                if (facility.power) {
                    facilityHtml += `
                        <div class="detail-item">
                            <span class="detail-label">功率:</span>
                            <span class="detail-value">${facility.power}%
                                <div class="progress" style="width: 100px; display: inline-block; margin-left: 10px;">
                                    <div class="progress-bar" style="width: ${facility.power}%;"></div>
                                </div>
                            </span>
                        </div>
                    `;
                }
                
                facilityHtml += `
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 10px;">操作</h4>
                        <div class="btn-group" style="flex-direction: column; gap: 8px;">
                            <button class="btn btn-sm btn-primary" onclick="viewFacilityHistory('${facility.name}')">
                                <i class="fas fa-chart-line"></i> 历史数据
                            </button>
                            <button class="btn btn-sm" onclick="configureFacility('${facility.name}')">
                                <i class="fas fa-cog"></i> 配置参数
                            </button>
                            <button class="btn btn-sm" onclick="exportFacilityData('${facility.name}')">
                                <i class="fas fa-download"></i> 导出数据
                            </button>
                        </div>
                    </div>
                `;
                
                selectedFacility.innerHTML = facilityHtml;
            }
        }

        // 获取设施图标
        function getFacilityIcon(type) {
            switch(type) {
                case 'pump': return '⚡';
                case 'reservoir': return '🏊';
                case 'valve': return '🔧';
                default: return '📍';
            }
        }

        // 设施操作函数（占位符）
        function viewFacilityHistory(name) {
            alert('查看 ' + name + ' 的历史数据功能待开发');
        }

        function configureFacility(name) {
            alert('配置 ' + name + ' 的参数功能待开发');
        }

        function exportFacilityData(name) {
            alert('导出 ' + name + ' 的数据功能待开发');
        }

        // 本地地图备用方案
        function showLocalMap(map) {
            console.log('启用本地地图模式');
            
            // 创建本地网格背景
            const bounds = [[22.25, 114.22], [22.28, 114.27]];
            
            // 添加网格背景
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            // 绘制网格
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 80; i++) {
                ctx.beginPath();
                ctx.moveTo(i * 10, 0);
                ctx.lineTo(i * 10, 600);
                ctx.stroke();
            }
            
            for (let i = 0; i <= 60; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * 10);
                ctx.lineTo(800, i * 10);
                ctx.stroke();
            }
            
            // 添加水印
            ctx.fillStyle = '#f0f0f0';
            ctx.font = '16px Microsoft YaHei';
            ctx.fillText('离线地图模式', 350, 300);
            
            const dataUrl = canvas.toDataURL();
            
            // 创建本地图层
            const localLayer = L.imageOverlay(dataUrl, bounds, {
                opacity: 0.5
            }).addTo(map);
            
            // 添加说明
            const infoControl = L.control({ position: 'topleft' });
            infoControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'info-control');
                div.innerHTML = `
                    <div style="background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                        <h4 style="margin: 0 0 5px 0; color: #ff6b35;">🔄 离线模式</h4>
                        <p style="margin: 0; font-size: 12px;">网络地图服务不可用<br/>正在使用本地地图</p>
                        <button onclick="retryMapLoad()" style="margin-top: 5px; padding: 3px 8px; font-size: 10px;" class="btn btn-sm btn-primary">
                            重试联网
                        </button>
                    </div>
                `;
                return div;
            };
            infoControl.addTo(map);
        }

        // 显示地图错误
        function showMapError(container, errorMessage) {
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; 
                            color: #666; flex-direction: column; font-family: Microsoft YaHei; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #ff6b35;"></i>
                    <h3 style="color: #333; margin-bottom: 10px;">地图初始化失败</h3>
                    <p style="margin-bottom: 20px; color: #666;">错误信息: ${errorMessage}</p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="retryMapLoad()" class="btn btn-primary">
                            <i class="fas fa-redo"></i> 重新加载
                        </button>
                        <button onclick="useOfflineMode()" class="btn">
                            <i class="fas fa-map"></i> 离线模式
                        </button>
                    </div>
                    <div style="margin-top: 20px; font-size: 12px; color: #999;">
                        <p>💡 故障排除建议:</p>
                        <ul style="text-align: left; max-width: 300px;">
                            <li>检查网络连接</li>
                            <li>刷新页面重试</li>
                            <li>清除浏览器缓存</li>
                            <li>使用离线模式继续</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // 重新加载地图
        function retryMapLoad() {
            console.log('🔄 用户手动重试地图加载');
            
            // 重置启动状态
            systemStarted = false;
            systemStarting = false;
            mapInitialized = false;
            mapInitializing = false;
            
            // 清除现有地图实例
            if (window.mapInstance) {
                try {
                    window.mapInstance.remove();
                } catch (e) {
                    console.log('清除地图实例时出错:', e);
                }
                window.mapInstance = null;
            }
            
            // 清空地图容器
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = '';
            }
            
            // 重新启动系统
            setTimeout(() => {
                location.reload();
            }, 100);
        }

        // 使用离线模式
        function useOfflineMode() {
            console.log('🔄 切换到离线模式');
            
            if (systemStarted) {
                console.log('系统已启动，跳过离线模式初始化');
                return;
            }
            
            // 重置状态
            systemStarting = true;
            mapInitialized = false;
            mapInitializing = false;
            
            const mapContainer = document.getElementById('map');
            if (mapContainer && typeof L !== 'undefined') {
                // 清空并重新创建地图容器
                mapContainer.innerHTML = '';
                
                try {
                    const map = L.map(mapContainer, {
                        center: [22.261, 114.246],
                        zoom: 16,
                        zoomControl: true,
                        attributionControl: false
                    });
                    
                    showLocalMap(map);
                    addWaterFacilities(map);
                    window.mapInstance = map;
                    mapInitialized = true;
                    systemStarted = true;
                    systemStarting = false;
                    
                    console.log('✅ 离线模式地图已创建');
                } catch (error) {
                    console.error('❌ 离线模式地图创建失败:', error);
                    systemStarting = false;
                    mapContainer.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; 
                                    color: #666; flex-direction: column; font-family: Microsoft YaHei;">
                            <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 20px; color: #ff6b35;"></i>
                            <h3>离线模式启动失败</h3>
                            <p>请刷新页面重试</p>
                        </div>
                    `;
                }
            }
        }

        // 初始化左侧面板
        function initLeftPanel() {
            const leftPanelContent = document.getElementById('left-panel-content');
            if (leftPanelContent) {
                leftPanelContent.innerHTML = `
                    <div class="layer-control">
                        <div class="layer-group">
                            <h3 onclick="toggleLayerGroup(this)">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>节点主题</span>
                                <i class="fas fa-chevron-down layer-toggle"></i>
                            </h3>
                            <div class="layer-items">
                                <div class="layer-item active" data-layer="pressure">
                                    <input type="checkbox" checked onchange="toggleLayer('pressure', this)">
                                    <div class="layer-icon" style="background: #3498db; border-radius: 50%; width: 12px; height: 12px;"></div>
                                    <span class="layer-name">压力分层</span>
                                </div>
                                <div class="layer-item" data-layer="flow">
                                    <input type="checkbox" onchange="toggleLayer('flow', this)">
                                    <div class="layer-icon" style="background: #2ecc71; border-radius: 50%; width: 12px; height: 12px;"></div>
                                    <span class="layer-name">流量分层</span>
                                </div>
                                <div class="layer-item" data-layer="quality">
                                    <input type="checkbox" onchange="toggleLayer('quality', this)">
                                    <div class="layer-icon" style="background: #f39c12; border-radius: 50%; width: 12px; height: 12px;"></div>
                                    <span class="layer-name">水质分层</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="layer-group">
                            <h3 onclick="toggleLayerGroup(this)">
                                <i class="fas fa-layer-group"></i>
                                <span>设备图层</span>
                                <i class="fas fa-chevron-down layer-toggle"></i>
                            </h3>
                            <div class="layer-items">
                                <div class="layer-item active" data-layer="pumps">
                                    <input type="checkbox" checked onchange="toggleLayer('pumps', this)">
                                    <div class="layer-icon" style="color: #9b59b6;">⚡</div>
                                    <span class="layer-name">泵站</span>
                                </div>
                                <div class="layer-item active" data-layer="reservoirs">
                                    <input type="checkbox" checked onchange="toggleLayer('reservoirs', this)">
                                    <div class="layer-icon" style="color: #2ecc71;">🏊</div>
                                    <span class="layer-name">蓄水池</span>
                                </div>
                                <div class="layer-item active" data-layer="valves">
                                    <input type="checkbox" checked onchange="toggleLayer('valves', this)">
                                    <div class="layer-icon" style="color: #f39c12;">🔧</div>
                                    <span class="layer-name">水阀</span>
                                </div>
                                <div class="layer-item active" data-layer="junctions">
                                    <input type="checkbox" checked onchange="toggleLayer('junctions', this)">
                                    <div class="layer-icon" style="color: #3498db;">📍</div>
                                    <span class="layer-name">节点</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="layer-group">
                            <h3 onclick="toggleLayerGroup(this)">
                                <i class="fas fa-project-diagram"></i>
                                <span>管道图层</span>
                                <i class="fas fa-chevron-down layer-toggle"></i>
                            </h3>
                            <div class="layer-items">
                                <div class="layer-item active" data-layer="pipes">
                                    <input type="checkbox" checked onchange="toggleLayer('pipes', this)">
                                    <div class="layer-icon" style="border: 2px solid #4A90B8; width: 12px; height: 2px; border-radius: 1px;"></div>
                                    <span class="layer-name">全部管道</span>
                                </div>
                                <div class="layer-item" data-layer="main-pipes">
                                    <input type="checkbox" onchange="toggleLayer('main-pipes', this)">
                                    <div class="layer-icon" style="border: 3px solid #e74c3c; width: 12px; height: 2px; border-radius: 1px;"></div>
                                    <span class="layer-name">主管道</span>
                                </div>
                                <div class="layer-item" data-layer="service-pipes">
                                    <input type="checkbox" onchange="toggleLayer('service-pipes', this)">
                                    <div class="layer-icon" style="border: 1px solid #95a5a6; width: 12px; height: 2px; border-radius: 1px;"></div>
                                    <span class="layer-name">服务管道</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="layer-group">
                            <h3 onclick="toggleLayerGroup(this)">
                                <i class="fas fa-cog"></i>
                                <span>监测点</span>
                                <i class="fas fa-chevron-down layer-toggle"></i>
                            </h3>
                            <div class="layer-items">
                                <div class="layer-item active" data-layer="monitoring">
                                    <input type="checkbox" checked onchange="toggleLayer('monitoring', this)">
                                    <div class="layer-icon" style="color: #17a2b8;">📊</div>
                                    <span class="layer-name">监测点</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // 切换图层组展开/收起
        function toggleLayerGroup(element) {
            const layerGroup = element.parentElement;
            layerGroup.classList.toggle('collapsed');
        }

        // 切换图层显示/隐藏
        function toggleLayer(layerName, checkbox) {
            const isChecked = checkbox.checked;
            console.log(`图层 ${layerName} ${isChecked ? '启用' : '禁用'}`);
            
            // 这里可以添加实际的图层控制逻辑
            if (window.mapInstance) {
                // 实际的图层控制会在这里实现
                console.log('地图实例存在，可以进行图层操作');
            }
            
            // 更新图层项的视觉状态
            const layerItem = checkbox.closest('.layer-item');
            if (isChecked) {
                layerItem.classList.add('active');
            } else {
                layerItem.classList.remove('active');
            }
        }

        // 添加水力设施到地图（通用函数）
        function addWaterFacilities(map) {
            // 防止重复添加设施
            if (map._facilitiesAdded) {
                console.log('⚠️ 设施已添加，跳过重复添加');
                return;
            }
            
            console.log('🏗️ 开始添加水力设施到地图...');
            
            const facilities = [
                { lat: 22.261, lng: 114.246, name: '中央监测站', type: 'junction', pressure: 45.2, flow: 128.5 },
                { lat: 22.265, lng: 114.250, name: '高压泵站A', type: 'pump', status: '运行中', power: 85 },
                { lat: 22.258, lng: 114.242, name: '主水库B', type: 'reservoir', level: 78.5, capacity: 5000 },
                { lat: 22.263, lng: 114.248, name: '分配节点C', type: 'junction', pressure: 42.1, flow: 95.2 },
                { lat: 22.259, lng: 114.244, name: '调节阀D', type: 'valve', status: '开启', position: 75 }
            ];
            
            facilities.forEach(facility => {
                let color, icon;
                switch(facility.type) {
                    case 'pump':
                        color = '#9b59b6';
                        icon = '⚡';
                        break;
                    case 'reservoir':
                        color = '#2ecc71';
                        icon = '🏊';
                        break;
                    case 'valve':
                        color = '#f39c12';
                        icon = '🔧';
                        break;
                    default:
                        color = '#3498db';
                        icon = '📍';
                }
                
                const marker = L.circleMarker([facility.lat, facility.lng], {
                    radius: 10,
                    fillColor: color,
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                // 创建详细信息弹窗
                let popupContent = `<div style="font-family: Microsoft YaHei; min-width: 200px;">
                    <h4 style="margin: 0 0 10px 0; color: ${color};">${icon} ${facility.name}</h4>
                    <p style="margin: 5px 0; color: #666;"><strong>类型:</strong> ${facility.type}</p>`;
                
                if (facility.pressure) popupContent += `<p style="margin: 5px 0; color: #666;"><strong>压力:</strong> ${facility.pressure} bar</p>`;
                if (facility.flow) popupContent += `<p style="margin: 5px 0; color: #666;"><strong>流量:</strong> ${facility.flow} m³/h</p>`;
                if (facility.status) popupContent += `<p style="margin: 5px 0; color: #666;"><strong>状态:</strong> ${facility.status}</p>`;
                if (facility.level) popupContent += `<p style="margin: 5px 0; color: #666;"><strong>水位:</strong> ${facility.level}%</p>`;
                if (facility.power) popupContent += `<p style="margin: 5px 0; color: #666;"><strong>功率:</strong> ${facility.power}%</p>`;
                
                popupContent += `</div>`;
                
                marker.bindPopup(popupContent);
                
                // 点击时更新右侧面板
                marker.on('click', () => {
                    updateFacilityPanel(facility);
                });
            });
            
            // 添加管道连接线
            const pipes = [
                [[22.261, 114.246], [22.265, 114.250]],
                [[22.261, 114.246], [22.258, 114.242]],
                [[22.261, 114.246], [22.263, 114.248]],
                [[22.263, 114.248], [22.259, 114.244]]
            ];
            
            console.log('🔗 开始绘制管道连接线...');
            
            pipes.forEach((pipe, index) => {
                const polyline = L.polyline(pipe, {
                    color: '#4A90B8',
                    weight: 6,
                    opacity: 1,
                    dashArray: '10, 5',
                    className: 'water-pipe',
                    interactive: true,
                    pane: 'overlayPane' // 确保在瓦片层上方
                }).addTo(map);
                
                // 添加管道信息弹窗
                polyline.bindPopup(`
                    <div style="font-family: Microsoft YaHei; min-width: 180px;">
                        <h4 style="margin: 0 0 10px 0; color: #4A90B8;">🔗 供水管道 ${index + 1}</h4>
                        <p style="margin: 5px 0; color: #666;"><strong>管径:</strong> DN300</p>
                        <p style="margin: 5px 0; color: #666;"><strong>材质:</strong> 球墨铸铁</p>
                        <p style="margin: 5px 0; color: #666;"><strong>流速:</strong> 2.5 m/s</p>
                        <p style="margin: 5px 0; color: #666;"><strong>压力:</strong> 0.45 MPa</p>
                    </div>
                `);
                
                console.log(`✅ 管道 ${index + 1} 已绘制完成`);
            });
            
            console.log(`✅ 总共绘制了 ${pipes.length} 条管道连接线`);
            
            // 标记设施已添加，防止重复
            map._facilitiesAdded = true;
            console.log('✅ 水力设施和管道添加完成');
        }

        // 全局错误处理
        window.addEventListener('error', (event) => {
            console.error('页面错误:', event.error);
            updateProgress(0, '加载出错：' + event.error.message);
        });

        // 右侧面板切换兼容性
        window.RightPanel = {
            switchTab: function(event, tabName) {
                // 切换标签页
                const tabs = document.querySelectorAll('.panel-tab');
                const contents = document.querySelectorAll('.tab-content');
                
                tabs.forEach(tab => tab.classList.remove('active'));
                contents.forEach(content => content.classList.remove('active'));
                
                event.target.classList.add('active');
                document.getElementById(tabName + 'Panel').classList.add('active');
            }
        };

        // 监听模块化应用状态
        window.addEventListener('load', () => {
            // 检查是否有遗留的全局函数需要兼容
            if (typeof switchMapTheme === 'undefined') {
                window.switchMapTheme = function(theme) {
                    if (App && App.getModule && App.getModule('LayerControl')) {
                        App.getModule('LayerControl').switchTheme(theme);
                    }
                };
            }
        });

        // 开发者工具和系统状态监控
        window.WaterSystemDebug = {
            getApp: () => window.App,
            getModules: () => window.App ? window.App.modules : null,
            getEventBus: () => window.EventBus,
            triggerEvent: (event, data) => window.EventBus && window.EventBus.emit(event, data),
            getSystemStatus: () => ({
                systemStarted,
                systemStarting,
                mapInitialized,
                mapInitializing,
                mapInstance: !!window.mapInstance
            }),
            resetSystem: () => {
                console.log('🔧 手动重置系统状态');
                systemStarted = false;
                systemStarting = false;
                mapInitialized = false;
                mapInitializing = false;
                if (window.mapInstance) {
                    try {
                        window.mapInstance.remove();
                    } catch (e) {}
                    window.mapInstance = null;
                }
            },
            checkPipes: () => {
                if (window.mapInstance) {
                    let pipeCount = 0;
                    let facilityCount = 0;
                    
                    window.mapInstance.eachLayer((layer) => {
                        if (layer instanceof L.Polyline) {
                            pipeCount++;
                            console.log('🔗 发现管道:', layer);
                        }
                        if (layer instanceof L.CircleMarker) {
                            facilityCount++;
                            console.log('🏭 发现设施:', layer);
                        }
                    });
                    
                    console.log(`📊 地图统计: ${facilityCount} 个设施, ${pipeCount} 条管道`);
                    return { facilities: facilityCount, pipes: pipeCount };
                } else {
                    console.log('❌ 地图实例不存在');
                    return null;
                }
            },
            addTestPipe: () => {
                if (window.mapInstance) {
                    const testPipe = L.polyline([[22.26, 114.24], [22.27, 114.25]], {
                        color: 'red',
                        weight: 8,
                        opacity: 1
                    }).addTo(window.mapInstance);
                    testPipe.bindPopup('测试管道');
                    console.log('✅ 已添加测试管道');
                    return testPipe;
                }
            }
        };
        
        if (location.search.includes('debug=true')) {
            console.log('🔧 调试模式已启用，使用 WaterSystemDebug 访问系统');
        }
        
        // 定期状态检查（调试用）
        setInterval(() => {
            if (location.search.includes('debug=true')) {
                console.log('📊 系统状态:', WaterSystemDebug.getSystemStatus());
            }
        }, 10000);
    </script>

    <!-- 悬浮主题切换按钮 -->
    <button class="theme-toggle-float" onclick="ThemeManager.toggle()" title="切换主题">
        <i class="fas fa-moon"></i>
    </button>
</body>
</html> 