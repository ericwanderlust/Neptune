<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æ°´åŠ¡ç›‘æµ‹ç³»ç»Ÿ v3.0 - æ¨¡å—åŒ–ç‰ˆæœ¬</title>
    
    <!-- ç¬¬ä¸‰æ–¹åº“ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@2.3.0/dist/leaflet-measure.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <link rel="stylesheet" href="common_styles.css">
    
    <!-- æŠ•å½±åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.0/dist/proj4.js"></script>
    
    <style>
        /* æ¨¡å—åŒ–ç‰ˆæœ¬ç‰¹å®šæ ·å¼ */
        .version-badge {
            position: fixed;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: fadeInDown 0.6s ease-out;
        }
        
        .loading-progress {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4A90B8, #74b9ff);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }
        
        .loading-status-text {
            text-align: center;
            margin-top: 10px;
            color: var(--text-dark);
            font-size: 14px;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate3d(0, -20px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }
        
        /* å¢å¼ºçš„åŠ è½½ç•Œé¢ */
        #loadingIndicator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        #loadingIndicator h3 {
            color: white;
        }
        
        .loading-spinner {
            position: relative;
            width: 60px;
            height: 60px;
            margin: 0 auto 30px;
        }
        
        .loading-spinner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .module-info {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* ç®¡é“æ ·å¼ */
        .water-pipe {
            cursor: pointer;
            z-index: 1000 !important;
        }
        
        .water-pipe:hover {
            filter: brightness(1.2);
        }
        
        /* ç¡®ä¿åœ°å›¾è¦†ç›–å±‚æ­£ç¡®æ˜¾ç¤º */
        .leaflet-overlay-pane {
            z-index: 1000;
        }
        
        .leaflet-overlay-pane svg {
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <!-- ç‰ˆæœ¬æ ‡è¯† -->
    <div class="version-badge">
        <i class="fas fa-rocket"></i> v3.0 æ¨¡å—åŒ–æ¶æ„
    </div>

    <!-- å¢å¼ºçš„åŠ è½½ç•Œé¢ -->
    <div id="loadingIndicator" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; font-family: 'Microsoft YaHei', sans-serif;">
        <div class="loading-spinner"></div>
        <h3 id="loadingTitle">ğŸš€ æ™ºæ…§æ°´åŠ¡ç›‘æµ‹ç³»ç»Ÿ</h3>
        <div class="loading-status-text" id="loadingStatus">æ­£åœ¨åˆå§‹åŒ–æ¨¡å—åŒ–æ¶æ„...</div>
        
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
        
        <div class="module-info">
            <div>æ¨¡å—åŒ– â€¢ é«˜æ€§èƒ½ â€¢ æ˜“ç»´æŠ¤</div>
            <div style="margin-top: 5px;">
                <i class="fas fa-cube"></i> æ ¸å¿ƒæ¨¡å— 
                <i class="fas fa-paint-brush"></i> å¯è§†åŒ– 
                <i class="fas fa-sliders-h"></i> æ§åˆ¶å™¨ 
                <i class="fas fa-chart-bar"></i> é¢æ¿
            </div>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-left">
                <div class="logo">
                    <i class="fas fa-water"></i>
                    <span>æ™ºæ…§æ°´åŠ¡ç›‘æµ‹ç³»ç»Ÿ</span>
                </div>
                <div class="nav-links">
                    <!-- åŠ¨æ€èœå•å°†ç”±NavigationManagerç”Ÿæˆ -->
                </div>
            </div>
            <div class="navbar-right">
                <div class="user-info">
                    <!-- ç”¨æˆ·ä¿¡æ¯å°†ç”±NavigationManagerç”Ÿæˆ -->
                </div>
                <div class="current-time-container">
                    <i class="fas fa-clock"></i>
                    <span class="current-time"></span>
                </div>
                <button class="btn btn-sm btn-danger" onclick="window.location.href='login.html'">
                    <i class="fas fa-sign-out-alt"></i> é€€å‡º
                </button>
            </div>
        </div>
    </nav>

    <!-- ä¸»ä½“å†…å®¹ -->
    <div class="main-container">
        <!-- å·¦ä¾§é¢æ¿ -->
        <aside class="left-panel" id="leftPanel">
            <div class="panel-content-wrapper">
                <div class="panel-content-inner" id="left-panel-content">
                    <!-- ç”± LayerControl æ¨¡å—åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <button class="panel-toggle" onclick="togglePanel('leftPanel')">
                <i class="fas fa-chevron-left"></i>
            </button>
        </aside>

        <!-- åœ°å›¾å®¹å™¨ -->
        <main class="map-container">
            <div id="map"></div>
            
            <!-- åœ°å›¾å·¥å…·æ  -->
            <div class="map-toolbar"></div>
            
            <!-- å›¾ä¾‹ -->
            <div id="map-legend" class="leaflet-control"></div>
            
            <!-- æ’­æ”¾æ§ä»¶ç”± SimPlayback æ¨¡å—åŠ¨æ€ç”Ÿæˆ -->
        </main>

        <!-- å³ä¾§é¢æ¿ -->
        <aside class="right-panel collapsed" id="rightPanel">
            <button class="panel-toggle right-panel-toggle" onclick="togglePanel('rightPanel')">
                <i class="fas fa-chevron-right"></i>
            </button>
            <div class="panel-content-wrapper" id="right-panel-wrapper" style="display: none;">
                <div class="panel-tabs">
                    <button class="panel-tab active" onclick="RightPanel.switchTab(event, 'properties')">å±æ€§</button>
                    <button class="panel-tab" onclick="RightPanel.switchTab(event, 'analysis')">åˆ†æ</button>
                    <button class="panel-tab" onclick="RightPanel.switchTab(event, 'upload')">æ¨¡å‹</button>
                </div>
                <div class="panel-content">
                    <div id="propertiesPanel" class="tab-content active">
                        <div id="noSelection" style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                            <i class="fas fa-mouse-pointer" style="font-size: 32px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>ç‚¹å‡»åœ°å›¾ä¸Šçš„è®¾æ–½æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>
                        </div>
                        <div id="selectedFacility" style="display: none;"></div>
                    </div>
                    <div id="analysisPanel" class="tab-content"></div>
                    <div id="uploadPanel" class="tab-content"></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- ç¬¬ä¸‰æ–¹åº“è„šæœ¬ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylinedecorator.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@2.3.0/dist/leaflet-measure.min.js"></script>
    
    <!-- åŸºç¡€ç»„ä»¶ï¼ˆä¿æŒå…¼å®¹ï¼‰ -->
    <script src="common.js"></script>
    
    <!-- ğŸ§± æ¨¡å—åŒ–æ¶æ„ - æ ¸å¿ƒæ¨¡å— -->
    <script src="modules/core/app.js"></script>
    <!-- å…¶ä»–æ¨¡å—å°†ç”± App.js åŠ¨æ€åŠ è½½ -->

    <script>
        // ğŸš€ å¯åŠ¨åº”ç”¨
        console.log('ğŸš€ å¯åŠ¨æ™ºæ…§æ°´åŠ¡ç›‘æµ‹ç³»ç»Ÿ v3.0');
        
        // è¿›åº¦æ›´æ–°å‡½æ•°
        function updateProgress(progress, message) {
            const progressBar = document.getElementById('loadingProgressBar');
            const statusEl = document.getElementById('loadingStatus');
            
            if (progressBar) progressBar.style.width = progress + '%';
            if (statusEl) statusEl.textContent = message;
        }

        // æ¨¡æ‹Ÿå¯åŠ¨è¿›åº¦
        const startupSteps = [
            { progress: 10, message: 'åˆå§‹åŒ–äº‹ä»¶æ€»çº¿...' },
            { progress: 20, message: 'åŠ è½½é…ç½®æ–‡ä»¶...' },
            { progress: 30, message: 'åˆå§‹åŒ–åœ°å›¾ç®¡ç†å™¨...' },
            { progress: 40, message: 'åŠ è½½æ•°æ®è§£æå™¨...' },
            { progress: 50, message: 'åˆå§‹åŒ–å¯è§†åŒ–æ¨¡å—...' },
            { progress: 60, message: 'åŠ è½½æ§åˆ¶æ¨¡å—...' },
            { progress: 70, message: 'åˆå§‹åŒ–é¢æ¿æ¨¡å—...' },
            { progress: 80, message: 'åŠ è½½æ°´åŠ›æ¨¡å‹æ•°æ®...' },
            { progress: 90, message: 'æ¸²æŸ“åœ°å›¾ç•Œé¢...' },
            { progress: 100, message: 'ç³»ç»Ÿå°±ç»ªï¼' }
        ];

        let currentStep = 0;
        
        function simulateProgress() {
            if (currentStep < startupSteps.length) {
                const step = startupSteps[currentStep];
                updateProgress(step.progress, step.message);
                currentStep++;
                setTimeout(simulateProgress, 300);
            }
        }

        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            // å¼€å§‹è¿›åº¦æ¨¡æ‹Ÿ
            simulateProgress();
            
            // å¯åŠ¨ç³»ç»Ÿï¼ˆé˜²é‡å¤ï¼‰
            if (systemStarted || systemStarting) {
                console.log('âš ï¸ ç³»ç»Ÿå·²å¯åŠ¨æˆ–æ­£åœ¨å¯åŠ¨ä¸­ï¼Œè·³è¿‡é‡å¤å¯åŠ¨');
                return;
            }
            
            systemStarting = true;
            console.log('ğŸš€ å¼€å§‹å¯åŠ¨æ™ºæ…§æ°´åŠ¡ç›‘æµ‹ç³»ç»Ÿ...');
            
            // ç®€åŒ–å¯åŠ¨ï¼šç›´æ¥ä½¿ç”¨åŸºç¡€æ¨¡å¼ï¼Œé¿å…å¤æ‚çš„ç«äº‰æ¡ä»¶
            setTimeout(() => {
                if (systemStarted) {
                    console.log('âœ… ç³»ç»Ÿå·²å¯åŠ¨ï¼Œè·³è¿‡');
                    return;
                }
                
                console.log('ğŸ”„ å¯åŠ¨åŸºç¡€å…¼å®¹æ¨¡å¼...');
                startFallbackMode();
            }, 500);
            
            // åˆå§‹åŒ–å·¦ä¾§é¢æ¿å†…å®¹
            initLeftPanel();
        });

        // å…¨å±€å¯åŠ¨çŠ¶æ€ç®¡ç†
        let systemStarted = false;
        let systemStarting = false;
        let mapInitialized = false;
        let mapInitializing = false;

        // åŸºç¡€æ¨¡å¼å¯åŠ¨ï¼ˆå…¼å®¹æ€§ï¼‰
        function startFallbackMode() {
            if (systemStarted) {
                console.log('ç³»ç»Ÿå·²å¯åŠ¨ï¼Œè·³è¿‡åŸºç¡€æ¨¡å¼å¯åŠ¨');
                return;
            }
            
            console.log('ğŸ”„ å¯åŠ¨åŸºç¡€å…¼å®¹æ¨¡å¼...');
            systemStarting = true;
            updateProgress(90, 'åˆå§‹åŒ–åŸºç¡€åœ°å›¾...');
            
            try {
                // åˆå§‹åŒ–åŸºç¡€å¯¼èˆªç³»ç»Ÿ
                if (typeof NavigationManager !== 'undefined') {
                    NavigationManager.init();
                }
                
                // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤º
                if (typeof Clock !== 'undefined') {
                    Clock.init();
                } else {
                    // æ‰‹åŠ¨æ›´æ–°æ—¶é—´
                    setInterval(() => {
                        const timeEl = document.querySelector('.current-time');
                        if (timeEl) {
                            timeEl.textContent = new Date().toLocaleString('zh-CN');
                        }
                    }, 1000);
                }
                
                // åˆå§‹åŒ–åŸºç¡€åœ°å›¾ï¼ˆé˜²é‡å¤ï¼‰
                if (typeof L !== 'undefined' && !mapInitialized && !mapInitializing) {
                    initializeMap();
                } else if (mapInitialized) {
                    console.log('åœ°å›¾å·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                    updateProgress(100, 'ç³»ç»Ÿå·²å°±ç»ªï¼');
                    hideLoadingIndicator();
                } else {
                    console.log('LeafletæœªåŠ è½½æˆ–åœ°å›¾æ­£åœ¨åˆå§‹åŒ–ä¸­');
                    updateProgress(100, 'ç­‰å¾…èµ„æºåŠ è½½å®Œæˆ...');
                    hideLoadingIndicator();
                }
                
                // æ ‡è®°ç³»ç»Ÿå¯åŠ¨å®Œæˆ
                systemStarted = true;
                systemStarting = false;
                console.log('âœ… åŸºç¡€æ¨¡å¼å¯åŠ¨å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ åŸºç¡€æ¨¡å¼å¯åŠ¨å¤±è´¥:', error);
                systemStarting = false;
                updateProgress(100, 'å¯åŠ¨é‡åˆ°é—®é¢˜ï¼Œä½†é¡µé¢å¯ç”¨');
                hideLoadingIndicator();
            }
        }

        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoadingIndicator() {
            setTimeout(() => {
                const loadingEl = document.getElementById('loadingIndicator');
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
            }, 1000);
        }

        // åœ°å›¾åˆå§‹åŒ–å‡½æ•°
        function initializeMap() {
            if (mapInitialized || mapInitializing) {
                console.log('åœ°å›¾å·²åˆå§‹åŒ–æˆ–æ­£åœ¨åˆå§‹åŒ–ä¸­ï¼Œè·³è¿‡');
                return;
            }
            
            mapInitializing = true;
            console.log('å¼€å§‹åˆå§‹åŒ–åœ°å›¾...');
            
            try {
                // ç¡®ä¿åœ°å›¾å®¹å™¨å­˜åœ¨ä¸”æœ‰å°ºå¯¸
                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    // æ¸…ç©ºå®¹å™¨å†…å®¹é˜²æ­¢å†²çª
                    mapContainer.innerHTML = '';
                    
                    // å¼ºåˆ¶è®¾ç½®å®¹å™¨å°ºå¯¸
                    mapContainer.style.width = '100%';
                    mapContainer.style.height = '100%';
                    
                    try {
                        const map = L.map(mapContainer, {
                                center: [22.261, 114.246],
                                zoom: 16,
                                zoomControl: true,
                                attributionControl: false,
                                preferCanvas: true // æé«˜æ€§èƒ½
                            });
                            
                            // å¤šä¸ªåœ°å›¾åº•å›¾å¤‡ç”¨æ–¹æ¡ˆ
                            const tileLayers = [
                                {
                                    name: 'CARTO Light',
                                    url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                                    options: { attribution: 'Â© CARTO', maxZoom: 19, subdomains: 'abcd' }
                                },
                                {
                                    name: 'OpenStreetMap',
                                    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                                    options: { attribution: 'Â© OpenStreetMap', maxZoom: 19, subdomains: 'abc' }
                                },
                                {
                                    name: 'CARTO Positron',
                                    url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
                                    options: { attribution: 'Â© CARTO', maxZoom: 19, subdomains: 'abcd' }
                                }
                            ];
                            
                            let tileLayerLoaded = false;
                            let currentTileIndex = 0;
                            
                            function loadTileLayer() {
                                if (currentTileIndex >= tileLayers.length) {
                                    console.error('æ‰€æœ‰åœ°å›¾æœåŠ¡éƒ½åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°åœ°å›¾');
                                    showLocalMap(map);
                                    return;
                                }
                                
                                const tileData = tileLayers[currentTileIndex];
                                console.log(`å°è¯•åŠ è½½åœ°å›¾æœåŠ¡: ${tileData.name}`);
                                
                                const tileLayer = L.tileLayer(tileData.url, {
                                    ...tileData.options,
                                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==', // 1x1 é€æ˜åƒç´ 
                                    timeout: 10000
                                });
                                
                                // ç›‘å¬ç“¦ç‰‡åŠ è½½äº‹ä»¶
                                let tilesLoaded = 0;
                                let tilesTotal = 0;
                                let loadTimeout;
                                
                                tileLayer.on('loading', () => {
                                    tilesLoaded = 0;
                                    tilesTotal = 0;
                                    clearTimeout(loadTimeout);
                                    loadTimeout = setTimeout(() => {
                                        if (!tileLayerLoaded) {
                                            console.warn(`åœ°å›¾æœåŠ¡ ${tileData.name} åŠ è½½è¶…æ—¶`);
                                            map.removeLayer(tileLayer);
                                            currentTileIndex++;
                                            loadTileLayer();
                                        }
                                    }, 8000);
                                });
                                
                                tileLayer.on('tileload', () => {
                                    tilesLoaded++;
                                    if (tilesLoaded >= 1 && !tileLayerLoaded) {
                                        tileLayerLoaded = true;
                                        clearTimeout(loadTimeout);
                                        console.log(`åœ°å›¾æœåŠ¡ ${tileData.name} åŠ è½½æˆåŠŸ`);
                                    }
                                });
                                
                                tileLayer.on('tileerror', () => {
                                    if (!tileLayerLoaded) {
                                        console.warn(`åœ°å›¾æœåŠ¡ ${tileData.name} ç“¦ç‰‡åŠ è½½é”™è¯¯`);
                                        setTimeout(() => {
                                            if (!tileLayerLoaded) {
                                                map.removeLayer(tileLayer);
                                                currentTileIndex++;
                                                loadTileLayer();
                                            }
                                        }, 2000);
                                    }
                                });
                                
                                tileLayer.addTo(map);
                            }
                            
                            // å¼€å§‹åŠ è½½åœ°å›¾åº•å›¾
                            loadTileLayer();
                            
                            // å­˜å‚¨åœ°å›¾å®ä¾‹åˆ°å…¨å±€å˜é‡
                            window.mapInstance = map;
                            
                            // æ·»åŠ æ°´åŠ›è®¾æ–½æ•°æ®
                            addWaterFacilities(map);
                            
                            // æ·»åŠ åœ°å›¾æ§ä»¶
                            L.control.scale({
                                position: 'bottomright',
                                imperial: false
                            }).addTo(map);
                            
                            console.log('åŸºç¡€åœ°å›¾å·²åŠ è½½å®Œæˆ');
                            
                            // å»¶è¿Ÿåˆ·æ–°åœ°å›¾å°ºå¯¸
                            setTimeout(() => {
                                map.invalidateSize();
                            }, 100);
                            
                        } catch (mapError) {
                            console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', mapError);
                            mapInitializing = false;
                            showMapError(mapContainer, mapError.message);
                            return;
                        }
                    } else {
                        console.error('åœ°å›¾å®¹å™¨ä¸å­˜åœ¨');
                        mapInitializing = false;
                        return;
                    }
                    
                    // æ ‡è®°åœ°å›¾åˆå§‹åŒ–å®Œæˆ
                    mapInitialized = true;
                    mapInitializing = false;
                    
                    // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
                    if (typeof ThemeManager !== 'undefined') {
                        ThemeManager.init();
                    }
                    
                    updateProgress(100, 'åœ°å›¾åˆå§‹åŒ–å®Œæˆï¼');
                    
                    // éšè—åŠ è½½ç•Œé¢
                    setTimeout(() => {
                        const loadingEl = document.getElementById('loadingIndicator');
                        if (loadingEl) {
                            loadingEl.style.display = 'none';
                        }
                        console.log('åœ°å›¾å·²æˆåŠŸåˆå§‹åŒ–');
                    }, 1000);
                    
            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–è¿‡ç¨‹å¤±è´¥:', error);
                mapInitializing = false;
                updateProgress(100, 'åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message);
                
                // éšè—åŠ è½½ç•Œé¢
                setTimeout(() => {
                    const loadingEl = document.getElementById('loadingIndicator');
                    if (loadingEl) {
                        loadingEl.style.display = 'none';
                    }
                }, 1000);
            }
        }

        // é¢æ¿åˆ‡æ¢åŠŸèƒ½ï¼ˆå…¼å®¹æ€§ï¼‰
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const icon = panel.querySelector('.panel-toggle i');
            const isLeft = panelId === 'leftPanel';
            
            panel.classList.toggle('collapsed');
            const isCollapsed = panel.classList.contains('collapsed');

            if (isLeft) {
                icon.className = `fas ${isCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'}`;
            } else {
                icon.className = `fas ${isCollapsed ? 'fa-chevron-left' : 'fa-chevron-right'}`;
                document.getElementById('right-panel-wrapper').style.display = isCollapsed ? 'none' : 'flex';
            }
        }

        // æ›´æ–°è®¾æ–½é¢æ¿ï¼ˆå…¼å®¹æ€§ï¼‰
        function updateFacilityPanel(facility) {
            const propertiesPanel = document.getElementById('propertiesPanel');
            const noSelection = document.getElementById('noSelection');
            const selectedFacility = document.getElementById('selectedFacility');
            
            if (propertiesPanel && noSelection && selectedFacility) {
                // éšè—æ— é€‰æ‹©æç¤ºï¼Œæ˜¾ç¤ºè®¾æ–½ä¿¡æ¯
                noSelection.style.display = 'none';
                selectedFacility.style.display = 'block';
                
                // ç¡®ä¿å³ä¾§é¢æ¿å±•å¼€
                const rightPanel = document.getElementById('rightPanel');
                if (rightPanel && rightPanel.classList.contains('collapsed')) {
                    togglePanel('rightPanel');
                }
                
                // ç”Ÿæˆè®¾æ–½è¯¦ç»†ä¿¡æ¯
                let facilityHtml = `
                    <div class="facility-header">
                        <h3 style="color: var(--primary); margin-bottom: 10px;">
                            ${getFacilityIcon(facility.type)} ${facility.name}
                        </h3>
                        <span class="badge badge-primary">${facility.type}</span>
                    </div>
                    
                    <div class="facility-details" style="margin-top: 20px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 10px;">å®æ—¶æ•°æ®</h4>
                `;
                
                if (facility.pressure) {
                    facilityHtml += `
                        <div class="detail-item">
                            <span class="detail-label">å‹åŠ›:</span>
                            <span class="detail-value">${facility.pressure} bar</span>
                        </div>
                    `;
                }
                
                if (facility.flow) {
                    facilityHtml += `
                        <div class="detail-item">
                            <span class="detail-label">æµé‡:</span>
                            <span class="detail-value">${facility.flow} mÂ³/h</span>
                        </div>
                    `;
                }
                
                if (facility.status) {
                    facilityHtml += `
                        <div class="detail-item">
                            <span class="detail-label">çŠ¶æ€:</span>
                            <span class="detail-value status-${facility.status === 'è¿è¡Œä¸­' ? 'running' : 'normal'}">${facility.status}</span>
                        </div>
                    `;
                }
                
                if (facility.level) {
                    facilityHtml += `
                        <div class="detail-item">
                            <span class="detail-label">æ°´ä½:</span>
                            <span class="detail-value">${facility.level}% 
                                <div class="progress" style="width: 100px; display: inline-block; margin-left: 10px;">
                                    <div class="progress-bar" style="width: ${facility.level}%;"></div>
                                </div>
                            </span>
                        </div>
                    `;
                }
                
                if (facility.power) {
                    facilityHtml += `
                        <div class="detail-item">
                            <span class="detail-label">åŠŸç‡:</span>
                            <span class="detail-value">${facility.power}%
                                <div class="progress" style="width: 100px; display: inline-block; margin-left: 10px;">
                                    <div class="progress-bar" style="width: ${facility.power}%;"></div>
                                </div>
                            </span>
                        </div>
                    `;
                }
                
                facilityHtml += `
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 10px;">æ“ä½œ</h4>
                        <div class="btn-group" style="flex-direction: column; gap: 8px;">
                            <button class="btn btn-sm btn-primary" onclick="viewFacilityHistory('${facility.name}')">
                                <i class="fas fa-chart-line"></i> å†å²æ•°æ®
                            </button>
                            <button class="btn btn-sm" onclick="configureFacility('${facility.name}')">
                                <i class="fas fa-cog"></i> é…ç½®å‚æ•°
                            </button>
                            <button class="btn btn-sm" onclick="exportFacilityData('${facility.name}')">
                                <i class="fas fa-download"></i> å¯¼å‡ºæ•°æ®
                            </button>
                        </div>
                    </div>
                `;
                
                selectedFacility.innerHTML = facilityHtml;
            }
        }

        // è·å–è®¾æ–½å›¾æ ‡
        function getFacilityIcon(type) {
            switch(type) {
                case 'pump': return 'âš¡';
                case 'reservoir': return 'ğŸŠ';
                case 'valve': return 'ğŸ”§';
                default: return 'ğŸ“';
            }
        }

        // è®¾æ–½æ“ä½œå‡½æ•°ï¼ˆå ä½ç¬¦ï¼‰
        function viewFacilityHistory(name) {
            alert('æŸ¥çœ‹ ' + name + ' çš„å†å²æ•°æ®åŠŸèƒ½å¾…å¼€å‘');
        }

        function configureFacility(name) {
            alert('é…ç½® ' + name + ' çš„å‚æ•°åŠŸèƒ½å¾…å¼€å‘');
        }

        function exportFacilityData(name) {
            alert('å¯¼å‡º ' + name + ' çš„æ•°æ®åŠŸèƒ½å¾…å¼€å‘');
        }

        // æœ¬åœ°åœ°å›¾å¤‡ç”¨æ–¹æ¡ˆ
        function showLocalMap(map) {
            console.log('å¯ç”¨æœ¬åœ°åœ°å›¾æ¨¡å¼');
            
            // åˆ›å»ºæœ¬åœ°ç½‘æ ¼èƒŒæ™¯
            const bounds = [[22.25, 114.22], [22.28, 114.27]];
            
            // æ·»åŠ ç½‘æ ¼èƒŒæ™¯
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 80; i++) {
                ctx.beginPath();
                ctx.moveTo(i * 10, 0);
                ctx.lineTo(i * 10, 600);
                ctx.stroke();
            }
            
            for (let i = 0; i <= 60; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * 10);
                ctx.lineTo(800, i * 10);
                ctx.stroke();
            }
            
            // æ·»åŠ æ°´å°
            ctx.fillStyle = '#f0f0f0';
            ctx.font = '16px Microsoft YaHei';
            ctx.fillText('ç¦»çº¿åœ°å›¾æ¨¡å¼', 350, 300);
            
            const dataUrl = canvas.toDataURL();
            
            // åˆ›å»ºæœ¬åœ°å›¾å±‚
            const localLayer = L.imageOverlay(dataUrl, bounds, {
                opacity: 0.5
            }).addTo(map);
            
            // æ·»åŠ è¯´æ˜
            const infoControl = L.control({ position: 'topleft' });
            infoControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'info-control');
                div.innerHTML = `
                    <div style="background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                        <h4 style="margin: 0 0 5px 0; color: #ff6b35;">ğŸ”„ ç¦»çº¿æ¨¡å¼</h4>
                        <p style="margin: 0; font-size: 12px;">ç½‘ç»œåœ°å›¾æœåŠ¡ä¸å¯ç”¨<br/>æ­£åœ¨ä½¿ç”¨æœ¬åœ°åœ°å›¾</p>
                        <button onclick="retryMapLoad()" style="margin-top: 5px; padding: 3px 8px; font-size: 10px;" class="btn btn-sm btn-primary">
                            é‡è¯•è”ç½‘
                        </button>
                    </div>
                `;
                return div;
            };
            infoControl.addTo(map);
        }

        // æ˜¾ç¤ºåœ°å›¾é”™è¯¯
        function showMapError(container, errorMessage) {
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; 
                            color: #666; flex-direction: column; font-family: Microsoft YaHei; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #ff6b35;"></i>
                    <h3 style="color: #333; margin-bottom: 10px;">åœ°å›¾åˆå§‹åŒ–å¤±è´¥</h3>
                    <p style="margin-bottom: 20px; color: #666;">é”™è¯¯ä¿¡æ¯: ${errorMessage}</p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="retryMapLoad()" class="btn btn-primary">
                            <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
                        </button>
                        <button onclick="useOfflineMode()" class="btn">
                            <i class="fas fa-map"></i> ç¦»çº¿æ¨¡å¼
                        </button>
                    </div>
                    <div style="margin-top: 20px; font-size: 12px; color: #999;">
                        <p>ğŸ’¡ æ•…éšœæ’é™¤å»ºè®®:</p>
                        <ul style="text-align: left; max-width: 300px;">
                            <li>æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
                            <li>åˆ·æ–°é¡µé¢é‡è¯•</li>
                            <li>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</li>
                            <li>ä½¿ç”¨ç¦»çº¿æ¨¡å¼ç»§ç»­</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // é‡æ–°åŠ è½½åœ°å›¾
        function retryMapLoad() {
            console.log('ğŸ”„ ç”¨æˆ·æ‰‹åŠ¨é‡è¯•åœ°å›¾åŠ è½½');
            
            // é‡ç½®å¯åŠ¨çŠ¶æ€
            systemStarted = false;
            systemStarting = false;
            mapInitialized = false;
            mapInitializing = false;
            
            // æ¸…é™¤ç°æœ‰åœ°å›¾å®ä¾‹
            if (window.mapInstance) {
                try {
                    window.mapInstance.remove();
                } catch (e) {
                    console.log('æ¸…é™¤åœ°å›¾å®ä¾‹æ—¶å‡ºé”™:', e);
                }
                window.mapInstance = null;
            }
            
            // æ¸…ç©ºåœ°å›¾å®¹å™¨
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = '';
            }
            
            // é‡æ–°å¯åŠ¨ç³»ç»Ÿ
            setTimeout(() => {
                location.reload();
            }, 100);
        }

        // ä½¿ç”¨ç¦»çº¿æ¨¡å¼
        function useOfflineMode() {
            console.log('ğŸ”„ åˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼');
            
            if (systemStarted) {
                console.log('ç³»ç»Ÿå·²å¯åŠ¨ï¼Œè·³è¿‡ç¦»çº¿æ¨¡å¼åˆå§‹åŒ–');
                return;
            }
            
            // é‡ç½®çŠ¶æ€
            systemStarting = true;
            mapInitialized = false;
            mapInitializing = false;
            
            const mapContainer = document.getElementById('map');
            if (mapContainer && typeof L !== 'undefined') {
                // æ¸…ç©ºå¹¶é‡æ–°åˆ›å»ºåœ°å›¾å®¹å™¨
                mapContainer.innerHTML = '';
                
                try {
                    const map = L.map(mapContainer, {
                        center: [22.261, 114.246],
                        zoom: 16,
                        zoomControl: true,
                        attributionControl: false
                    });
                    
                    showLocalMap(map);
                    addWaterFacilities(map);
                    window.mapInstance = map;
                    mapInitialized = true;
                    systemStarted = true;
                    systemStarting = false;
                    
                    console.log('âœ… ç¦»çº¿æ¨¡å¼åœ°å›¾å·²åˆ›å»º');
                } catch (error) {
                    console.error('âŒ ç¦»çº¿æ¨¡å¼åœ°å›¾åˆ›å»ºå¤±è´¥:', error);
                    systemStarting = false;
                    mapContainer.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; 
                                    color: #666; flex-direction: column; font-family: Microsoft YaHei;">
                            <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 20px; color: #ff6b35;"></i>
                            <h3>ç¦»çº¿æ¨¡å¼å¯åŠ¨å¤±è´¥</h3>
                            <p>è¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
                        </div>
                    `;
                }
            }
        }

        // åˆå§‹åŒ–å·¦ä¾§é¢æ¿
        function initLeftPanel() {
            const leftPanelContent = document.getElementById('left-panel-content');
            if (leftPanelContent) {
                leftPanelContent.innerHTML = `
                    <div class="layer-control">
                        <div class="layer-group">
                            <h3 onclick="toggleLayerGroup(this)">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>èŠ‚ç‚¹ä¸»é¢˜</span>
                                <i class="fas fa-chevron-down layer-toggle"></i>
                            </h3>
                            <div class="layer-items">
                                <div class="layer-item active" data-layer="pressure">
                                    <input type="checkbox" checked onchange="toggleLayer('pressure', this)">
                                    <div class="layer-icon" style="background: #3498db; border-radius: 50%; width: 12px; height: 12px;"></div>
                                    <span class="layer-name">å‹åŠ›åˆ†å±‚</span>
                                </div>
                                <div class="layer-item" data-layer="flow">
                                    <input type="checkbox" onchange="toggleLayer('flow', this)">
                                    <div class="layer-icon" style="background: #2ecc71; border-radius: 50%; width: 12px; height: 12px;"></div>
                                    <span class="layer-name">æµé‡åˆ†å±‚</span>
                                </div>
                                <div class="layer-item" data-layer="quality">
                                    <input type="checkbox" onchange="toggleLayer('quality', this)">
                                    <div class="layer-icon" style="background: #f39c12; border-radius: 50%; width: 12px; height: 12px;"></div>
                                    <span class="layer-name">æ°´è´¨åˆ†å±‚</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="layer-group">
                            <h3 onclick="toggleLayerGroup(this)">
                                <i class="fas fa-layer-group"></i>
                                <span>è®¾å¤‡å›¾å±‚</span>
                                <i class="fas fa-chevron-down layer-toggle"></i>
                            </h3>
                            <div class="layer-items">
                                <div class="layer-item active" data-layer="pumps">
                                    <input type="checkbox" checked onchange="toggleLayer('pumps', this)">
                                    <div class="layer-icon" style="color: #9b59b6;">âš¡</div>
                                    <span class="layer-name">æ³µç«™</span>
                                </div>
                                <div class="layer-item active" data-layer="reservoirs">
                                    <input type="checkbox" checked onchange="toggleLayer('reservoirs', this)">
                                    <div class="layer-icon" style="color: #2ecc71;">ğŸŠ</div>
                                    <span class="layer-name">è“„æ°´æ± </span>
                                </div>
                                <div class="layer-item active" data-layer="valves">
                                    <input type="checkbox" checked onchange="toggleLayer('valves', this)">
                                    <div class="layer-icon" style="color: #f39c12;">ğŸ”§</div>
                                    <span class="layer-name">æ°´é˜€</span>
                                </div>
                                <div class="layer-item active" data-layer="junctions">
                                    <input type="checkbox" checked onchange="toggleLayer('junctions', this)">
                                    <div class="layer-icon" style="color: #3498db;">ğŸ“</div>
                                    <span class="layer-name">èŠ‚ç‚¹</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="layer-group">
                            <h3 onclick="toggleLayerGroup(this)">
                                <i class="fas fa-project-diagram"></i>
                                <span>ç®¡é“å›¾å±‚</span>
                                <i class="fas fa-chevron-down layer-toggle"></i>
                            </h3>
                            <div class="layer-items">
                                <div class="layer-item active" data-layer="pipes">
                                    <input type="checkbox" checked onchange="toggleLayer('pipes', this)">
                                    <div class="layer-icon" style="border: 2px solid #4A90B8; width: 12px; height: 2px; border-radius: 1px;"></div>
                                    <span class="layer-name">å…¨éƒ¨ç®¡é“</span>
                                </div>
                                <div class="layer-item" data-layer="main-pipes">
                                    <input type="checkbox" onchange="toggleLayer('main-pipes', this)">
                                    <div class="layer-icon" style="border: 3px solid #e74c3c; width: 12px; height: 2px; border-radius: 1px;"></div>
                                    <span class="layer-name">ä¸»ç®¡é“</span>
                                </div>
                                <div class="layer-item" data-layer="service-pipes">
                                    <input type="checkbox" onchange="toggleLayer('service-pipes', this)">
                                    <div class="layer-icon" style="border: 1px solid #95a5a6; width: 12px; height: 2px; border-radius: 1px;"></div>
                                    <span class="layer-name">æœåŠ¡ç®¡é“</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="layer-group">
                            <h3 onclick="toggleLayerGroup(this)">
                                <i class="fas fa-cog"></i>
                                <span>ç›‘æµ‹ç‚¹</span>
                                <i class="fas fa-chevron-down layer-toggle"></i>
                            </h3>
                            <div class="layer-items">
                                <div class="layer-item active" data-layer="monitoring">
                                    <input type="checkbox" checked onchange="toggleLayer('monitoring', this)">
                                    <div class="layer-icon" style="color: #17a2b8;">ğŸ“Š</div>
                                    <span class="layer-name">ç›‘æµ‹ç‚¹</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // åˆ‡æ¢å›¾å±‚ç»„å±•å¼€/æ”¶èµ·
        function toggleLayerGroup(element) {
            const layerGroup = element.parentElement;
            layerGroup.classList.toggle('collapsed');
        }

        // åˆ‡æ¢å›¾å±‚æ˜¾ç¤º/éšè—
        function toggleLayer(layerName, checkbox) {
            const isChecked = checkbox.checked;
            console.log(`å›¾å±‚ ${layerName} ${isChecked ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„å›¾å±‚æ§åˆ¶é€»è¾‘
            if (window.mapInstance) {
                // å®é™…çš„å›¾å±‚æ§åˆ¶ä¼šåœ¨è¿™é‡Œå®ç°
                console.log('åœ°å›¾å®ä¾‹å­˜åœ¨ï¼Œå¯ä»¥è¿›è¡Œå›¾å±‚æ“ä½œ');
            }
            
            // æ›´æ–°å›¾å±‚é¡¹çš„è§†è§‰çŠ¶æ€
            const layerItem = checkbox.closest('.layer-item');
            if (isChecked) {
                layerItem.classList.add('active');
            } else {
                layerItem.classList.remove('active');
            }
        }

        // æ·»åŠ æ°´åŠ›è®¾æ–½åˆ°åœ°å›¾ï¼ˆé€šç”¨å‡½æ•°ï¼‰
        function addWaterFacilities(map) {
            // é˜²æ­¢é‡å¤æ·»åŠ è®¾æ–½
            if (map._facilitiesAdded) {
                console.log('âš ï¸ è®¾æ–½å·²æ·»åŠ ï¼Œè·³è¿‡é‡å¤æ·»åŠ ');
                return;
            }
            
            console.log('ğŸ—ï¸ å¼€å§‹æ·»åŠ æ°´åŠ›è®¾æ–½åˆ°åœ°å›¾...');
            
            const facilities = [
                { lat: 22.261, lng: 114.246, name: 'ä¸­å¤®ç›‘æµ‹ç«™', type: 'junction', pressure: 45.2, flow: 128.5 },
                { lat: 22.265, lng: 114.250, name: 'é«˜å‹æ³µç«™A', type: 'pump', status: 'è¿è¡Œä¸­', power: 85 },
                { lat: 22.258, lng: 114.242, name: 'ä¸»æ°´åº“B', type: 'reservoir', level: 78.5, capacity: 5000 },
                { lat: 22.263, lng: 114.248, name: 'åˆ†é…èŠ‚ç‚¹C', type: 'junction', pressure: 42.1, flow: 95.2 },
                { lat: 22.259, lng: 114.244, name: 'è°ƒèŠ‚é˜€D', type: 'valve', status: 'å¼€å¯', position: 75 }
            ];
            
            facilities.forEach(facility => {
                let color, icon;
                switch(facility.type) {
                    case 'pump':
                        color = '#9b59b6';
                        icon = 'âš¡';
                        break;
                    case 'reservoir':
                        color = '#2ecc71';
                        icon = 'ğŸŠ';
                        break;
                    case 'valve':
                        color = '#f39c12';
                        icon = 'ğŸ”§';
                        break;
                    default:
                        color = '#3498db';
                        icon = 'ğŸ“';
                }
                
                const marker = L.circleMarker([facility.lat, facility.lng], {
                    radius: 10,
                    fillColor: color,
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                // åˆ›å»ºè¯¦ç»†ä¿¡æ¯å¼¹çª—
                let popupContent = `<div style="font-family: Microsoft YaHei; min-width: 200px;">
                    <h4 style="margin: 0 0 10px 0; color: ${color};">${icon} ${facility.name}</h4>
                    <p style="margin: 5px 0; color: #666;"><strong>ç±»å‹:</strong> ${facility.type}</p>`;
                
                if (facility.pressure) popupContent += `<p style="margin: 5px 0; color: #666;"><strong>å‹åŠ›:</strong> ${facility.pressure} bar</p>`;
                if (facility.flow) popupContent += `<p style="margin: 5px 0; color: #666;"><strong>æµé‡:</strong> ${facility.flow} mÂ³/h</p>`;
                if (facility.status) popupContent += `<p style="margin: 5px 0; color: #666;"><strong>çŠ¶æ€:</strong> ${facility.status}</p>`;
                if (facility.level) popupContent += `<p style="margin: 5px 0; color: #666;"><strong>æ°´ä½:</strong> ${facility.level}%</p>`;
                if (facility.power) popupContent += `<p style="margin: 5px 0; color: #666;"><strong>åŠŸç‡:</strong> ${facility.power}%</p>`;
                
                popupContent += `</div>`;
                
                marker.bindPopup(popupContent);
                
                // ç‚¹å‡»æ—¶æ›´æ–°å³ä¾§é¢æ¿
                marker.on('click', () => {
                    updateFacilityPanel(facility);
                });
            });
            
            // æ·»åŠ ç®¡é“è¿æ¥çº¿
            const pipes = [
                [[22.261, 114.246], [22.265, 114.250]],
                [[22.261, 114.246], [22.258, 114.242]],
                [[22.261, 114.246], [22.263, 114.248]],
                [[22.263, 114.248], [22.259, 114.244]]
            ];
            
            console.log('ğŸ”— å¼€å§‹ç»˜åˆ¶ç®¡é“è¿æ¥çº¿...');
            
            pipes.forEach((pipe, index) => {
                const polyline = L.polyline(pipe, {
                    color: '#4A90B8',
                    weight: 6,
                    opacity: 1,
                    dashArray: '10, 5',
                    className: 'water-pipe',
                    interactive: true,
                    pane: 'overlayPane' // ç¡®ä¿åœ¨ç“¦ç‰‡å±‚ä¸Šæ–¹
                }).addTo(map);
                
                // æ·»åŠ ç®¡é“ä¿¡æ¯å¼¹çª—
                polyline.bindPopup(`
                    <div style="font-family: Microsoft YaHei; min-width: 180px;">
                        <h4 style="margin: 0 0 10px 0; color: #4A90B8;">ğŸ”— ä¾›æ°´ç®¡é“ ${index + 1}</h4>
                        <p style="margin: 5px 0; color: #666;"><strong>ç®¡å¾„:</strong> DN300</p>
                        <p style="margin: 5px 0; color: #666;"><strong>æè´¨:</strong> çƒå¢¨é“¸é“</p>
                        <p style="margin: 5px 0; color: #666;"><strong>æµé€Ÿ:</strong> 2.5 m/s</p>
                        <p style="margin: 5px 0; color: #666;"><strong>å‹åŠ›:</strong> 0.45 MPa</p>
                    </div>
                `);
                
                console.log(`âœ… ç®¡é“ ${index + 1} å·²ç»˜åˆ¶å®Œæˆ`);
            });
            
            console.log(`âœ… æ€»å…±ç»˜åˆ¶äº† ${pipes.length} æ¡ç®¡é“è¿æ¥çº¿`);
            
            // æ ‡è®°è®¾æ–½å·²æ·»åŠ ï¼Œé˜²æ­¢é‡å¤
            map._facilitiesAdded = true;
            console.log('âœ… æ°´åŠ›è®¾æ–½å’Œç®¡é“æ·»åŠ å®Œæˆ');
        }

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            console.error('é¡µé¢é”™è¯¯:', event.error);
            updateProgress(0, 'åŠ è½½å‡ºé”™ï¼š' + event.error.message);
        });

        // å³ä¾§é¢æ¿åˆ‡æ¢å…¼å®¹æ€§
        window.RightPanel = {
            switchTab: function(event, tabName) {
                // åˆ‡æ¢æ ‡ç­¾é¡µ
                const tabs = document.querySelectorAll('.panel-tab');
                const contents = document.querySelectorAll('.tab-content');
                
                tabs.forEach(tab => tab.classList.remove('active'));
                contents.forEach(content => content.classList.remove('active'));
                
                event.target.classList.add('active');
                document.getElementById(tabName + 'Panel').classList.add('active');
            }
        };

        // ç›‘å¬æ¨¡å—åŒ–åº”ç”¨çŠ¶æ€
        window.addEventListener('load', () => {
            // æ£€æŸ¥æ˜¯å¦æœ‰é—ç•™çš„å…¨å±€å‡½æ•°éœ€è¦å…¼å®¹
            if (typeof switchMapTheme === 'undefined') {
                window.switchMapTheme = function(theme) {
                    if (App && App.getModule && App.getModule('LayerControl')) {
                        App.getModule('LayerControl').switchTheme(theme);
                    }
                };
            }
        });

        // å¼€å‘è€…å·¥å…·å’Œç³»ç»ŸçŠ¶æ€ç›‘æ§
        window.WaterSystemDebug = {
            getApp: () => window.App,
            getModules: () => window.App ? window.App.modules : null,
            getEventBus: () => window.EventBus,
            triggerEvent: (event, data) => window.EventBus && window.EventBus.emit(event, data),
            getSystemStatus: () => ({
                systemStarted,
                systemStarting,
                mapInitialized,
                mapInitializing,
                mapInstance: !!window.mapInstance
            }),
            resetSystem: () => {
                console.log('ğŸ”§ æ‰‹åŠ¨é‡ç½®ç³»ç»ŸçŠ¶æ€');
                systemStarted = false;
                systemStarting = false;
                mapInitialized = false;
                mapInitializing = false;
                if (window.mapInstance) {
                    try {
                        window.mapInstance.remove();
                    } catch (e) {}
                    window.mapInstance = null;
                }
            },
            checkPipes: () => {
                if (window.mapInstance) {
                    let pipeCount = 0;
                    let facilityCount = 0;
                    
                    window.mapInstance.eachLayer((layer) => {
                        if (layer instanceof L.Polyline) {
                            pipeCount++;
                            console.log('ğŸ”— å‘ç°ç®¡é“:', layer);
                        }
                        if (layer instanceof L.CircleMarker) {
                            facilityCount++;
                            console.log('ğŸ­ å‘ç°è®¾æ–½:', layer);
                        }
                    });
                    
                    console.log(`ğŸ“Š åœ°å›¾ç»Ÿè®¡: ${facilityCount} ä¸ªè®¾æ–½, ${pipeCount} æ¡ç®¡é“`);
                    return { facilities: facilityCount, pipes: pipeCount };
                } else {
                    console.log('âŒ åœ°å›¾å®ä¾‹ä¸å­˜åœ¨');
                    return null;
                }
            },
            addTestPipe: () => {
                if (window.mapInstance) {
                    const testPipe = L.polyline([[22.26, 114.24], [22.27, 114.25]], {
                        color: 'red',
                        weight: 8,
                        opacity: 1
                    }).addTo(window.mapInstance);
                    testPipe.bindPopup('æµ‹è¯•ç®¡é“');
                    console.log('âœ… å·²æ·»åŠ æµ‹è¯•ç®¡é“');
                    return testPipe;
                }
            }
        };
        
        if (location.search.includes('debug=true')) {
            console.log('ğŸ”§ è°ƒè¯•æ¨¡å¼å·²å¯ç”¨ï¼Œä½¿ç”¨ WaterSystemDebug è®¿é—®ç³»ç»Ÿ');
        }
        
        // å®šæœŸçŠ¶æ€æ£€æŸ¥ï¼ˆè°ƒè¯•ç”¨ï¼‰
        setInterval(() => {
            if (location.search.includes('debug=true')) {
                console.log('ğŸ“Š ç³»ç»ŸçŠ¶æ€:', WaterSystemDebug.getSystemStatus());
            }
        }, 10000);
    </script>

    <!-- æ‚¬æµ®ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle-float" onclick="ThemeManager.toggle()" title="åˆ‡æ¢ä¸»é¢˜">
        <i class="fas fa-moon"></i>
    </button>
</body>
</html> 