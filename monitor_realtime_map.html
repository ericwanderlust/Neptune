<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线水力模型系统 - 实时监控</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.0/dist/proj4.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: #f5f6fa;
            color: #2f3640;
            overflow: hidden;
        }

        /* 顶部导航 */
        .top-nav {
            background: #ffffff;
            border-bottom: 1px solid #ddd;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            position: relative;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .system-title {
            font-size: 18px;
            font-weight: 600;
            color: #2f3640;
        }

        .nav-center {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .mode-switch {
            display: flex;
            background: #f1f2f6;
            border-radius: 6px;
            padding: 2px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: #57606f;
        }

        .mode-btn.active {
            background: #4A90B8;
            color: white;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
            color: #57606f;
        }
        
        .btn {
            padding: 6px 12px;
            border: 1px solid #4A90B8;
            background: white;
            color: #4A90B8;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #4A90B8;
            color: white;
        }

        /* 时间轴控制器 */
        .time-controller {
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 900;
            position: relative;
        }

        .time-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .time-display {
            font-size: 16px;
            font-weight: 600;
            color: #2f3640;
            position: relative;
        }

        /* 时间轴动效 */
        .time-display::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            height: 2px;
            background: linear-gradient(90deg, #4A90B8, transparent);
            border-radius: 1px;
            animation: timeProgress 5s infinite;
        }

        @keyframes timeProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .time-display.playing::after {
            animation: timeProgress 5s infinite;
        }

        .time-display.paused::after {
            animation-play-state: paused;
        }

        .time-info {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #57606f;
            position: relative;
        }

        /* 数据更新指示器 */
        .data-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ed573;
            animation: pulse 2s infinite;
            margin-right: 5px;
        }

        .time-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .play-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .control-btn:hover {
            background: #f1f2f6;
        }

        .control-btn.playing {
            background: #4A90B8;
            color: white;
            animation: buttonPulse 1.5s infinite;
        }

        @keyframes buttonPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .time-slider {
            flex: 1;
            margin: 0 15px;
            position: relative;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: #f1f2f6;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            position: relative;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #4A90B8;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(74, 144, 184, 0.5);
        }

        /* 进度条动效 */
        .simulation-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 6px;
            background: linear-gradient(90deg, #4A90B8, #74b9ff);
            width: 58.33%;
            pointer-events: none;
            opacity: 0.6;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .simulation-progress.animated {
            animation: progressShimmer 2s infinite;
        }

        @keyframes progressShimmer {
            0% { opacity: 0.3; }
            50% { opacity: 0.8; }
            100% { opacity: 0.3; }
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #57606f;
        }

        .speed-control select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #2f3640;
            transition: all 0.3s;
        }

        .speed-control select:focus {
            border-color: #4A90B8;
            box-shadow: 0 0 5px rgba(74, 144, 184, 0.3);
        }

        /* 主容器 */
        .main-container {
            display: flex;
            height: calc(100vh - 120px);
        }

        /* 左侧菜单 */
        .left-panel {
            width: 280px;
            background: #ffffff;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: width 0.3s ease;
            position: relative;
        }

        .left-panel.collapsed {
            width: 50px;
        }

        .left-panel.collapsed .section-content,
        .left-panel.collapsed .section-header span {
            display: none;
        }

        .panel-toggle {
            position: absolute;
            top: 15px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: #4A90B8;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .panel-toggle:hover {
            background: #357abd;
            transform: scale(1.1);
        }

        .panel-section {
            border-bottom: 1px solid #eee;
        }

        .section-header {
            padding: 15px 20px;
            background: #f8f9fa;
            font-weight: 600;
            font-size: 14px;
            color: #2f3640;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .section-header:hover {
            background: #e9ecef;
        }

        .section-header i {
            color: #4A90B8;
        }

        .left-panel.collapsed .section-header {
            justify-content: center;
            padding: 15px 10px;
        }

        .section-content {
            padding: 10px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            color: #57606f;
        }

        .menu-item:hover {
            background: #f1f2f6;
        }

        .menu-item.active {
            background: #e8f4f8;
            color: #4A90B8;
            border-right: 3px solid #4A90B8;
        }

        .menu-item i {
            width: 16px;
            text-align: center;
        }

        /* 地图区域 */
        .map-container {
            flex: 1;
            position: relative;
            background: #ffffff;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* 地图工具栏 */
        .map-toolbar {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            display: flex;
            gap: 8px;
            z-index: 800;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .toolbar-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #57606f;
        }

        .toolbar-btn:hover,
        .toolbar-btn.active {
            background: #4A90B8;
            color: white;
            border-color: #4A90B8;
        }

        .toolbar-btn:not(.active) {
            opacity: 0.7;
        }

        /* 对比模式 */
        .compare-mode {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            z-index: 800;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .compare-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #57606f;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .toggle-switch.active {
            background: #4A90B8;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: left 0.2s ease;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        /* 右侧面板 */
        .right-panel {
            width: 380px;
            background: #ffffff;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease;
            position: relative;
        }

        .right-panel.collapsed {
            width: 50px;
        }

        .right-panel.collapsed .panel-content {
            display: none;
        }

        .right-panel-toggle {
            position: absolute;
            top: 15px;
            left: -15px;
            width: 30px;
            height: 30px;
            background: #4A90B8;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .right-panel-toggle:hover {
            background: #357abd;
            transform: scale(1.1);
        }

        .panel-header {
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #2f3640;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .panel-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            background: #ffffff;
            margin: -20px -20px 20px -20px;
        }

        .panel-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: #57606f;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .panel-tab.active {
            color: #4A90B8;
            font-weight: 600;
            border-bottom-color: #4A90B8;
            background: #f8f9fa;
        }

        .panel-tab:hover:not(.active) {
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 节点详情面板样式 */
        .facility-detail {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .facility-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .facility-info h4 {
            margin: 0;
            color: #2f3640;
            font-size: 16px;
        }

        .facility-info .facility-id {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }

        .facility-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-normal { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-critical { background: #f8d7da; color: #721c24; }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .metric-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #2f3640;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
        }

        .detail-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .detail-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #4A90B8;
            background: white;
            color: #4A90B8;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .detail-btn:hover,
        .detail-btn.primary {
            background: #4A90B8;
            color: white;
        }

        /* 性能优化样式 */
        .leaflet-container {
            transform: translateZ(0);
            will-change: transform;
        }

        .leaflet-zoom-animated {
            transition: none !important;
        }

        .optimized-marker {
            will-change: transform, opacity;
            backface-visibility: hidden;
            pointer-events: auto;
        }

        .optimized-pipeline {
            will-change: opacity, stroke-width;
            pointer-events: stroke;
            vector-effect: non-scaling-stroke;
        }

        /* 渲染优化 */
        .rendering-optimized * {
            will-change: auto;
        }

        .rendering-optimized .leaflet-marker-icon,
        .rendering-optimized .leaflet-marker-shadow {
            transition: none !important;
        }

        /* 响应式 */
        @media (max-width: 1200px) {
            .left-panel:not(.collapsed) {
                width: 260px;
            }
            
            .right-panel:not(.collapsed) {
                width: 320px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .left-panel,
            .right-panel {
                width: 100% !important;
                height: 200px;
            }
            
            .time-controller {
                margin: 10px;
                padding: 10px;
            }
        }
        
        /* 图层控制 */
        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f2f6;
        }

        .layer-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .layer-checkbox {
            accent-color: #4A90B8;
        }

        .layer-name {
            font-size: 12px;
            color: #2f3640;
        }

        .layer-opacity {
            width: 60px;
            height: 4px;
            accent-color: #4A90B8;
        }

        /* 图层透明度控制样式 */
        .opacity-control-item {
            margin-bottom: 12px;
            padding: 0 15px;
        }

        .opacity-control-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            color: #333;
        }

        .opacity-value {
            font-weight: 600;
            color: #4A90B8;
            min-width: 35px;
            text-align: right;
        }

        .opacity-slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
            position: relative;
        }

        .opacity-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4A90B8;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(74, 144, 184, 0.3);
            transition: all 0.2s ease;
        }

        .opacity-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(74, 144, 184, 0.5);
        }

        .opacity-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4A90B8;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(74, 144, 184, 0.3);
        }

        .layer-icon {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }

        .layer-icon i {
            width: 14px;
            color: #4A90B8;
        }

        .opacity-reset-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            color: #6c757d;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .opacity-reset-btn:hover {
            background: #4A90B8;
            color: white;
            border-color: #4A90B8;
        }

        /* 折叠动画 */
        .section-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }

        .section-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding: 0;
        }

        .section-header i:last-child {
            transition: transform 0.3s ease;
        }

        .section-header.expanded i:last-child {
            transform: rotate(90deg);
        }

        /* 动画效果 */
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .custom-marker[data-facility-id] {
            transition: all 0.3s ease;
        }
        
        .custom-marker[data-facility-id]:hover {
            transform: scale(1.2);
        }
        
        /* 报警状态闪烁 */
        .critical-alert {
            animation: blink 1s infinite;
        }
        
        .warning-pulse {
            animation: pulse 2s infinite;
        }
        
        /* 加载动画 */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 移除鼠标跟随效果相关样式 */
        .mouse-follower {
            display: none;
        }

        /* 性能优化的样式 */
        .adaptive-marker {
            will-change: transform, opacity;
            backface-visibility: hidden;
        }
        
        .adaptive-pipeline {
            will-change: opacity, stroke-width;
        }
        
        /* 缩放时的平滑过渡 */
        .leaflet-zoom-animated {
            transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* 提升渲染性能 */
        .leaflet-container {
            transform: translateZ(0);
        }

        /* 节点视觉增强 */
        .adaptive-marker:hover {
            transform: scale(1.15) !important;
            z-index: 1000 !important;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
        }

        .adaptive-marker:hover [data-facility-id] {
            box-shadow: 0 4px 20px rgba(74, 144, 184, 0.4) !important;
        }

        /* 报警状态动效 */
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes warning-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 165, 0, 0.3); }
            50% { box-shadow: 0 0 15px rgba(255, 165, 0, 0.8); }
        }

        /* 设施类型特定样式 */
        .adaptive-marker[data-facility-id*="SIUSAIWANSEA"] > div {
            background: linear-gradient(135deg, #3498db, #2980b9) !important;
        }

        .adaptive-marker[data-facility-id*="SWSR"] > div {
            background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
        }

        .adaptive-marker[data-facility-id*="pump"] > div {
            background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
        }

        /* 管道交互效果 */
        .adaptive-pipeline:hover {
            stroke-width: 6px !important;
            opacity: 1 !important;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        /* 优化小节点显示 */
        .adaptive-marker[data-facility-id] > div {
            position: relative;
            overflow: visible;
        }

        /* 节点标签（高缩放级别显示） */
        .adaptive-marker[data-facility-id]:hover::after {
            content: attr(data-facility-id);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 1001;
            pointer-events: none;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-5px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* 地图控制按钮优化 */
        .leaflet-control-zoom a {
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        }

        .leaflet-control-zoom a:hover {
            background: #4A90B8 !important;
            color: white !important;
        }

        /* 性能优化的样式 */
        .clean-marker {
            will-change: transform;
            backface-visibility: hidden;
            pointer-events: auto;
        }
        
        .optimized-pipeline {
            will-change: opacity;
            pointer-events: auto;
        }
        
        /* 缩放时的平滑过渡 */
        .leaflet-zoom-animated {
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* 提升渲染性能 */
        .leaflet-container {
            transform: translateZ(0);
        }
        
        /* 工具栏按钮优化 */
        .toolbar-btn.active {
            background: #4A90B8;
            color: white;
            border-color: #4A90B8;
        }
        
        .toolbar-btn:not(.active) {
            opacity: 0.7;
        }
        
        /* 节点悬停效果优化 */
        .clean-marker:hover {
            transform: scale(1.1);
            transition: transform 0.15s ease;
        }
        
        /* 管道悬停效果优化 */
        .optimized-pipeline:hover {
            opacity: 1 !important;
            transition: opacity 0.15s ease;
        }

        .logout-btn {
            background: #ff6b6b !important;
            border-color: #ff6b6b !important;
            color: white !important;
            margin-left: 10px;
        }

        .logout-btn:hover {
            background: #ff5252 !important;
            border-color: #ff5252 !important;
        }

        /* 综合信息面板 */
        .info-panel {
            position: absolute;
            left: 20px;
            top: 140px;
            width: 350px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            z-index: 700;
            transition: all 0.3s ease;
        }

        .info-panel.collapsed {
            width: 50px;
        }

        .info-panel-header {
            padding: 12px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
        }

        .info-panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #2f3640;
        }

        .info-panel.collapsed .info-panel-title {
            display: none;
        }

        .collapse-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #57606f;
            transition: transform 0.3s;
        }

        .info-panel.collapsed .collapse-btn {
            transform: rotate(180deg);
        }

        .info-panel-content {
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
        }

        .info-panel.collapsed .info-panel-content {
            display: none;
        }

        /* 水量指标 */
        .water-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #4A90B8;
        }

        .stat-label {
            font-size: 11px;
            color: #57606f;
            margin-top: 4px;
        }

        /* 压力分布图 */
        .pressure-chart {
            height: 150px;
            margin: 15px 0;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
        }

        /* 当前调度方案 */
        .schedule-info {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin-top: 15px;
        }

        .schedule-title {
            font-size: 13px;
            font-weight: 600;
            color: #2f3640;
            margin-bottom: 8px;
        }

        .pump-status {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .pump-block {
            width: 20px;
            height: 20px;
            background: #e0e0e0;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pump-block.active {
            background: #2ed573;
        }

        .pump-block:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="top-nav">
        <div class="nav-left">
            <div class="system-title">
                <i class="fas fa-tint" style="color: #4A90B8; margin-right: 8px;"></i>
                在线水力模型系统 - 实时监控
            </div>
        </div>
        
        <div class="nav-center">
            <div class="mode-switch">
                <button class="mode-btn active" onclick="switchMode('realtime')">实时监控</button>
                <button class="mode-btn" onclick="switchMode('simulation')">模拟分析</button>
                <button class="mode-btn" onclick="switchMode('historical')">历史回放</button>
            </div>
        </div>
        
        <div class="nav-right">
            <button class="btn" onclick="goToDashboard()" style="margin-right: 15px;">
                <i class="fas fa-tachometer-alt"></i> 运营总览
            </button>
            <span><i class="fas fa-user" style="color: #4A90B8; margin-right: 5px;"></i>调度员 - 张工</span>
            <span>|</span>
            <span><i class="fas fa-circle" style="color: #2ed573; margin-right: 5px;"></i>在线</span>
            <span>|</span>
            <span>香港咸水管网</span>
            <span>|</span>
            <span id="currentTime">2024-01-15 14:30:25</span>
            <span>|</span>
            <a href="login.html" class="btn logout-btn" onclick="return confirm('确定要退出系统吗？')">
                <i class="fas fa-sign-out-alt"></i> 退出
            </a>
        </div>
    </nav>

    <!-- 时间轴控制器 -->
    <div class="time-controller">
        <div class="time-header">
            <div class="time-display" id="timeDisplay">2024年1月15日 14:30:25 <span id="latestTag" style="display:none; color:#d32f2f; font-weight:bold; margin-left:8px; animation: blink 1s infinite;">最新</span></div>
            <div class="time-info">
                <span class="data-indicator"></span>
                <span style="font-size: 12px; color: #57606f;">数据更新频率: 5分钟</span>
            </div>
        </div>
        
        <div class="time-controls">
            <div class="play-controls">
                <button class="control-btn" onclick="timeControl('backward')" title="快退">
                    <i class="fas fa-fast-backward"></i>
                </button>
                <button class="control-btn" onclick="timeControl('prev')" title="上一帧">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="control-btn" id="playBtn" onclick="timeControl('toggle')" title="播放/暂停">
                    <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" onclick="timeControl('next')" title="下一帧">
                    <i class="fas fa-step-forward"></i>
                </button>
                <button class="control-btn" onclick="timeControl('forward')" title="快进">
                    <i class="fas fa-fast-forward"></i>
                </button>
            </div>
            
            <div class="time-slider" style="position:relative;">
                <input type="range" class="slider" id="timeSlider" min="0" max="1440" value="840" 
                       oninput="updateTimeFromSlider(this.value)">
                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #95a5a6; margin-top: 4px;">
                    <span>00:00</span>
                    <span>06:00</span>
                    <span>12:00</span>
                    <span>18:00</span>
                    <span>24:00</span>
                </div>
                <div class="simulation-progress animated" id="simProgressBar"></div>
                <div id="latestDot" style="position:absolute; top:-6px; left:0; width:12px; height:12px; background:#d32f2f; border-radius:50%; border:2px solid #fff; box-shadow:0 0 8px #d32f2f; display:none;"></div>
            </div>
            
            <div class="speed-control">
                <label>播放速度:</label>
                <select id="playSpeed" onchange="setPlaySpeed(this.value)">
                    <option value="0.5">0.5x</option>
                    <option value="1" selected>1x</option>
                    <option value="2">2x</option>
                    <option value="5">5x</option>
                    <option value="10">10x</option>
                </select>
            </div>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="main-container">
        <!-- 加载指示器 -->
        <div id="loadingIndicator" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-family: 'Microsoft YaHei', sans-serif;
        ">
            <div style="
                background: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                text-align: center;
                max-width: 400px;
            ">
                <div style="
                    width: 40px;
                    height: 40px;
                    border: 4px solid #f3f3f3;
                    border-top: 4px solid #4A90B8;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                "></div>
                <h3 style="margin: 0 0 10px; color: #2f3640;">正在加载 EPANET 数据</h3>
                <p id="loadingStatus" style="margin: 0; color: #57606f; font-size: 14px;">正在读取 HK Example.inp 文件...</p>
                <div style="
                    width: 100%;
                    height: 4px;
                    background: #f1f2f6;
                    border-radius: 2px;
                    margin-top: 15px;
                    overflow: hidden;
                ">
                    <div id="loadingProgress" style="
                        width: 0%;
                        height: 100%;
                        background: linear-gradient(90deg, #4A90B8, #74b9ff);
                        border-radius: 2px;
                        transition: width 0.3s ease;
                    "></div>
                </div>
            </div>
        </div>

        <!-- 左侧菜单 -->
        <aside class="left-panel" id="leftPanel">
            <button class="panel-toggle" onclick="toggleLeftPanel()" title="折叠/展开面板">
                <i class="fas fa-chevron-left" id="leftToggleIcon"></i>
            </button>
            
            <div class="panel-section">
                <div class="section-header" onclick="toggleSection('layers')">
                    <i class="fas fa-map"></i>
                    <span>地图图层</span>
                    <i class="fas fa-chevron-right" style="margin-left: auto;"></i>
                </div>
                <div class="section-content" id="layers-section">
                    <div class="menu-item active" onclick="switchMapLayer('overview')">
                        <i class="fas fa-map"></i>
                        <span>总览视图</span>
                    </div>
                    <div class="menu-item" onclick="switchMapLayer('pressure')">
                        <i class="fas fa-gauge-high"></i>
                        <span>压力分层</span>
                    </div>
                    <div class="menu-item" onclick="switchMapLayer('flow')">
                        <i class="fas fa-water"></i>
                        <span>流量分层</span>
                    </div>
                    <div class="menu-item" onclick="switchMapLayer('quality')">
                        <i class="fas fa-flask"></i>
                        <span>水质分层</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-header" onclick="toggleSection('facilities')">
                    <i class="fas fa-cogs"></i>
                    <span>监控设施</span>
                    <i class="fas fa-chevron-right" style="margin-left: auto;"></i>
                </div>
                <div class="section-content" id="facilities-section">
                    <div class="menu-item" onclick="filterFacilities('pump_station')">
                        <i class="fas fa-industry"></i>
                        <span>泵站 (<span id="pump-count">3</span>)</span>
                    </div>
                    <div class="menu-item" onclick="filterFacilities('reservoir')">
                        <i class="fas fa-water"></i>
                        <span>水库 (<span id="reservoir-count">1</span>)</span>
                    </div>
                    <div class="menu-item" onclick="filterFacilities('tank')">
                        <i class="fas fa-oil-can"></i>
                        <span>水塔 (<span id="tank-count">1</span>)</span>
                    </div>
                    <div class="menu-item" onclick="filterFacilities('junction')">
                        <i class="fas fa-circle"></i>
                        <span>节点 (<span id="junction-count">50+</span>)</span>
                    </div>
                    <div class="menu-item" onclick="filterFacilities('valve')">
                        <i class="fas fa-adjust"></i>
                        <span>阀门 (<span id="valve-count">15</span>)</span>
                    </div>
                    <div class="menu-item" onclick="filterFacilities('all')">
                        <i class="fas fa-list"></i>
                        <span>全部设施 (<span id="total-count">70+</span>)</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-header" onclick="toggleSection('alarms')">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>报警状态</span>
                    <i class="fas fa-chevron-right" style="margin-left: auto;"></i>
                </div>
                <div class="section-content" id="alarms-section">
                    <div class="menu-item" onclick="filterByAlarm('critical')">
                        <i class="fas fa-exclamation-triangle" style="color: #ff3838;"></i>
                        <span>严重报警 (<span id="critical-count">0</span>)</span>
                    </div>
                    <div class="menu-item" onclick="filterByAlarm('warning')">
                        <i class="fas fa-exclamation-circle" style="color: #ffa502;"></i>
                        <span>预警 (<span id="warning-count">0</span>)</span>
                    </div>
                    <div class="menu-item" onclick="filterByAlarm('maintenance')">
                        <i class="fas fa-tools" style="color: #747d8c;"></i>
                        <span>维护中 (<span id="maintenance-count">0</span>)</span>
                    </div>
                    <div class="menu-item" onclick="filterByAlarm('normal')">
                        <i class="fas fa-check-circle" style="color: #2ed573;"></i>
                        <span>正常 (<span id="normal-count">0</span>)</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-header" onclick="toggleSection('opacity')">
                    <i class="fas fa-layer-group"></i>
                    <span>图层透明度</span>
                    <i class="fas fa-chevron-right" style="margin-left: auto;"></i>
                </div>
                <div class="section-content" id="opacity-section">
                    <div class="opacity-control-item">
                        <div class="opacity-control-label">
                            <span class="layer-icon">
                                <i class="fas fa-water"></i>
                                设施图层
                            </span>
                            <span class="opacity-value" id="facilityOpacityValue">100%</span>
                        </div>
                        <input type="range" id="facilityOpacitySlider" class="opacity-slider" 
                               min="0" max="100" value="100" 
                               oninput="updateLayerOpacity('facility', this.value)">
                    </div>
                    
                    <div class="opacity-control-item">
                        <div class="opacity-control-label">
                            <span class="layer-icon">
                                <i class="fas fa-minus"></i>
                                管道图层
                            </span>
                            <span class="opacity-value" id="pipelineOpacityValue">100%</span>
                        </div>
                        <input type="range" id="pipelineOpacitySlider" class="opacity-slider" 
                               min="0" max="100" value="100" 
                               oninput="updateLayerOpacity('pipeline', this.value)">
                    </div>
                    
                    <div class="opacity-control-item">
                        <div class="opacity-control-label">
                            <span class="layer-icon">
                                <i class="fas fa-map"></i>
                                底图图层
                            </span>
                            <span class="opacity-value" id="basemapOpacityValue">100%</span>
                        </div>
                        <input type="range" id="basemapOpacitySlider" class="opacity-slider" 
                               min="0" max="100" value="100" 
                               oninput="updateLayerOpacity('basemap', this.value)">
                    </div>
                    
                    <div style="margin-top: 15px; padding: 0 15px;">
                        <button class="opacity-reset-btn" onclick="resetAllOpacity()" style="width: 100%;">
                            <i class="fas fa-undo"></i> 重置所有透明度
                        </button>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-header" onclick="toggleSection('actions')">
                    <i class="fas fa-tools"></i>
                    <span>快捷操作</span>
                    <i class="fas fa-chevron-right" style="margin-left: auto;"></i>
                </div>
                <div class="section-content" id="actions-section">
                    <div class="menu-item" onclick="quickAction('emergency')">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>应急调度</span>
                    </div>
                    <div class="menu-item" onclick="quickAction('valve')">
                        <i class="fas fa-valve"></i>
                        <span>阀门控制</span>
                    </div>
                    <div class="menu-item" onclick="quickAction('simulation')">
                        <i class="fas fa-calculator"></i>
                        <span>模拟计算</span>
                    </div>
                    <div class="menu-item" onclick="quickAction('export')">
                        <i class="fas fa-download"></i>
                        <span>数据导出</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 地图容器 -->
        <main class="map-container">
            <div id="map"></div>
            
            <!-- 综合信息面板 -->
            <div class="info-panel" id="infoPanel">
                <div class="info-panel-header" onclick="toggleInfoPanel()">
                    <span class="info-panel-title">综合信息</span>
                    <button class="collapse-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <div class="info-panel-content">
                    <!-- 水量指标 -->
                    <div class="water-stats">
                        <div class="stat-card">
                            <div class="stat-value">2467</div>
                            <div class="stat-label">昨日供水量(m³)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">673</div>
                            <div class="stat-label">今日实时供水量(m³)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">2099</div>
                            <div class="stat-label">今日预测供水量(m³)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">32%</div>
                            <div class="stat-label">实际占预测比例</div>
                        </div>
                    </div>
                    
                    <!-- 压力分布图 -->
                    <div class="pressure-chart" id="pressureChart">
                        <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px;">压力分布</div>
                        <canvas id="pressureCanvas" width="320" height="130"></canvas>
                    </div>
                    
                    <!-- 当前调度方案 -->
                    <div class="schedule-info">
                        <div class="schedule-title">当前调度方案</div>
                        <div style="margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 12px;">西泵站</span>
                                <div class="pump-status">
                                    <div class="pump-block active" title="00:00-06:00"></div>
                                    <div class="pump-block active" title="06:00-12:00"></div>
                                    <div class="pump-block" title="12:00-18:00"></div>
                                    <div class="pump-block active" title="18:00-24:00"></div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 12px;">东泵站</span>
                                <div class="pump-status">
                                    <div class="pump-block" title="00:00-06:00"></div>
                                    <div class="pump-block active" title="06:00-12:00"></div>
                                    <div class="pump-block active" title="12:00-18:00"></div>
                                    <div class="pump-block" title="18:00-24:00"></div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px;">北泵站</span>
                                <div class="pump-status">
                                    <div class="pump-block active" title="00:00-06:00"></div>
                                    <div class="pump-block" title="06:00-12:00"></div>
                                    <div class="pump-block active" title="12:00-18:00"></div>
                                    <div class="pump-block active" title="18:00-24:00"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 地图工具栏 -->
            <div class="map-toolbar">
                <button class="toolbar-btn active" onclick="setMapMode('pan')" title="平移">
                    <i class="fas fa-hand-paper"></i>
                </button>
                <button class="toolbar-btn" onclick="setMapMode('measure')" title="测量">
                    <i class="fas fa-ruler"></i>
                </button>
                <button class="toolbar-btn" onclick="setMapMode('select')" title="选择">
                    <i class="fas fa-mouse-pointer"></i>
                </button>
                <!-- 添加图层控制按钮 -->
                <div style="border-left: 1px solid #ddd; margin: 0 5px; height: 20px;"></div>
                <button class="toolbar-btn active" id="nodeLayerBtn" onclick="toggleNodeLayer()" title="显示/隐藏节点">
                    <i class="fas fa-circle"></i>
                </button>
                <button class="toolbar-btn active" id="pipeLayerBtn" onclick="togglePipeLayer()" title="显示/隐藏管道">
                    <i class="fas fa-minus"></i>
                </button>
                <div style="border-left: 1px solid #ddd; margin: 0 5px; height: 20px;"></div>
                <button class="toolbar-btn" onclick="toggleFullscreen()" title="全屏">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="toolbar-btn" onclick="resetView()" title="重置视图">
                    <i class="fas fa-home"></i>
                </button>
            </div>

            <!-- 对比模式控制 -->
            <div class="compare-mode">
                <div class="compare-toggle">
                    <span>对比模式</span>
                    <div class="toggle-switch" id="compareToggle" onclick="toggleCompareMode()"></div>
                </div>
            </div>
            

        </main>

        <!-- 右侧面板 -->
        <aside class="right-panel" id="rightPanel">
            <button class="right-panel-toggle" onclick="toggleRightPanel()" title="折叠/展开面板">
                <i class="fas fa-chevron-right" id="rightToggleIcon"></i>
            </button>
            
            <div class="panel-header">
                <h3 class="panel-title" id="panelTitle">属性面板</h3>
            </div>
            
            <div class="panel-content">
                <div class="panel-tabs">
                    <button class="panel-tab active" onclick="switchTab('properties')">属性</button>
                    <button class="panel-tab" onclick="switchTab('layers')">图层</button>
                    <button class="panel-tab" onclick="switchTab('analysis')">分析</button>
                </div>
                
                <!-- 属性面板 -->
                <div id="propertiesPanel" class="tab-content active">
                    <div id="selectedFacility" style="display: none;">
                        <!-- 选中设施的详细信息将在这里显示 -->
                    </div>
                    
                    <div id="noSelection" style="text-align: center; padding: 40px 20px; color: #6c757d;">
                        <i class="fas fa-mouse-pointer" style="font-size: 32px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 14px;">点击地图上的设施查看详细信息</p>
                        <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.7;">支持节点、泵站、水库、管道等</p>
                    </div>
                </div>

                <!-- 图层面板 -->
                <div id="layersPanel" class="tab-content">
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #495057;">显示控制</h4>
                        <div class="layer-item">
                            <div class="layer-info">
                                <input type="checkbox" class="layer-checkbox" checked onchange="toggleNodeLayer()">
                                <i class="fas fa-circle" style="color: #4A90B8; margin-right: 5px;"></i>
                                <span class="layer-name">节点</span>
                            </div>
                            <input type="range" class="layer-opacity" min="0" max="100" value="100">
                        </div>
                        
                        <div class="layer-item">
                            <div class="layer-info">
                                <input type="checkbox" class="layer-checkbox" checked onchange="togglePipeLayer()">
                                <i class="fas fa-minus" style="color: #2c5aa0; margin-right: 5px;"></i>
                                <span class="layer-name">管道</span>
                            </div>
                            <input type="range" class="layer-opacity" min="0" max="100" value="80">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #495057;">设施类型</h4>
                        <div class="layer-item">
                            <div class="layer-info">
                                <input type="checkbox" class="layer-checkbox" checked>
                                <i class="fas fa-industry" style="color: #9b59b6; margin-right: 5px;"></i>
                                <span class="layer-name">泵站</span>
                            </div>
                        </div>
                        
                        <div class="layer-item">
                            <div class="layer-info">
                                <input type="checkbox" class="layer-checkbox" checked>
                                <i class="fas fa-water" style="color: #3498db; margin-right: 5px;"></i>
                                <span class="layer-name">水库</span>
                            </div>
                        </div>
                        
                        <div class="layer-item">
                            <div class="layer-info">
                                <input type="checkbox" class="layer-checkbox" checked>
                                <i class="fas fa-oil-can" style="color: #e74c3c; margin-right: 5px;"></i>
                                <span class="layer-name">水塔</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #495057;">数据图层</h4>
                        <div class="layer-item">
                            <div class="layer-info">
                                <input type="checkbox" class="layer-checkbox">
                                <i class="fas fa-chart-area" style="color: #f39c12; margin-right: 5px;"></i>
                                <span class="layer-name">压力等值线</span>
                            </div>
                            <input type="range" class="layer-opacity" min="0" max="100" value="60">
                        </div>
                        
                        <div class="layer-item">
                            <div class="layer-info">
                                <input type="checkbox" class="layer-checkbox">
                                <i class="fas fa-arrow-right" style="color: #27ae60; margin-right: 5px;"></i>
                                <span class="layer-name">流向箭头</span>
                            </div>
                            <input type="range" class="layer-opacity" min="0" max="100" value="70">
                        </div>
                    </div>
                </div>

                <!-- 分析面板 -->
                <div id="analysisPanel" class="tab-content">
                    <div id="analysisContent" style="text-align: center; padding: 40px 20px; color: #6c757d;">
                        <i class="fas fa-chart-line" style="font-size: 32px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 14px;">选择设施或管道查看分析结果</p>
                        <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.7;">包括趋势图、水力分析等</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 定义香港 1980 Grid 坐标系统投影参数 (使用香港测绘处官方推荐的高精度7参数)
        // 参考: geodetic.gov.hk 和 epsg.io/2326 (EPSG 1825/15964)
        // ✅ ArcGIS同款坐标转换管线：+axis=ne 处理轴序 + EPSG:4326 启用七参数1825
proj4.defs('EPSG:2326',
  '+proj=tmerc +lat_0=22.31213333333334 +lon_0=114.178555555556 ' +
  '+k=1 +x_0=836694.05 +y_0=819069.8 +ellps=intl +axis=ne ' +
  '+towgs84=-162.619,-276.959,-161.764,0,0,0,0 +units=m +no_defs');
        
        // 全局变量
        let map;
        let facilityData = [];
        let pipelineData = [];
        let currentMode = 'realtime';
        let isPlaying = false;
        let playInterval;
        let currentTime = new Date();
        let timeRange = 'today';
        let compareMode = false;
        
        // 图层控制状态
        let showNodes = true;
        let showPipes = true;
        let facilityLayerGroup = null;
        let pipelineLayerGroup = null;
        
        // 图层透明度控制
        let layerOpacity = {
            facility: 1.0,
            pipeline: 1.0,
            basemap: 1.0
        };
        
        let currentTileLayer = null; // 存储当前的底图图层
        
        // 性能优化变量
        let isRendering = false;
        let renderQueue = [];

        // 初始化应用
        async function initializeApp() {
            initMap();
            await loadEPANETData();
            updateTime();
            setInterval(updateTime, 1000);
            
            // 绘制压力分布图
            setTimeout(drawPressureChart, 100);
        }

        // 初始化地图（使用灰色风格）
        function initMap() {
            map = L.map('map').setView([22.3193, 114.1694], 11);
            
            // ✅ 使用标准Web Mercator (EPSG:3857) 底图，与ArcGIS Pro完全一致
            currentTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© CARTO (EPSG:3857)',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
        }

        // 加载真实EPANET数据
        async function loadEPANETData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingStatus = document.getElementById('loadingStatus');
            const loadingProgress = document.getElementById('loadingProgress');
            
            // 尝试不同的文件名 - 优先使用不含空格的版本
            const fileNames = [
                { name: 'HKExample.txt', encoded: 'HKExample.txt' },
                { name: 'HKExample.inp', encoded: 'HKExample.inp' },
                { name: 'HK Example.txt', encoded: 'HK%20Example.txt' },
                { name: 'HK Example.inp', encoded: 'HK%20Example.inp' }
            ];
            let inpText = null;
            let loadedFileName = '';
            
            try {
                updateLoadingStatus('正在读取 EPANET 数据文件...', 10);
                console.log('开始尝试读取文件...');
                
                // 尝试读取不同格式的文件
                for (const file of fileNames) {
                    try {
                        updateLoadingStatus(`正在尝试读取 ${file.name}...`, 15);
                        console.log(`尝试读取文件: ${file.name}`);
                        
                        const response = await fetch(file.encoded, {
                            method: 'GET',
                            headers: {
                                'Cache-Control': 'no-cache'
                            }
                        });
                        
                        console.log(`文件 ${file.name} 响应状态: ${response.status} ${response.statusText}`);
                        console.log(`响应头:`, response.headers);
                        
                        if (response.ok) {
                            console.log(`开始读取文件内容: ${file.name}`);
                            inpText = await response.text();
                            loadedFileName = file.name;
                            console.log(`成功读取文件: ${file.name}, 文件大小: ${inpText.length} 字符`);
                            console.log(`文件前100个字符:`, inpText.substring(0, 100));
                            break;
                        } else {
                            console.error(`HTTP错误: ${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        console.error(`读取 ${file.name} 时发生错误:`, error);
                        console.error(`错误详情: ${error.name}: ${error.message}`);
                        continue;
                    }
                }
                
                if (!inpText) {
                    throw new Error('无法读取任何EPANET数据文件 (.txt 或 .inp)');
                }
                
                updateLoadingStatus(`文件 ${loadedFileName} 读取成功，开始解析数据...`, 30);
                
                updateLoadingStatus('正在解析节点和坐标信息...', 50);
                
                // 解析 .inp 文件
                console.log('开始解析INP文件...');
                const parsedData = parseINPFile(inpText);
                
                console.log(`解析结果: ${parsedData.nodes.length} 个节点, ${parsedData.pipes.length} 条管道`);
                
                if (parsedData.nodes.length === 0) {
                    console.warn('警告: 没有解析到任何节点数据');
                    throw new Error('INP文件解析失败: 没有找到有效的节点数据');
                }
                
                updateLoadingStatus('正在转换坐标系统...', 70);
                
                // 生成设施数据（使用真实坐标）
                facilityData = parsedData.nodes.map(node => {
                    // 使用真实坐标转换为 WGS84
                    const [lng, lat] = convertEPSG2326ToWGS84(node.x, node.y);
                    
                    console.log(`节点 ${node.id}: 原坐标(${node.x}, ${node.y}) -> WGS84(${lng.toFixed(6)}, ${lat.toFixed(6)})`);
                    
                    const facility = {
                        id: node.id,
                        name: node.id,
                        lat: lat,
                        lng: lng,
                        type: node.type,
                        elevation: node.elev,
                        pressure: generateRealisticPressure(node.elev, node.type),
                        flow: generateRealisticFlow(node.type),
                        status: generateAlarmStatus(node.type),
                        waterQuality: generateWaterQuality(),
                        temperature: generateTemperature(),
                        vibration: node.type === 'pump_station' ? generateVibration() : null,
                        powerStatus: node.type === 'pump_station' ? 'normal' : null
                    };
                    
                    // 为特殊类型添加额外属性
                    if (node.type === 'tank') {
                        facility.tankLevel = node.initLevel || 2.69;
                        facility.tankCapacity = node.maxLevel ? Math.PI * Math.pow(node.diameter/2, 2) * node.maxLevel : 1000;
                    }
                    if (node.type === 'reservoir') {
                        facility.head = node.head || node.elev;
                    }
                    
                    return facility;
                });
                
                updateLoadingStatus('正在生成管道网络...', 85);
                
                // 生成管道数据（使用解析的管道信息）
                pipelineData = parsedData.pipes.map(pipe => ({
                    id: pipe.id,
                    from: pipe.from,
                    to: pipe.to,
                    length: pipe.length,
                    diameter: pipe.diameter,
                    roughness: pipe.roughness,
                    flowRate: Math.random() * 200 + 50,
                    pressure: Math.random() * 0.5 + 0.2,
                    status: Math.random() > 0.1 ? 'normal' : 'warning'
                }));
                
                updateLoadingStatus('正在渲染地图...', 95);
                
                displayFacilities();
                
                updateLoadingStatus(`成功加载 ${facilityData.length} 个节点和 ${pipelineData.length} 条管道 (来源: ${loadedFileName})`, 100);
                
                // 延迟隐藏加载指示器
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                }, 1500);
                
                // 统计折点信息
                const pipesWithVertices = pipelineData.filter(pipe => pipe.vertices && pipe.vertices.length > 0);
                const totalVertices = pipelineData.reduce((sum, pipe) => sum + (pipe.vertices ? pipe.vertices.length : 0), 0);
                
                console.log(`EPANET 数据加载完成: ${facilityData.length} 个节点, ${pipelineData.length} 条管道 (文件: ${loadedFileName})`);
                console.log(`折点统计: ${pipesWithVertices.length} 条管道包含 ${totalVertices} 个折点`);
                
                if (pipesWithVertices.length > 0) {
                    console.log(`折点分布: 平均每条管道 ${(totalVertices / pipesWithVertices.length).toFixed(1)} 个折点`);
                }
                
            } catch (error) {
                console.error('读取 EPANET 文件失败:', error);
                console.error('错误堆栈:', error.stack);
                updateLoadingStatus(`文件读取失败: ${error.message}，使用默认数据...`, 50);
                
                // 回退到原来的模拟数据
                setTimeout(() => {
                    loadFallbackData();
                    loadingIndicator.style.display = 'none';
                }, 2000);
            }
        }
        
        // 更新加载状态
        function updateLoadingStatus(message, progress) {
            const loadingStatus = document.getElementById('loadingStatus');
            const loadingProgress = document.getElementById('loadingProgress');
            
            if (loadingStatus) {
                loadingStatus.textContent = message;
            }
            if (loadingProgress) {
                loadingProgress.style.width = `${progress}%`;
            }
        }
        
        // 解析 INP 文件
        function parseINPFile(inpText) {
            const lines = inpText.split('\n');
            const nodes = [];
            const pipes = [];
            const coordinates = {};
            const vertices = {}; // 存储管道折点信息
            
            let currentSection = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // 跳过空行和注释
                if (!line || line.startsWith(';')) continue;
                
                // 检查段标题
                if (line.startsWith('[') && line.endsWith(']')) {
                    currentSection = line.toLowerCase();
                    continue;
                }
                
                // 解析不同段的数据
                switch (currentSection) {
                    case '[junctions]':
                        parseJunctionLine(line, nodes);
                        break;
                    case '[reservoirs]':
                        parseReservoirLine(line, nodes);
                        break;
                    case '[tanks]':
                        parseTankLine(line, nodes);
                        break;
                    case '[pipes]':
                        parsePipeLine(line, pipes);
                        break;
                    case '[coordinates]':
                        parseCoordinateLine(line, coordinates);
                        break;
                    case '[vertices]':
                        parseVertexLine(line, vertices);
                        break;
                }
            }
            
            // 将坐标信息添加到节点
            nodes.forEach(node => {
                if (coordinates[node.id]) {
                    node.x = coordinates[node.id].x;
                    node.y = coordinates[node.id].y;
                } else {
                    // 如果没有坐标，使用随机坐标作为后备
                    node.x = 842000 + Math.random() * 2000;
                    node.y = 814000 + Math.random() * 2000;
                }
            });
            
            // 将折点信息添加到管道并验证顺序
            pipes.forEach(pipe => {
                if (vertices[pipe.id]) {
                    pipe.vertices = sortAndValidateVertices(pipe, vertices[pipe.id], coordinates);
                    
                    // 输出调试信息
                    if (pipe.vertices && pipe.vertices.length > 0) {
                        console.log(`管道 ${pipe.id}: ${pipe.vertices.length}个折点已排序`);
                    }
                }
            });
            
            return { nodes, pipes, vertices };
        }
        
        // 解析节点行
        function parseJunctionLine(line, nodes) {
            const parts = line.split(/\s+/);
            if (parts.length >= 2) {
                nodes.push({
                    id: parts[0],
                    type: 'junction',
                    elev: parseFloat(parts[1]) || 0,
                    demand: parseFloat(parts[2]) || 0
                });
            }
        }
        
        // 解析水库行
        function parseReservoirLine(line, nodes) {
            const parts = line.split(/\s+/);
            if (parts.length >= 2) {
                nodes.push({
                    id: parts[0],
                    type: 'reservoir',
                    elev: parseFloat(parts[1]) || 0,
                    head: parseFloat(parts[1]) || 0
                });
            }
        }
        
        // 解析水塔行
        function parseTankLine(line, nodes) {
            const parts = line.split(/\s+/);
            if (parts.length >= 4) {
                nodes.push({
                    id: parts[0],
                    type: 'tank',
                    elev: parseFloat(parts[1]) || 0,
                    initLevel: parseFloat(parts[2]) || 0,
                    minLevel: parseFloat(parts[3]) || 0,
                    maxLevel: parseFloat(parts[4]) || 0,
                    diameter: parseFloat(parts[5]) || 0
                });
            }
        }
        
        // 解析管道行
        function parsePipeLine(line, pipes) {
            const parts = line.split(/\s+/);
            if (parts.length >= 6) {
                pipes.push({
                    id: parts[0],
                    from: parts[1],
                    to: parts[2],
                    length: parseFloat(parts[3]) || 0,
                    diameter: parseFloat(parts[4]) || 0,
                    roughness: parseFloat(parts[5]) || 0
                });
            }
        }
        
        // 解析坐标行
        function parseCoordinateLine(line, coordinates) {
            const parts = line.split(/\s+/);
            if (parts.length >= 3) {
                coordinates[parts[0]] = {
                    x: parseFloat(parts[1]),
                    y: parseFloat(parts[2])
                };
            }
        }
        
        // 解析折点行 - VERTICES段格式: PipeID X-Coord Y-Coord
        function parseVertexLine(line, vertices) {
            const parts = line.split(/\s+/);
            if (parts.length >= 3) {
                const pipeId = parts[0];
                const vertex = {
                    x: parseFloat(parts[1]),
                    y: parseFloat(parts[2])
                };
                
                // 如果管道已有折点，添加到数组中；否则创建新数组
                if (!vertices[pipeId]) {
                    vertices[pipeId] = [];
                }
                vertices[pipeId].push(vertex);
            }
        }
        
        // 计算两点之间的距离
        function getDistance(point1, point2) {
            const dx = point1.x - point2.x;
            const dy = point1.y - point2.y;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // 计算三点之间的角度（度数）
        function getAngle(p1, p2, p3) {
            const v1x = p1.x - p2.x;
            const v1y = p1.y - p2.y;
            const v2x = p3.x - p2.x;
            const v2y = p3.y - p2.y;
            
            const dot = v1x * v2x + v1y * v2y;
            const det = v1x * v2y - v1y * v2x;
            const angle = Math.atan2(det, dot) * 180 / Math.PI;
            
            return angle < 0 ? angle + 360 : angle;
        }
        
        // 判断并修正折点顺序的主函数
        function sortAndValidateVertices(pipe, vertices, coordinates) {
            if (!vertices || vertices.length <= 1) return vertices;
            
            const fromCoord = coordinates[pipe.from];
            const toCoord = coordinates[pipe.to];
            
            if (!fromCoord || !toCoord) {
                console.warn(`管道 ${pipe.id} 缺少起点或终点坐标信息`);
                return vertices;
            }
            
            // 方法1: 距离递增验证
            let sortedVertices = sortByDistanceFromStart(vertices, fromCoord);
            
            // 方法2: 验证路径合理性
            if (!isPathReasonable(fromCoord, sortedVertices, toCoord)) {
                console.log(`管道 ${pipe.id} 距离排序不合理，尝试最优路径排序...`);
                sortedVertices = findOptimalPath(fromCoord, vertices, toCoord);
            }
            
            // 方法3: 验证角度连续性
            if (!hasReasonableAngles(fromCoord, sortedVertices, toCoord)) {
                console.log(`管道 ${pipe.id} 存在急转弯，进行平滑处理...`);
                sortedVertices = smoothPath(fromCoord, sortedVertices, toCoord);
            }
            
            return sortedVertices;
        }
        
        // 按照到起点距离排序
        function sortByDistanceFromStart(vertices, startPoint) {
            return vertices
                .map(vertex => ({
                    ...vertex,
                    distanceFromStart: getDistance(startPoint, vertex)
                }))
                .sort((a, b) => a.distanceFromStart - b.distanceFromStart)
                .map(v => ({x: v.x, y: v.y}));
        }
        
        // 验证路径是否合理（长度不应过分超过直线距离）
        function isPathReasonable(startPoint, vertices, endPoint) {
            const pathPoints = [startPoint, ...vertices, endPoint];
            let totalLength = 0;
            
            for (let i = 1; i < pathPoints.length; i++) {
                totalLength += getDistance(pathPoints[i-1], pathPoints[i]);
            }
            
            const directLength = getDistance(startPoint, endPoint);
            const reasonableRatio = totalLength / directLength;
            
            // 折线路径应该在直线距离的1.0到2.5倍之间
            return reasonableRatio >= 1.0 && reasonableRatio <= 2.5;
        }
        
        // 使用最近邻算法找到最优路径
        function findOptimalPath(startPoint, vertices, endPoint) {
            if (vertices.length <= 1) return vertices;
            
            const unvisited = [...vertices];
            const path = [];
            let currentPoint = startPoint;
            
            while (unvisited.length > 0) {
                // 找到距离当前点最近的未访问折点
                let nearestIndex = 0;
                let nearestDistance = getDistance(currentPoint, unvisited[0]);
                
                for (let i = 1; i < unvisited.length; i++) {
                    const distance = getDistance(currentPoint, unvisited[i]);
                    if (distance < nearestDistance) {
                        nearestDistance = distance;
                        nearestIndex = i;
                    }
                }
                
                // 将最近的点添加到路径中
                const nearestPoint = unvisited.splice(nearestIndex, 1)[0];
                path.push(nearestPoint);
                currentPoint = nearestPoint;
            }
            
            // 验证路径是否朝向终点
            if (path.length > 0) {
                const lastVertex = path[path.length - 1];
                const distanceToEnd = getDistance(lastVertex, endPoint);
                const distanceStartToEnd = getDistance(startPoint, endPoint);
                
                // 如果最后一个折点距离终点太远，可能需要反转路径
                if (distanceToEnd > distanceStartToEnd * 0.8) {
                    console.log(`管道路径可能需要反转`);
                    return path.reverse();
                }
            }
            
            return path;
        }
        
        // 检查路径是否有合理的角度（避免急转弯）
        function hasReasonableAngles(startPoint, vertices, endPoint) {
            if (vertices.length === 0) return true;
            
            const pathPoints = [startPoint, ...vertices, endPoint];
            
            for (let i = 1; i < pathPoints.length - 1; i++) {
                const angle = getAngle(pathPoints[i-1], pathPoints[i], pathPoints[i+1]);
                
                // 检查是否有过于尖锐的角度（小于45度或大于315度表示急转弯）
                if ((angle > 0 && angle < 45) || (angle > 315 && angle < 360)) {
                    return false;
                }
            }
            
            return true;
        }
        
        // 路径平滑处理（减少急转弯）
        function smoothPath(startPoint, vertices, endPoint) {
            if (vertices.length <= 1) return vertices;
            
            const smoothed = [];
            const pathPoints = [startPoint, ...vertices, endPoint];
            
            // 使用简单的平滑算法：移除造成急转弯的点
            for (let i = 1; i < pathPoints.length - 1; i++) {
                const prevPoint = pathPoints[i-1];
                const currentPoint = pathPoints[i];
                const nextPoint = pathPoints[i+1];
                
                const angle = getAngle(prevPoint, currentPoint, nextPoint);
                
                // 只保留转角合理的点
                if (angle >= 45 && angle <= 315) {
                    if (i < pathPoints.length - 1) { // 不包括终点
                        smoothed.push(currentPoint);
                    }
                }
            }
            
            return smoothed;
        }
        
        // 回退数据（当文件读取失败时使用）
        function loadFallbackData() {
            console.log('使用回退数据...');
            // 这里是原来的硬编码数据作为后备
            const junctions = [
                {id: 'S00145-11SE14B', elev: 5.34},
                {id: 'S01097-11SE19A', elev: 43.65},
                {id: 'S00027-11SE14A', elev: 5.39},
                {id: 'S00036-11SE14C', elev: 7.45},
                {id: 'S01125-11SE19B', elev: 3.9},
                {id: 'S01142-11SE19A', elev: 8.25},
                {id: 'S00166-11SE19C', elev: 69.51},
                {id: 'S00321-11SE19B', elev: 3.98},
                {id: 'S00008-11SE19A', elev: 53.09},
                {id: 'S00136-11SE19C', elev: 39.1}
            ];
            const reservoirs = [
                {id: 'SIUSAIWANSEA', head: 1.3}
            ];
            const tanks = [
                {id: 'SWSR-CHAIWAN', elev: 66.22, initLevel: 2.69, minLevel: 1, maxLevel: 5.41, diameter: 33.1}
            ];
            
            const allNodes = [
                ...junctions.map(j => ({...j, type: 'junction'})),
                ...reservoirs.map(r => ({id: r.id, elev: r.head, type: 'reservoir', head: r.head})),
                ...tanks.map(t => ({id: t.id, elev: t.elev, type: 'tank', ...t}))
            ];
            
            facilityData = allNodes.map(node => {
                const [lng, lat] = convertEPSG2326ToWGS84(842000 + Math.random()*2000, 814000 + Math.random()*2000);
                const facility = {
                    id: node.id,
                    name: node.id,
                    lat: lat,
                    lng: lng,
                    type: node.type,
                    elevation: node.elev,
                    pressure: generateRealisticPressure(node.elev, node.type),
                    flow: generateRealisticFlow(node.type),
                    status: generateAlarmStatus(node.type),
                    waterQuality: generateWaterQuality(),
                    temperature: generateTemperature(),
                    vibration: node.type === 'pump_station' ? generateVibration() : null,
                    powerStatus: node.type === 'pump_station' ? 'normal' : null
                };
                if (node.type === 'tank') {
                    facility.tankLevel = node.initLevel;
                    facility.tankCapacity = Math.PI * Math.pow(node.diameter/2, 2) * node.maxLevel;
                }
                if (node.type === 'reservoir') {
                    facility.head = node.head;
                }
                return facility;
            });
            
            pipelineData = []; // 简化的管道数据
            displayFacilities();
        }

        // 坐标转换 - 使用ArcGIS同款转换管线
        function convertEPSG2326ToWGS84(x, y) {
            // ✅ 香港 1980 Grid 坐标系统 (EPSG:2326) 转换到 WGS84
            // 输入：x=Easting, y=Northing，+axis=ne 已正确定义轴序
            // 使用 EPSG:4326 而非 "WGS84" 以启用七参数转换
            try {
                const [lng, lat] = proj4("EPSG:2326", "EPSG:4326", [x, y]);
                return [lng, lat];
            } catch (error) {
                console.error('坐标转换错误:', error, 'x:', x, 'y:', y);
                // 降级到原有的简化转换方法
                const deltaE = x - 836694.05;
                const deltaN = y - 819069.8;
                const metersPerDegLng = 111000 * Math.cos(22.312133333334 * Math.PI / 180);
            const metersPerDegLat = 111000;
                const lng = 114.178555555556 + (deltaE / metersPerDegLng);
                const lat = 22.312133333334 + (deltaN / metersPerDegLat);
                return [lng - 0.0008, lat + 0.0003];
            }
        }

        // 生成现实压力数据
        function generateRealisticPressure(elevation, type) {
            let basePressure;
            switch(type) {
                case 'pump_station':
                    basePressure = 0.8 - (elevation / 200);
                    break;
                case 'reservoir':
                    basePressure = 0.9 - (elevation / 150);
                    break;
                case 'tank':
                    basePressure = 0.7 - (elevation / 100);
                    break;
                default:
                    basePressure = 0.6 - (elevation / 100);
            }
            const variation = (Math.random() - 0.5) * 0.1;
            return Math.max(0.05, Math.min(1.2, basePressure + variation));
        }

        // 生成现实流量数据
        function generateRealisticFlow(type) {
            switch(type) {
                case 'pump_station': return Math.random() * 800 + 300;
                case 'reservoir': return Math.random() * 500 + 200;
                case 'tank': return Math.random() * 300 + 100;
                default: return Math.random() * 150 + 30;
            }
        }
        
        // 生成报警状态 - 更多报警类型
        function generateAlarmStatus(type) {
            const random = Math.random();
            
            // 根据设备类型设置不同的报警概率
            switch(type) {
                case 'pump_station':
                    if (random < 0.05) return 'critical';      // 严重故障
                    if (random < 0.15) return 'high_pressure'; // 高压报警
                    if (random < 0.25) return 'vibration';     // 振动异常
                    if (random < 0.35) return 'temperature';   // 温度异常
                    if (random < 0.45) return 'power';         // 电源异常
                    break;
                case 'tank':
                    if (random < 0.08) return 'overflow';      // 溢出报警
                    if (random < 0.18) return 'low_level';     // 低液位
                    if (random < 0.28) return 'high_level';    // 高液位
                    break;
                case 'reservoir':
                    if (random < 0.06) return 'contamination'; // 污染报警
                    if (random < 0.16) return 'low_level';     // 低水位
                    break;
                case 'junction':
                    if (random < 0.12) return 'low_pressure';  // 低压
                    if (random < 0.22) return 'no_flow';       // 断流
                    if (random < 0.27) return 'leak';          // 泄漏
                    break;
            }
            
            if (random < 0.75) return 'normal';
            if (random < 0.88) return 'warning';
            return 'maintenance';
        }
        
        // 生成水质数据
        function generateWaterQuality() {
            return {
                turbidity: Math.random() * 2 + 0.1,        // 浊度 NTU
                chlorine: Math.random() * 1.5 + 0.3,       // 余氯 mg/L
                ph: Math.random() * 1.5 + 6.5,             // pH值
                conductivity: Math.random() * 500 + 200,    // 电导率 μS/cm
                tds: Math.random() * 300 + 100              // 总溶解固体 mg/L
            };
        }
        
        // 生成温度数据
        function generateTemperature() {
            return Math.random() * 10 + 18; // 18-28°C
        }
        
        // 生成振动数据 (仅泵站)
        function generateVibration() {
            return {
                x: Math.random() * 2 + 0.5,
                y: Math.random() * 2 + 0.5,
                z: Math.random() * 2 + 0.5
            };
        }

        // 显示设施和管道 - 高性能版本，支持视野裁剪和聚合
        function displayFacilities() {
            // 防止重复渲染
            if (isRendering) {
                renderQueue.push('displayFacilities');
                return;
            }
            isRendering = true;
            
            try {
                // 彻底清除现有图层
                clearAllLayers();
                
                // 创建新的图层组
                facilityLayerGroup = L.layerGroup();
                pipelineLayerGroup = L.layerGroup();
                
                const zoom = map.getZoom();
                const bounds = map.getBounds();
                let nodeCount = 0;
                let pipeCount = 0;
                
                // 获取视野内的设施和管道（性能优化的核心）
                const visibleFacilities = getVisibleFacilities(bounds, zoom);
                const visiblePipelines = getVisiblePipelines(bounds, zoom);
                
                // 首先渲染管道(底层)
                if (showPipes) {
                    visiblePipelines.forEach(pipe => {
                        const polyline = createOptimizedPipeline(pipe, zoom);
                            if (polyline) {
                                pipelineLayerGroup.addLayer(polyline);
                                pipeCount++;
                        }
                    });
                    pipelineLayerGroup.addTo(map);
                }
                
                // 然后渲染节点(上层)，根据缩放级别决定是否聚合
                if (showNodes) {
                    // 更激进的聚合策略，提高性能
                    if (zoom <= 12 && visibleFacilities.length > 50) {
                        // 扩大聚合使用范围，降低数据量阈值
                        const clusters = createOptimizedClusters(visibleFacilities, zoom);
                        clusters.forEach(cluster => {
                            const marker = createClusterMarker(cluster, zoom);
                            if (marker) {
                                facilityLayerGroup.addLayer(marker);
                                nodeCount++;
                            }
                        });
                    } else {
                        // 高缩放级别或数据量小时，正常显示
                        visibleFacilities.forEach(facility => {
                            const marker = createOptimizedMarker(facility, zoom);
                            if (marker) {
                                facilityLayerGroup.addLayer(marker);
                                nodeCount++;
                        }
                    });
                    }
                    facilityLayerGroup.addTo(map);
                }
                
                // 只在第一次初始化时绑定事件
                if (!window.mapEventsBound) {
                    map.on('zoomend', onMapChanged);
                    map.on('moveend', onMapChanged);
                    window.mapEventsBound = true;
                }
                
                updateFacilityStats();
                console.log(`高性能渲染完成: ${nodeCount} 节点, ${pipeCount} 管道 (缩放: ${zoom}, 视野内设施: ${visibleFacilities.length}/${facilityData.length})`);
                
            } finally {
                isRendering = false;
                
                // 处理队列中的渲染请求
                if (renderQueue.length > 0) {
                    renderQueue = [];
                    setTimeout(() => displayFacilities(), 100);
                }
            }
        }
        
        // 彻底清除所有图层
        function clearAllLayers() {
            if (facilityLayerGroup && map.hasLayer(facilityLayerGroup)) {
                map.removeLayer(facilityLayerGroup);
                facilityLayerGroup.clearLayers();
            }
            if (pipelineLayerGroup && map.hasLayer(pipelineLayerGroup)) {
                map.removeLayer(pipelineLayerGroup);
                pipelineLayerGroup.clearLayers();
            }
            
            // 清理可能残留的标记
            map.eachLayer(layer => {
                if (layer.options && (layer.options.facilityId || layer.options.pipeId)) {
                    map.removeLayer(layer);
                }
            });
        }
        

        
        // 高性能智能过滤：根据缩放级别和设施类型决定是否显示
        function shouldShowFacility(facility, zoom) {
            // 重要设施始终显示（优先级最高）
            if (facility.type === 'reservoir' || facility.type === 'tank') {
                return true;
            }
        
            // 报警设施优先显示
            if (facility.status !== 'normal') {
                return true;
            }
            
            // 泵站在中等缩放以上显示
            if (facility.type === 'pump_station') {
                return zoom >= 8; // 降低显示阈值
            }
            
            // 普通节点根据缩放级别分层显示（更激进的过滤以支持聚合）
            if (facility.type === 'junction') {
                if (zoom < 6) {
                    return false; // 极低缩放不显示普通节点
                } else if (zoom < 8) {
                    // 极低缩放：只显示2%的节点
                    const hash = getSimpleHash(facility.id);
                    return hash % 100 < 2;
                } else if (zoom < 10) {
                    // 低缩放：显示8%的节点
                    const hash = getSimpleHash(facility.id);
                    return hash % 100 < 8;
                } else if (zoom < 12) {
                    // 中低缩放：显示25%的节点
                    const hash = getSimpleHash(facility.id);
                    return hash % 100 < 25;
                } else if (zoom < 14) {
                    // 中缩放：显示70%的节点
                    const hash = getSimpleHash(facility.id);
                    return hash % 100 < 70;
                } else {
                    // 高缩放：显示所有节点
                    return true;
                }
            }
            
            return true;
        }
        
        // 高性能智能过滤：管道显示策略
        function shouldShowPipe(pipe, zoom) {
            // 根据缩放级别和管径大幅过滤管道
            if (zoom <= 8) {
                return pipe.diameter >= 800; // 只显示主干管
            } else if (zoom <= 10) {
                return pipe.diameter >= 500; // 显示主要管道
            } else if (zoom <= 12) {
                return pipe.diameter >= 200; // 显示次干管
            } else if (zoom <= 14) {
                return pipe.diameter >= 100; // 显示大部分管道
            } else {
                return true; // 显示所有管道
            }
        }
        
        // 简单高效的哈希函数
        function getSimpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = (hash * 31 + str.charCodeAt(i)) & 0x7fffffff;
            }
            return hash;
        }
        
        // 创建优化的管道
        function createPipeline(pipe, zoom) {
            const fromFacility = facilityData.find(f => f.id === pipe.from);
            const toFacility = facilityData.find(f => f.id === pipe.to);
            
            if (!fromFacility || !toFacility) return null;
            
            const fromLatLng = [fromFacility.lat, fromFacility.lng];
            const toLatLng = [toFacility.lat, toFacility.lng];
            
            // 根据缩放级别调整线宽，更细的线条
            let weight = Math.max(1, Math.min(4, pipe.diameter / 150));
            if (zoom <= 10) weight *= 0.4;
            else if (zoom <= 12) weight *= 0.6;
            else if (zoom <= 14) weight *= 0.8;
            
            const color = getPipelineColor(pipe.status, pipe.diameter);
            const opacity = zoom <= 10 ? 0.5 : 0.7;
            
            const polyline = L.polyline([fromLatLng, toLatLng], {
                color: color,
                weight: weight,
                opacity: opacity,
                className: 'optimized-pipeline',
                pipeId: pipe.id
            });
            
            // 只在高缩放级别添加弹窗
            if (zoom > 13) {
                polyline.bindPopup(createPipelinePopup(pipe));
            }
            
            return polyline;
        }
        
        // 创建优化的节点标记
        function createOptimizedMarker(facility, zoom) {
            const icon = createCleanIcon(facility, zoom);
            const marker = L.marker([facility.lat, facility.lng], {
                icon: icon,
                facilityId: facility.id,
                facilityType: facility.type,
                zIndexOffset: getMarkerZIndex(facility) // 控制显示层级
            });
            
            // 点击事件：在右侧面板显示详情，而不是弹窗
            marker.on('click', function() {
                showFacilityInPanel(facility);
            });
            
            // 仅在高缩放级别显示简单工具提示
            if (zoom > 13) {
                marker.bindTooltip(`${facility.name}<br/>${getFacilityTypeName(facility.type)}`, {
                    direction: 'top',
                    offset: [0, -10]
                });
            }
            
            return marker;
        }
        
        // 获取标记的Z-index以控制显示层级
        function getMarkerZIndex(facility) {
            // 重要设施显示在上层，普通节点显示在下层
            switch(facility.type) {
                case 'reservoir': return 1000;
                case 'tank': return 900;
                case 'pump_station': return 800;
                default: return 100; // 普通节点层级较低，不挡住管道
            }
        }
        
        // 创建清洁的图标（避免重复渲染）
        function createCleanIcon(facility, zoom) {
            let iconSize, fontSize, borderWidth;
            
            // 大幅减小节点尺寸，让界面更清爽
            if (zoom <= 9) {
                iconSize = facility.type === 'junction' ? 3 : 6;
                fontSize = 2;
                borderWidth = 1;
            } else if (zoom <= 11) {
                iconSize = facility.type === 'junction' ? 4 : 8;
                fontSize = 3;
                borderWidth = 1;
            } else if (zoom <= 13) {
                iconSize = facility.type === 'junction' ? 6 : 10;
                fontSize = 4;
                borderWidth = 1;
            } else if (zoom <= 15) {
                iconSize = facility.type === 'junction' ? 8 : 12;
                fontSize = 5;
                borderWidth = 1;
            } else {
                iconSize = facility.type === 'junction' ? 10 : 14;
                fontSize = 6;
                borderWidth = 2;
            }
            
            const color = getStatusColor(facility.status);
            const iconMap = {
                'pump_station': '⚡',
                'reservoir': '🌊',
                'tank': '🏗',
                'junction': '●'
            };

            const iconChar = iconMap[facility.type] || '●';
            
            // 简化样式，提升性能
            let opacity = 1;
            if (facility.type === 'junction') {
                opacity = zoom < 12 ? 0.7 : 0.9;
            }

            // 简化DOM结构，减少CSS复杂度
            return L.divIcon({
                html: `<div style="
                    width:${iconSize}px;
                    height:${iconSize}px;
                    background:${color};
                    border:${borderWidth}px solid #fff;
                    border-radius:50%;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    color:#fff;
                    font-size:${fontSize}px;
                    opacity:${opacity};
                    cursor:pointer;
                    box-shadow:0 1px 2px rgba(0,0,0,0.2);
                ">${iconChar}</div>`,
                className: 'clean-marker',
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconSize/2, iconSize/2]
            });
        }
        
        // 图层控制函数
        function toggleNodeLayer() {
            showNodes = !showNodes;
            const btn = document.getElementById('nodeLayerBtn');
            
            if (showNodes) {
                btn.classList.add('active');
                if (facilityLayerGroup) facilityLayerGroup.addTo(map);
            } else {
                btn.classList.remove('active');
                if (facilityLayerGroup && map.hasLayer(facilityLayerGroup)) {
                    map.removeLayer(facilityLayerGroup);
                }
            }
        }
        
        function togglePipeLayer() {
            showPipes = !showPipes;
            const btn = document.getElementById('pipeLayerBtn');
            
            if (showPipes) {
                btn.classList.add('active');
                if (pipelineLayerGroup) pipelineLayerGroup.addTo(map);
            } else {
                btn.classList.remove('active');
                if (pipelineLayerGroup && map.hasLayer(pipelineLayerGroup)) {
                    map.removeLayer(pipelineLayerGroup);
                }
            }
        }

        // 超高性能防抖地图变化处理
        let mapChangeRAF = null;
        let lastRenderTime = 0;
        let lastZoom = null;
        const RENDER_THROTTLE = 100; // 减少渲染间隔提升响应性
        const ZOOM_THROTTLE = 200; // 缩放变化的专用节流
        
        function onMapChanged() {
            const zoom = map.getZoom();
            const center = map.getCenter();
            const now = Date.now();
            
            // 取消之前的渲染请求
            if (mapChangeRAF) {
                cancelAnimationFrame(mapChangeRAF);
            }
            
            // 区分缩放变化和平移变化，使用不同的节流策略
            const isZoomChange = lastZoom !== null && lastZoom !== zoom;
            const throttleTime = isZoomChange ? ZOOM_THROTTLE : RENDER_THROTTLE;
            
            // 使用节流避免过度渲染
            const timeSinceLastRender = now - lastRenderTime;
            if (timeSinceLastRender < throttleTime) {
                mapChangeRAF = requestAnimationFrame(() => {
                    setTimeout(() => onMapChanged(), throttleTime - timeSinceLastRender);
                });
                return;
            }
            
            // 标记地图容器为渲染优化模式
            map.getContainer().classList.add('rendering-optimized');
            
            mapChangeRAF = requestAnimationFrame(() => {
                try {
                    displayFacilities();
                    lastRenderTime = Date.now();
                    lastZoom = zoom;
                    
                    if (isZoomChange) {
                        console.log(`地图缩放更新: ${zoom} (聚合生效: ${zoom <= 12})`);
                    }
                } finally {
                    // 渲染完成后移除优化模式
                    setTimeout(() => {
                        if (map.getContainer()) {
                            map.getContainer().classList.remove('rendering-optimized');
                        }
                    }, 50); // 减少延迟
                }
            });
        }

        // 高性能视野裁剪 - 只获取视野内的设施
        function getVisibleFacilities(bounds, zoom) {
            const paddedBounds = bounds.pad(0.1); // 添加10%的边界缓冲，避免边缘闪烁
            
            return facilityData.filter(facility => {
                // 首先检查是否在视野内
                const isInBounds = paddedBounds.contains([facility.lat, facility.lng]);
                if (!isInBounds) return false;
                
                // 然后根据缩放级别和设施类型过滤
                return shouldShowFacility(facility, zoom);
            });
        }
        
        // 高性能视野裁剪 - 只获取视野内的管道
        function getVisiblePipelines(bounds, zoom) {
            const paddedBounds = bounds.pad(0.1);
            
            return pipelineData.filter(pipe => {
                // 检查管道两端节点是否有任何一个在视野内
                const fromFacility = facilityData.find(f => f.id === pipe.from);
                const toFacility = facilityData.find(f => f.id === pipe.to);
                
                if (!fromFacility || !toFacility) return false;
                
                const fromInBounds = paddedBounds.contains([fromFacility.lat, fromFacility.lng]);
                const toInBounds = paddedBounds.contains([toFacility.lat, toFacility.lng]);
                
                // 只要有一端在视野内就显示该管道
                if (!fromInBounds && !toInBounds) return false;
                
                return shouldShowPipe(pipe, zoom);
            });
        }
        
        // 高性能优化的聚合算法
        function createOptimizedClusters(facilities, zoom) {
            const clusters = [];
            const gridSize = getClusterGridSize(zoom);
            const processed = new Set();
            
            // 按重要性排序，优先处理重要设施
            const sortedFacilities = facilities.sort((a, b) => {
                const priorityA = getFacilityPriority(a);
                const priorityB = getFacilityPriority(b);
                return priorityB - priorityA;
            });
            
            sortedFacilities.forEach(facility => {
                if (processed.has(facility.id)) return;
                
                // 创建以当前设施为中心的聚合簇
                const cluster = {
                    lat: facility.lat,
                    lng: facility.lng,
                    facilities: [facility],
                    count: 1,
                    mainType: facility.type,
                    hasAlarm: facility.status !== 'normal'
                };
                
                // 使用更高效的邻近查找算法
                const nearby = findNearbyFacilities(facility, sortedFacilities, gridSize, processed);
                cluster.facilities.push(...nearby);
                cluster.count += nearby.length;
                
                // 标记已处理
                processed.add(facility.id);
                nearby.forEach(f => processed.add(f.id));
                
                clusters.push(cluster);
            });
            
            return clusters;
        }
        
        // 获取设施优先级（重要设施优先聚合）
        function getFacilityPriority(facility) {
            let priority = 0;
            
            // 类型权重
            switch(facility.type) {
                case 'reservoir': priority += 100; break;
                case 'tank': priority += 80; break;
                case 'pump_station': priority += 60; break;
                default: priority += 10; break;
            }
            
            // 状态权重
            if (facility.status !== 'normal') {
                priority += 50;
            }
            
            return priority;
        }
        
        // 高效的邻近设施查找
        function findNearbyFacilities(centerFacility, allFacilities, gridSize, processed) {
            const nearby = [];
            const maxNearby = 20; // 限制每个聚合的最大设施数
            
            for (let i = 0; i < allFacilities.length && nearby.length < maxNearby; i++) {
                const facility = allFacilities[i];
                
                if (processed.has(facility.id) || facility.id === centerFacility.id) continue;
                
                // 快速距离计算（避免sqrt）
                const dx = facility.lat - centerFacility.lat;
                const dy = facility.lng - centerFacility.lng;
                const distanceSquared = dx * dx + dy * dy;
                
                if (distanceSquared < gridSize * gridSize) {
                    nearby.push(facility);
                }
            }
            
            return nearby;
        }
        
        // 获取聚合网格大小（根据缩放级别）- 优化版本
        function getClusterGridSize(zoom) {
            const baseSizes = {
                6: 0.025,   // 约2.5km - 更大范围聚合
                7: 0.02,    // 约2km
                8: 0.015,   // 约1.5km  
                9: 0.012,   // 约1.2km
                10: 0.008,  // 约800m
                11: 0.005,  // 约500m
                12: 0.003,  // 约300m
                13: 0.001   // 约100m
            };
            return baseSizes[zoom] || 0.0005;
        }
        
        // 计算两点之间的距离（简化版）
        function getDistance(lat1, lng1, lat2, lng2) {
            const dlat = lat2 - lat1;
            const dlng = lng2 - lng1;
            return Math.sqrt(dlat * dlat + dlng * dlng);
        }
        
        // 创建聚合标记 - 优化版本
        function createClusterMarker(cluster, zoom) {
            const count = cluster.count;
            let size = 20;
            let className = 'cluster-small';
            let backgroundColor = 'rgba(74, 144, 184, 0.8)';
            
            // 根据聚合内容调整样式
            if (cluster.hasAlarm) {
                backgroundColor = 'rgba(255, 107, 107, 0.8)'; // 红色表示有报警
            }
            
            // 根据数量调整大小
            if (count > 200) {
                size = 50;
                className = 'cluster-huge';
            } else if (count > 100) {
                size = 42;
                className = 'cluster-large';
            } else if (count > 20) {
                size = 32;
                className = 'cluster-medium';
            } else if (count > 5) {
                size = 26;
                className = 'cluster-small';
            } else {
                size = 20;
                className = 'cluster-tiny';
            }
            
            const clusterIcon = L.divIcon({
                html: `<div class="cluster-marker ${className}" style="
                    width: ${size}px;
                    height: ${size}px;
                    background: ${backgroundColor};
                    border: 2px solid white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: ${Math.max(10, size * 0.35)}px;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.4);
                    cursor: pointer;
                    transition: transform 0.2s ease;
                    z-index: 1000;
                " onmouseover="this.style.transform='scale(1.1)'" 
                   onmouseout="this.style.transform='scale(1)'">${count}</div>`,
                className: 'cluster-marker-container',
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
            
            const marker = L.marker([cluster.lat, cluster.lng], { 
                icon: clusterIcon,
                zIndexOffset: 1000 // 确保聚合标记显示在上层
            });
            
            // 聚合标记的弹窗
            marker.bindPopup(createClusterPopup(cluster));
            
            // 点击聚合标记时智能放大
            marker.on('click', () => {
                const targetZoom = Math.min(zoom + 3, 16); // 更大的放大步长
                map.setView([cluster.lat, cluster.lng], targetZoom);
            });
            
            return marker;
        }
        
        // 创建聚合弹窗
        function createClusterPopup(cluster) {
            const facilities = cluster.facilities;
            const typeCount = {};
            
            facilities.forEach(f => {
                typeCount[f.type] = (typeCount[f.type] || 0) + 1;
            });
            
            let content = `
                <div style="min-width: 200px; font-family: 'Microsoft YaHei', sans-serif;">
                    <h4 style="margin: 0 0 10px 0; color: #2D3748;">设施聚合 (${facilities.length}个)</h4>
                    <div style="font-size: 12px; line-height: 1.6;">
            `;
            
            Object.entries(typeCount).forEach(([type, count]) => {
                const typeName = getFacilityTypeName(type);
                content += `<div><strong>${typeName}:</strong> ${count}个</div>`;
            });
            
            content += `
                    </div>
                    <div style="margin-top: 8px; font-size: 11px; color: #666;">
                        点击标记放大查看详细信息
                    </div>
                </div>
            `;
            
            return content;
        }
        
        // 创建优化的管道（支持折点）
        function createOptimizedPipeline(pipe, zoom) {
            const fromFacility = facilityData.find(f => f.id === pipe.from);
            const toFacility = facilityData.find(f => f.id === pipe.to);
            
            if (!fromFacility || !toFacility) return null;
            
            const fromLatLng = [fromFacility.lat, fromFacility.lng];
            const toLatLng = [toFacility.lat, toFacility.lng];
            
            // 构建管道路径点数组（包含折点）
            const pathPoints = [fromLatLng];
            
            // 如果有折点数据，添加所有折点
            if (pipe.vertices && pipe.vertices.length > 0) {
                for (const vertex of pipe.vertices) {
                    const [lng, lat] = convertEPSG2326ToWGS84(vertex.x, vertex.y);
                    pathPoints.push([lat, lng]);
                }
            } else if (zoom > 12 && pipe.length > 1) {
                // 如果没有折点数据但管道较长，生成合理的路径
                const generatedVertices = generateReasonablePath(fromLatLng, toLatLng, pipe);
                pathPoints.splice(1, 0, ...generatedVertices);
            }
            
            pathPoints.push(toLatLng);
            
            // 根据缩放级别调整线宽
            let weight = Math.max(1, Math.min(6, pipe.diameter / 100));
            if (zoom <= 10) weight *= 0.5;
            else if (zoom <= 12) weight *= 0.7;
            
            const color = getPipelineColor(pipe.status, pipe.diameter);
            const opacity = zoom <= 10 ? 0.6 : 0.8;
            
            // 根据缩放级别决定是否简化路径（性能优化）
            const simplifiedPoints = shouldSimplifyPipeline(pathPoints, zoom);
            
            const polyline = L.polyline(simplifiedPoints, {
                color: color,
                weight: weight,
                opacity: opacity,
                className: 'optimized-pipeline',
                pipeId: pipe.id,
                smoothFactor: zoom > 12 ? 0.5 : 2.0 // 低缩放时更多简化
            });
            
            // 只在高缩放级别添加详细交互
            if (zoom > 12) {
                // 点击事件：在右侧面板显示管道详情
                polyline.on('click', function() {
                    showPipelineInPanel(pipe);
                });
                
                polyline.on('mouseover', function() {
                    this.setStyle({ weight: weight + 2, opacity: 1 });
                });
                polyline.on('mouseout', function() {
                    this.setStyle({ weight: weight, opacity: opacity });
                });
                
                // 工具提示
                const vertexCount = pipe.vertices ? pipe.vertices.length : 0;
                polyline.bindTooltip(`管道 ${pipe.id}<br/>Ø${pipe.diameter}mm · ${pipe.length.toFixed(1)}km<br/>${vertexCount > 0 ? `${vertexCount}个折点` : '直线连接'}`, {
                    direction: 'center'
                });
            }
            
            return polyline;
        }
        
        // 根据缩放级别决定是否简化管道路径（性能优化）
        function shouldSimplifyPipeline(pathPoints, zoom) {
            // 高缩放级别：显示所有折点
            if (zoom > 14) {
                return pathPoints;
            }
            
            // 中缩放级别：保留重要折点
            if (zoom > 11) {
                return simplifyPath(pathPoints, 0.0001); // 较小的容差，保留更多细节
            }
            
            // 低缩放级别：大幅简化
            if (zoom > 8) {
                return simplifyPath(pathPoints, 0.0005); // 较大的容差，大幅简化
            }
            
            // 极低缩放级别：只保留起点和终点
            return [pathPoints[0], pathPoints[pathPoints.length - 1]];
        }
        
        // 使用Douglas-Peucker算法简化路径
        function simplifyPath(points, tolerance) {
            if (points.length <= 2) return points;
            
            const simplified = [points[0]];
            simplifySection(points, 0, points.length - 1, tolerance, simplified);
            simplified.push(points[points.length - 1]);
            
            return simplified;
        }
        
        // Douglas-Peucker算法的递归函数
        function simplifySection(points, startIndex, endIndex, tolerance, result) {
            if (endIndex - startIndex <= 1) return;
            
            let maxDistance = 0;
            let maxIndex = startIndex;
            
            for (let i = startIndex + 1; i < endIndex; i++) {
                const distance = getPerpendicularDistance(
                    points[i], 
                    points[startIndex], 
                    points[endIndex]
                );
                
                if (distance > maxDistance) {
                    maxDistance = distance;
                    maxIndex = i;
                }
            }
            
            if (maxDistance > tolerance) {
                simplifySection(points, startIndex, maxIndex, tolerance, result);
                result.push(points[maxIndex]);
                simplifySection(points, maxIndex, endIndex, tolerance, result);
            }
        }
        
        // 计算点到直线的垂直距离
        function getPerpendicularDistance(point, lineStart, lineEnd) {
            const [px, py] = point;
            const [x1, y1] = lineStart;
            const [x2, y2] = lineEnd;
            
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            
            if (lenSq === 0) {
                return Math.sqrt(A * A + B * B);
            }
            
            const param = dot / lenSq;
            let xx, yy;
            
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            
            const dx = px - xx;
            const dy = py - yy;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // 为长管道生成合理的路径（避免直线穿越建筑等）
        function generateReasonablePath(startPoint, endPoint, pipe) {
            const [startLat, startLng] = startPoint;
            const [endLat, endLng] = endPoint;
            
            // 计算距离和方向
            const deltaLat = endLat - startLat;
            const deltaLng = endLng - startLng;
            const distance = Math.sqrt(deltaLat * deltaLat + deltaLng * deltaLng);
            
            // 如果管道太短，不需要生成中间点
            if (distance < 0.005) return [];
            
            const vertices = [];
            
            // 根据管道长度和类型生成不同的路径模式
            if (pipe.diameter >= 500) {
                // 主干管：生成较规整的路径（沿着主要道路）
                vertices.push(...generateMainPipelinePath(startPoint, endPoint, distance));
            } else if (pipe.diameter >= 200) {
                // 次干管：生成适中的弯曲路径
                vertices.push(...generateSecondaryPipelinePath(startPoint, endPoint, distance));
            } else {
                // 配水管：生成更灵活的路径
                vertices.push(...generateDistributionPipelinePath(startPoint, endPoint, distance));
            }
            
            return vertices;
        }
        
        // 主干管路径生成（规整路径）
        function generateMainPipelinePath(startPoint, endPoint, distance) {
            const [startLat, startLng] = startPoint;
            const [endLat, endLng] = endPoint;
            const vertices = [];
            
            // 生成L型或折线型路径（模拟沿道路铺设）
            const midLat = startLat + (endLat - startLat) * 0.6;
            const midLng = startLng + (endLng - startLng) * 0.4;
            
            // 添加轻微的道路对齐偏移
            const roadOffset = 0.0002; // 约20米的偏移
            vertices.push([midLat + roadOffset, midLng]);
            
            if (distance > 0.01) {
                const midLat2 = startLat + (endLat - startLat) * 0.8;
                const midLng2 = startLng + (endLng - startLng) * 0.7;
                vertices.push([midLat2, midLng2 - roadOffset]);
            }
            
            return vertices;
        }
        
        // 次干管路径生成（适中弯曲）
        function generateSecondaryPipelinePath(startPoint, endPoint, distance) {
            const [startLat, startLng] = startPoint;
            const [endLat, endLng] = endPoint;
            const vertices = [];
            
            // 生成轻微弯曲的路径
            const segments = Math.min(3, Math.floor(distance / 0.003) + 1);
            
            for (let i = 1; i < segments; i++) {
                const t = i / segments;
                const lat = startLat + (endLat - startLat) * t;
                const lng = startLng + (endLng - startLng) * t;
                
                // 添加轻微的随机偏移（模拟绕过障碍物）
                const offset = (Math.random() - 0.5) * 0.0003 * Math.sin(t * Math.PI);
                vertices.push([lat + offset, lng - offset * 0.5]);
            }
            
            return vertices;
        }
        
        // 配水管路径生成（更灵活）
        function generateDistributionPipelinePath(startPoint, endPoint, distance) {
            const [startLat, startLng] = startPoint;
            const [endLat, endLng] = endPoint;
            const vertices = [];
            
            // 生成更自然的弯曲路径
            if (distance > 0.008) {
                const midLat = (startLat + endLat) / 2;
                const midLng = (startLng + endLng) / 2;
                
                // 计算垂直方向的偏移
                const perpOffset = (Math.random() - 0.5) * 0.0008;
                const perpLat = -(endLng - startLng) * perpOffset;
                const perpLng = (endLat - startLat) * perpOffset;
                
                vertices.push([midLat + perpLat, midLng + perpLng]);
            }
            
            return vertices;
        }

        // 超级性能优化的样式
        const performanceStyles = `
            .cluster-marker {
                will-change: transform, opacity;
                backface-visibility: hidden;
                transition: transform 0.15s ease;
                transform: translateZ(0);
            }
            
            .cluster-marker:hover {
                transform: scale(1.1) translateZ(0);
            }
            
            .optimized-pipeline {
                will-change: opacity, stroke-width;
                pointer-events: auto;
                vector-effect: non-scaling-stroke;
            }
            
            .clean-marker {
                will-change: transform;
                backface-visibility: hidden;
                pointer-events: auto;
                transform: translateZ(0);
            }
            
            /* 缩放时的平滑过渡 */
            .leaflet-zoom-animated {
                transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }
            
            /* 提升渲染性能 */
            .leaflet-container {
                transform: translateZ(0);
                will-change: transform;
            }
            
            /* 渲染优化模式下的样式 */
            .rendering-optimized .leaflet-marker-icon,
            .rendering-optimized .leaflet-marker-shadow {
                transition: none !important;
            }
            
            .rendering-optimized svg path {
                transition: none !important;
            }
            
            /* 聚合标记的额外样式 */
            .cluster-huge { 
                box-shadow: 0 4px 15px rgba(0,0,0,0.5) !important; 
            }
            .cluster-large { 
                box-shadow: 0 3px 12px rgba(0,0,0,0.4) !important; 
            }
            .cluster-medium { 
                box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important; 
            }
            .cluster-small { 
                box-shadow: 0 1px 6px rgba(0,0,0,0.2) !important; 
            }
            .cluster-tiny { 
                box-shadow: 0 1px 4px rgba(0,0,0,0.15) !important; 
            }
        `;
        
        // 将性能样式注入页面
        const styleSheet = document.createElement('style');
        styleSheet.textContent = performanceStyles;
        document.head.appendChild(styleSheet);

        // 获取管道颜色
        function getPipelineColor(status, diameter) {
            if (status === 'warning' || status === 'alert') {
                return '#ff6b6b';
            }
            
            // 根据管径分类颜色
            if (diameter >= 500) return '#2c5aa0';      // 主干管 - 深蓝
            if (diameter >= 200) return '#4A90B8';      // 次干管 - 蓝色  
            if (diameter >= 100) return '#74b9ff';      // 配水管 - 浅蓝
            return '#a7c5eb';                           // 支管 - 很浅蓝
        }
        
        // 创建管道弹窗 - 基于字段表格优化的版本
        function createPipelinePopup(pipe) {
            const statusColor = getStatusColor(pipe.status);
            const statusName = getStatusName(pipe.status);
            
            // 计算管道特征参数
            const velocity = pipe.velocity || (pipe.flowRate / (Math.PI * Math.pow(pipe.diameter/2000, 2)));
            const unitLoss = pipe.headloss ? (pipe.headloss / (pipe.length/1000)) : 0; // 单位水损 m/km
            const absoluteFlow = Math.abs(pipe.flowRate);
            
            return `
                <div style="min-width: 300px; max-width: 350px; font-family: 'Microsoft YaHei', sans-serif;">
                    <!-- 管道头部信息 -->
                    <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 10px; margin: -15px -15px 15px -15px; border-radius: 8px 8px 0 0;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <h4 style="margin: 0; font-size: 13px;">管道 ${pipe.id}</h4>
                                <div style="font-size: 10px; opacity: 0.9; margin-top: 2px;">
                                    ${pipe.from} → ${pipe.to} · Ø${pipe.diameter}mm
                                </div>
                            </div>
                        <div style="
                                padding: 3px 8px; 
                                border-radius: 12px; 
                            background: ${statusColor}; 
                                font-size: 9px; 
                            font-weight: bold;
                                border: 1px solid rgba(255,255,255,0.3);
                        ">${statusName}</div>
                        </div>
                    </div>
                    
                    <!-- 核心运行指标 -->
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 600;">运行状态</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <div style="
                                background: ${getFlowBackgroundColor(pipe.flowRate)}; 
                                padding: 8px; 
                                border-radius: 6px; 
                                text-align: center;
                                border: 1px solid ${getFlowBorderColor(pipe.flowRate)};
                            ">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">流量</div>
                                <div style="font-size: 15px; font-weight: bold; color: ${getFlowTextColor(pipe.flowRate)};">
                                    ${pipe.flowRate > 0 ? '+' : ''}${pipe.flowRate.toFixed(1)}<span style="font-size: 9px; font-weight: normal; margin-left: 1px;">L/s</span>
                                </div>
                            </div>
                            <div style="
                                background: ${getVelocityBackgroundColor(velocity)}; 
                                padding: 8px; 
                                border-radius: 6px; 
                                text-align: center;
                                border: 1px solid ${getVelocityBorderColor(velocity)};
                            ">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">流速</div>
                                <div style="font-size: 15px; font-weight: bold; color: ${getVelocityTextColor(velocity)};">
                                    ${velocity.toFixed(2)}<span style="font-size: 9px; font-weight: normal; margin-left: 1px;">m/s</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 管道参数 -->
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 600;">管道参数</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 11px;">
                            <div><span style="color: #666;">直径:</span> <strong>${pipe.diameter} mm</strong></div>
                            <div><span style="color: #666;">长度:</span> <strong>${pipe.length.toFixed(1)} km</strong></div>
                            <div><span style="color: #666;">材质:</span> <strong>${pipe.material || 'CI'}</strong></div>
                            <div><span style="color: #666;">粗糙度:</span> <strong>${pipe.roughness}</strong></div>
                        </div>
                    </div>
                    
                    <!-- 水力特性 -->
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 600;">水力特性</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 11px;">
                            <div><span style="color: #666;">水头损失:</span> <strong style="color: ${pipe.headloss > 1 ? '#e74c3c' : '#27ae60'};">${pipe.headloss ? pipe.headloss.toFixed(4) : 'N/A'} m</strong></div>
                            <div><span style="color: #666;">单位水损:</span> <strong style="color: ${unitLoss > 5 ? '#e74c3c' : '#27ae60'};">${unitLoss.toFixed(2)} m/km</strong></div>
                            <div><span style="color: #666;">绝对流量:</span> <strong>${absoluteFlow.toFixed(1)} L/s</strong></div>
                            <div><span style="color: #666;">状态:</span> <strong style="color: ${getStatusColor(pipe.status)};">${getStatusName(pipe.status)}</strong></div>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div style="display: flex; gap: 6px; padding-top: 8px; border-top: 1px solid #eee;">
                        <button onclick="showPipeAnalysis('${pipe.id}')" style="
                            flex: 1; padding: 6px 8px; border: 1px solid #27ae60; background: #27ae60; 
                            color: white; border-radius: 4px; font-size: 11px; cursor: pointer;
                        ">水力分析</button>
                        <button onclick="showFlowTrend('${pipe.id}')" style="
                            flex: 1; padding: 6px 8px; border: 1px solid #27ae60; background: white; 
                            color: #27ae60; border-radius: 4px; font-size: 11px; cursor: pointer;
                        ">流量趋势</button>
                    </div>
                    
                    <!-- 底部时间戳 -->
                    <div style="margin-top: 8px; font-size: 10px; color: #999; text-align: center;">
                        最后更新: ${new Date().toLocaleString('zh-CN', {hour12: false})}
                    </div>
                </div>
            `;
        }
        
        // 获取流量相关的视觉样式
        function getFlowBackgroundColor(flow) {
            if (Math.abs(flow) < 5) return '#fff8f0';  // 低流量
            if (Math.abs(flow) > 100) return '#f0f8ff'; // 高流量
            return '#f8fff8';                           // 正常流量
        }
        
        function getFlowBorderColor(flow) {
            if (Math.abs(flow) < 5) return '#ffe4cc';
            if (Math.abs(flow) > 100) return '#cce7ff';
            return '#ccffcc';
        }
        
        function getFlowTextColor(flow) {
            if (Math.abs(flow) < 5) return '#e67e22';
            if (Math.abs(flow) > 100) return '#3498db';
            return '#27ae60';
        }
        
        // 获取流速相关的视觉样式
        function getVelocityBackgroundColor(velocity) {
            if (velocity < 0.5) return '#fff8f0';       // 低流速
            if (velocity > 2.0) return '#fff5f5';       // 高流速（可能冲刷）
            return '#f8fff8';                           // 正常流速
        }
        
        function getVelocityBorderColor(velocity) {
            if (velocity < 0.5) return '#ffe4cc';
            if (velocity > 2.0) return '#ffcccc';
            return '#ccffcc';
        }
        
        function getVelocityTextColor(velocity) {
            if (velocity < 0.5) return '#e67e22';
            if (velocity > 2.0) return '#e74c3c';
            return '#27ae60';
        }

        // 更新设施统计
        function updateFacilityStats() {
            const stats = {
                pump_station: 0,
                reservoir: 0,
                tank: 0,
                junction: 0,
                valve: 0,
                total: facilityData.length
            };
            
            const alarmStats = {
                critical: 0,
                warning: 0,
                maintenance: 0,
                normal: 0
            };
            
            facilityData.forEach(facility => {
                // 统计设施类型
                if (stats[facility.type] !== undefined) {
                    stats[facility.type]++;
                }
                
                // 统计报警状态
                if (facility.status === 'critical' || 
                    facility.status === 'high_pressure' || 
                    facility.status === 'vibration' || 
                    facility.status === 'temperature' || 
                    facility.status === 'power' || 
                    facility.status === 'overflow' || 
                    facility.status === 'contamination' || 
                    facility.status === 'no_flow' || 
                    facility.status === 'leak') {
                    alarmStats.critical++;
                } else if (facility.status === 'warning' || 
                          facility.status === 'low_pressure' || 
                          facility.status === 'low_level' || 
                          facility.status === 'high_level') {
                    alarmStats.warning++;
                } else if (facility.status === 'maintenance') {
                    alarmStats.maintenance++;
                } else if (facility.status === 'normal') {
                    alarmStats.normal++;
                }
            });
            
            // 更新界面
            document.getElementById('pump-count').textContent = stats.pump_station;
            document.getElementById('reservoir-count').textContent = stats.reservoir;
            document.getElementById('tank-count').textContent = stats.tank;
            document.getElementById('junction-count').textContent = stats.junction;
            document.getElementById('valve-count').textContent = stats.valve;
            document.getElementById('total-count').textContent = stats.total;
            
            document.getElementById('critical-count').textContent = alarmStats.critical;
            document.getElementById('warning-count').textContent = alarmStats.warning;
            document.getElementById('maintenance-count').textContent = alarmStats.maintenance;
            document.getElementById('normal-count').textContent = alarmStats.normal;
        }
        
        // 设施过滤
        function filterFacilities(type) {
            console.log('过滤设施类型:', type);
            // TODO: 实现过滤逻辑
        }
        
        // 报警过滤
        function filterByAlarm(status) {
            console.log('按报警状态过滤:', status);
            // TODO: 实现报警过滤逻辑
        }

        // 创建设施图标 - 支持更多类型和状态
        function createFacilityIcon(facility) {
            let color = getStatusColor(facility.status);
            let bgColor = color;
            let borderColor = '#ffffff';
            
            // 特殊状态的边框颜色
            if (facility.status === 'critical') {
                borderColor = '#ff0000';
                // 添加闪烁效果
                setTimeout(() => {
                    const markers = document.querySelectorAll(`[data-facility-id="${facility.id}"]`);
                    markers.forEach(marker => {
                        marker.style.animation = 'blink 1s infinite';
                    });
                }, 100);
            }

            const iconMap = {
                'pump_station': 'fas fa-industry',
                'reservoir': 'fas fa-water',
                'tank': 'fas fa-oil-can',
                'junction': 'fas fa-circle',
                'valve': 'fas fa-adjust',
                'meter': 'fas fa-tachometer-alt'
            };

            const iconSize = facility.type === 'junction' ? 16 : 24;
            const icon = iconMap[facility.type] || 'fas fa-circle';

            return L.divIcon({
                html: `<div data-facility-id="${facility.id}" style="
                    width: ${iconSize}px; 
                    height: ${iconSize}px; 
                    background: ${bgColor}; 
                    border: 3px solid ${borderColor}; 
                    border-radius: 50%; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    color: white; 
                    font-size: ${iconSize * 0.5}px; 
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    position: relative;
                ">
                    <i class="${icon}"></i>
                    ${facility.status !== 'normal' ? `<div style="
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        width: 8px;
                        height: 8px;
                        background: ${facility.status === 'critical' ? '#ff0000' : '#ffa500'};
                        border-radius: 50%;
                        border: 1px solid white;
                    "></div>` : ''}
                </div>`,
                className: 'custom-marker',
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconSize/2, iconSize/2]
            });
        }
        
        // 获取状态颜色
        function getStatusColor(status) {
            const colorMap = {
                'normal': '#2ed573',
                'warning': '#ffa502',
                'critical': '#ff3838',
                'maintenance': '#747d8c',
                'low_pressure': '#ff6b6b',
                'high_pressure': '#ff9f43',
                'vibration': '#ff7675',
                'temperature': '#fd79a8',
                'power': '#fdcb6e',
                'overflow': '#e84393',
                'low_level': '#a29bfe',
                'high_level': '#fd79a8',
                'contamination': '#6c5ce7',
                'no_flow': '#636e72',
                'leak': '#e17055'
            };
            return colorMap[status] || '#57606f';
        }
        
        // 获取状态中文名称
        function getStatusName(status) {
            const statusMap = {
                'normal': '正常',
                'warning': '预警',
                'critical': '严重故障',
                'maintenance': '维护中',
                'low_pressure': '低压报警',
                'high_pressure': '高压报警',
                'vibration': '振动异常',
                'temperature': '温度异常',
                'power': '电源异常',
                'overflow': '溢出报警',
                'low_level': '低液位',
                'high_level': '高液位',
                'contamination': '污染报警',
                'no_flow': '断流报警',
                'leak': '泄漏报警'
            };
            return statusMap[status] || '未知';
        }

        // 创建设施弹窗 - 基于字段表格优化的用户体验版本
        function createFacilityPopup(facility) {
            const statusColor = getStatusColor(facility.status);
            const statusName = getStatusName(facility.status);
            const typeName = getFacilityTypeName(facility.type);
            
            // 根据设施类型生成核心指标卡片
            const coreMetrics = generateCoreMetrics(facility);
            const detailMetrics = generateDetailMetrics(facility);
            const qualityMetrics = generateQualityMetrics(facility);
            
            return `
                <div style="min-width: 320px; max-width: 400px; font-family: 'Microsoft YaHei', sans-serif;">
                    <!-- 设施头部信息 -->
                    <div style="background: linear-gradient(135deg, #4A90B8, #6BA3C7); color: white; padding: 12px; margin: -15px -15px 15px -15px; border-radius: 8px 8px 0 0;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <h4 style="margin: 0; font-size: 14px;">${facility.name}</h4>
                                <div style="font-size: 11px; opacity: 0.9; margin-top: 2px;">${typeName} · ID: ${facility.id}</div>
                            </div>
                        <div style="
                                padding: 4px 8px; 
                            border-radius: 12px; 
                            background: ${statusColor}; 
                                font-size: 10px; 
                            font-weight: bold;
                                border: 1px solid rgba(255,255,255,0.3);
                        ">${statusName}</div>
                        </div>
                    </div>
                    
                    <!-- 核心指标（大号显示）-->
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 600;">核心指标</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            ${coreMetrics}
                        </div>
                    </div>
                    
                    <!-- 详细参数（紧凑显示）-->
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 600;">运行参数</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 11px;">
                            ${detailMetrics}
                        </div>
                    </div>
                    
                    <!-- 水质指标（如果有）-->
                    ${qualityMetrics ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 6px; font-weight: 600;">水质指标</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; font-size: 10px;">
                            ${qualityMetrics}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 操作按钮 -->
                    <div style="display: flex; gap: 6px; padding-top: 8px; border-top: 1px solid #eee;">
                        <button onclick="showDetailedView('${facility.id}')" style="
                            flex: 1; padding: 6px 8px; border: 1px solid #4A90B8; background: #4A90B8; 
                            color: white; border-radius: 4px; font-size: 11px; cursor: pointer;
                        ">详细信息</button>
                        <button onclick="showTrendChart('${facility.id}')" style="
                            flex: 1; padding: 6px 8px; border: 1px solid #4A90B8; background: white; 
                            color: #4A90B8; border-radius: 4px; font-size: 11px; cursor: pointer;
                        ">趋势图</button>
                        <button onclick="showControlPanel('${facility.id}')" style="
                            flex: 1; padding: 6px 8px; border: 1px solid #4A90B8; background: white; 
                            color: #4A90B8; border-radius: 4px; font-size: 11px; cursor: pointer;
                        ">控制</button>
                    </div>
                    
                    <!-- 底部时间戳 -->
                    <div style="margin-top: 8px; font-size: 10px; color: #999; text-align: center;">
                        最后更新: ${new Date().toLocaleString('zh-CN', {hour12: false})}
                    </div>
                </div>
            `;
        }
        
        // 生成核心指标卡片（大号显示，用户最关心的数据）
        function generateCoreMetrics(facility) {
            let metrics = [];
            
            switch(facility.type) {
                case 'junction':
                    metrics = [
                        { label: '压力', value: `${facility.pressure.toFixed(3)}`, unit: 'MPa', status: getPressureStatus(facility.pressure) },
                        { label: '需水量', value: `${facility.demand || facility.flow.toFixed(1)}`, unit: 'L/s', status: 'normal' }
                    ];
                    break;
                    
                case 'reservoir':
                    metrics = [
                        { label: '水位', value: `${facility.head.toFixed(2)}`, unit: 'm', status: getHeadStatus(facility.head) },
                        { label: '供水量', value: `${facility.flow.toFixed(1)}`, unit: 'L/s', status: getFlowStatus(facility.flow) }
                    ];
                    break;
                    
                case 'tank':
                    const level = facility.head - facility.elevation;
                    metrics = [
                        { label: '液位', value: `${level.toFixed(2)}`, unit: 'm', status: getLevelStatus(level) },
                        { label: '流量', value: `${facility.flow > 0 ? '+' : ''}${facility.flow.toFixed(1)}`, unit: 'L/s', status: getFlowStatus(facility.flow) }
                    ];
                    break;
                    
                case 'pump_station':
                    metrics = [
                        { label: '流量', value: `${facility.flow.toFixed(1)}`, unit: 'L/s', status: getFlowStatus(facility.flow) },
                        { label: '扬程', value: `${facility.head.toFixed(1)}`, unit: 'm', status: 'normal' }
                    ];
                    break;
            }
            
            return metrics.map(metric => `
                <div style="
                    background: ${getMetricBackgroundColor(metric.status)}; 
                    padding: 8px; 
                    border-radius: 6px; 
                    text-align: center;
                    border: 1px solid ${getMetricBorderColor(metric.status)};
                ">
                    <div style="font-size: 10px; color: #666; margin-bottom: 2px;">${metric.label}</div>
                    <div style="font-size: 16px; font-weight: bold; color: ${getMetricTextColor(metric.status)};">
                        ${metric.value}<span style="font-size: 10px; font-weight: normal; margin-left: 2px;">${metric.unit}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // 生成详细参数（紧凑显示）
        function generateDetailMetrics(facility) {
            let metrics = [];
            
            // 通用参数
            metrics.push(
                `<div><span style="color: #666;">高程:</span> <strong>${facility.elevation.toFixed(2)} m</strong></div>`,
                `<div><span style="color: #666;">状态:</span> <strong style="color: ${getStatusColor(facility.status)};">${getStatusName(facility.status)}</strong></div>`
            );
            
            // 类型特定参数
            switch(facility.type) {
                case 'pump_station':
                    if (facility.speed) metrics.push(`<div><span style="color: #666;">频率:</span> <strong>${facility.speed} Hz</strong></div>`);
                    if (facility.power) metrics.push(`<div><span style="color: #666;">功率:</span> <strong>${facility.power} kW</strong></div>`);
                    break;
                    
                case 'tank':
                    const capacity = Math.PI * Math.pow(facility.diameter/2, 2) * facility.maxLevel;
                    metrics.push(`<div><span style="color: #666;">容量:</span> <strong>${capacity.toFixed(0)} m³</strong></div>`);
                    break;
            }
            
            return metrics.join('');
        }
        
        // 生成水质指标
        function generateQualityMetrics(facility) {
            if (!facility.waterQuality) return null;
            
            const quality = facility.waterQuality;
            return [
                `<div><span style="color: #666;">余氯:</span> <strong>${quality.chlorine.toFixed(2)} mg/L</strong></div>`,
                `<div><span style="color: #666;">pH:</span> <strong>${quality.ph.toFixed(1)}</strong></div>`,
                `<div><span style="color: #666;">浊度:</span> <strong>${quality.turbidity.toFixed(2)} NTU</strong></div>`
            ].join('');
        }
        
        // 获取指标状态
        function getPressureStatus(pressure) {
            if (pressure < 0.15) return 'critical';
            if (pressure < 0.25) return 'warning';
            return 'normal';
        }
        
        function getHeadStatus(head) {
            if (head < 10) return 'warning';
            return 'normal';
        }
        
        function getLevelStatus(level) {
            if (level < 1) return 'critical';
            if (level < 2) return 'warning';
            return 'normal';
        }
        
        function getFlowStatus(flow) {
            if (Math.abs(flow) < 10) return 'warning';
            return 'normal';
        }
        
        // 获取指标卡片样式
        function getMetricBackgroundColor(status) {
            const colors = {
                'normal': '#f8f9ff',
                'warning': '#fff8f0',
                'critical': '#fff5f5'
            };
            return colors[status] || colors.normal;
        }
        
        function getMetricBorderColor(status) {
            const colors = {
                'normal': '#e1e5ff',
                'warning': '#ffe4cc',
                'critical': '#ffcccc'
            };
            return colors[status] || colors.normal;
        }
        
        function getMetricTextColor(status) {
            const colors = {
                'normal': '#2f3640',
                'warning': '#e67e22',
                'critical': '#e74c3c'
            };
            return colors[status] || colors.normal;
        }

        function getFacilityTypeName(type) {
            const typeNames = {
                'junction': '节点',
                'pump_station': '泵站',
                'reservoir': '水库',
                'tank': '水塔',
                'valve': '阀门',
                'meter': '流量计'
            };
            return typeNames[type] || '未知';
        }
        
        // 显示趋势图
        function showTrendChart(facilityId) {
            console.log('显示趋势图:', facilityId);
            // 这里可以打开趋势图模态框
            alert(`显示 ${facilityId} 的趋势图`);
        }
        
        // 显示控制面板
        function showControlPanel(facilityId) {
            console.log('显示控制面板:', facilityId);
            // 这里可以打开控制面板模态框
            alert(`显示 ${facilityId} 的控制面板`);
        }
        
        // 显示报警历史
        function showAlarmHistory(facilityId) {
            console.log('显示报警历史:', facilityId);
            // 这里可以打开报警历史模态框
            alert(`显示 ${facilityId} 的报警历史`);
        }

        // 模式切换
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            console.log('切换到模式:', mode);
        }

        // 时间控制
        function timeControl(action) {
            switch(action) {
                case 'toggle':
                    togglePlay();
                    break;
                case 'prev':
                    adjustTime(-300); // 后退5分钟
                    break;
                case 'next':
                    adjustTime(300); // 前进5分钟
                    break;
                case 'backward':
                    adjustTime(-1500); // 快退25分钟
                    break;
                case 'forward':
                    adjustTime(1500); // 快进25分钟
                    break;
            }
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            const playBtn = document.getElementById('playBtn');
            
            if (isPlaying) {
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                playBtn.classList.add('playing');
                startAutoPlay();
            } else {
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                playBtn.classList.remove('playing');
                stopAutoPlay();
            }
        }

        function startAutoPlay() {
            const speed = parseFloat(document.getElementById('playSpeed').value);
            playInterval = setInterval(() => {
                adjustTime(300 * speed); // 根据速度调整时间间隔（5分钟 * 速度）
            }, 1000);
        }

        function stopAutoPlay() {
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }

        function adjustTime(seconds) {
            currentTime = new Date(currentTime.getTime() + seconds * 1000);
            updateTimeDisplay();
            updateTimeSlider();
        }

        function updateTimeDisplay() {
            const timeDisplay = document.getElementById('timeDisplay');
            const formattedTime = formatDateTime(currentTime);
            timeDisplay.textContent = formattedTime;
            // 判断是否为最新
            const now = new Date();
            const isLatest = Math.abs(currentTime.getTime() - now.getTime()) < 300000; // 5分钟内
            const latestTag = document.getElementById('latestTag');
            if (isLatest) {
                latestTag.style.display = '';
                timeDisplay.classList.add('playing');
            } else {
                latestTag.style.display = 'none';
                timeDisplay.classList.remove('playing');
            }
            timeDisplay.appendChild(latestTag);
            // 进度条红点
            const slider = document.getElementById('timeSlider');
            const latestDot = document.getElementById('latestDot');
            const max = parseInt(slider.max);
            const val = parseInt(slider.value);
            if (isLatest) {
                const percent = val / max;
                latestDot.style.display = '';
                latestDot.style.left = `calc(${percent*100}% - 6px)`;
            } else {
                latestDot.style.display = 'none';
            }
            // 更新当前时间显示
            document.getElementById('currentTime').textContent = formattedTime;
        }

        function updateTimeSlider() {
            const slider = document.getElementById('timeSlider');
            const minutes = currentTime.getHours() * 60 + currentTime.getMinutes();
            slider.value = minutes;
        }

        function updateTimeFromSlider(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60 / 5) * 5; // 将分钟数调整为5的倍数
            currentTime.setHours(hours, mins, 0, 0);
            updateTimeDisplay();
        }

        function setTimeRange(range) {
            // 保留函数体以避免错误，但不执行任何操作
            console.log('时间范围功能已简化');
        }

        function setPlaySpeed(speed) {
            if (isPlaying) {
                stopAutoPlay();
                startAutoPlay();
            }
        }

        function updateTime() {
            const currentTimeEl = document.getElementById('currentTime');
            currentTimeEl.textContent = formatDateTime(new Date());
        }

        function formatDateTime(date) {
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // 图层切换
        function switchMapLayer(layer) {
            document.querySelectorAll('.left-panel .menu-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            console.log('切换图层:', layer);
        }

        // 快捷操作
        function quickAction(action) {
            console.log('快捷操作:', action);
        }

        // 地图模式
        function setMapMode(mode) {
            document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            console.log('地图模式:', mode);
        }

        // 对比模式
        function toggleCompareMode() {
            compareMode = !compareMode;
            const toggle = document.getElementById('compareToggle');
            toggle.classList.toggle('active', compareMode);
            console.log('对比模式:', compareMode);
        }

        // 左侧面板控制
        let leftPanelCollapsed = false;
        
        function toggleLeftPanel() {
            const panel = document.getElementById('leftPanel');
            const icon = document.getElementById('leftToggleIcon');
            
            leftPanelCollapsed = !leftPanelCollapsed;
            
            if (leftPanelCollapsed) {
                panel.classList.add('collapsed');
                icon.className = 'fas fa-chevron-right';
            } else {
                panel.classList.remove('collapsed');
                icon.className = 'fas fa-chevron-left';
            }
        }
        
        // 右侧面板控制
        let rightPanelCollapsed = false;
        
        function toggleRightPanel() {
            const panel = document.getElementById('rightPanel');
            const icon = document.getElementById('rightToggleIcon');
            
            rightPanelCollapsed = !rightPanelCollapsed;
            
            if (rightPanelCollapsed) {
                panel.classList.add('collapsed');
                icon.className = 'fas fa-chevron-left';
            } else {
                panel.classList.remove('collapsed');
                icon.className = 'fas fa-chevron-right';
            }
        }
        
        // 左侧面板分组折叠
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId + '-section');
            const header = event.target.closest('.section-header');
            
            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                header.classList.add('expanded');
            } else {
                section.classList.add('collapsed');
                header.classList.remove('expanded');
            }
        }
        
        // 面板标签切换
        function switchTab(tab) {
            // 移除所有激活状态
            document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // 激活选中的标签
            event.target.classList.add('active');
            
            // 显示对应内容
            const panels = {
                'properties': 'propertiesPanel',
                'layers': 'layersPanel', 
                'analysis': 'analysisPanel'
            };
            
            if (panels[tab]) {
                document.getElementById(panels[tab]).classList.add('active');
            }
        }

        // 工具函数
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function resetView() {
            map.setView([22.3193, 114.1694], 11);
        }
        
        // 返回运营总览
        function goToDashboard() {
            window.location.href = 'dashboard_overview.html';
        }

        // 综合信息面板控制
        function toggleInfoPanel() {
            const panel = document.getElementById('infoPanel');
            panel.classList.toggle('collapsed');
        }

        // 绘制压力分布图
        function drawPressureChart() {
            const canvas = document.getElementById('pressureCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // 清空画布
            ctx.clearRect(0, 0, width, height);
            
            // 模拟压力分布数据
            const pressureData = [
                { range: '0-0.1', count: 5 },
                { range: '0.1-0.2', count: 12 },
                { range: '0.2-0.3', count: 25 },
                { range: '0.3-0.4', count: 35 },
                { range: '0.4-0.5', count: 18 },
                { range: '0.5+', count: 8 }
            ];
            
            const maxCount = Math.max(...pressureData.map(d => d.count));
            const barWidth = width / pressureData.length - 10;
            const scale = (height - 40) / maxCount;
            
            // 绘制柱状图
            pressureData.forEach((data, index) => {
                const x = index * (barWidth + 10) + 5;
                const barHeight = data.count * scale;
                const y = height - barHeight - 20;
                
                // 渐变色
                const gradient = ctx.createLinearGradient(0, y, 0, height - 20);
                gradient.addColorStop(0, '#4A90B8');
                gradient.addColorStop(1, '#357abd');
                
                // 绘制柱子
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // 绘制数值
                ctx.fillStyle = '#2f3640';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(data.count, x + barWidth / 2, y - 5);
                
                // 绘制标签
                ctx.fillText(data.range, x + barWidth / 2, height - 5);
            });
            
            // 添加单位标签
            ctx.save();
            ctx.translate(10, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillStyle = '#57606f';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('节点数', 0, 0);
            ctx.restore();
            
            // X轴标签
            ctx.fillStyle = '#57606f';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('压力 (MPa)', width / 2, height);
        }

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.key === 'M' || e.key === 'm') {
                console.log('切换底图');
            } else if (e.key === 'F' || e.key === 'f') {
                toggleFullscreen();
            } else if (e.key === ' ') {
                e.preventDefault();
                timeControl('toggle');
            }
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', initializeApp);

        // --- 图层透明度控制功能 ---

        // 切换透明度控制面板显示/隐藏
        function toggleOpacityPanel() {
            const panel = document.getElementById('opacityControlPanel');
            const toggleBtn = document.getElementById('opacityToggleBtn');
            
            panel.classList.toggle('visible');
            toggleBtn.classList.toggle('active');
        }

        // 更新图层透明度
        function updateLayerOpacity(layerType, value) {
            const opacity = value / 100;
            layerOpacity[layerType] = opacity;
            
            // 更新透明度显示值
            const valueElement = document.getElementById(`${layerType}OpacityValue`);
            if (valueElement) {
                valueElement.textContent = `${value}%`;
            }
            
            console.log(`更新${layerType}图层透明度为: ${opacity}`);
            
            // 根据图层类型应用透明度
            switch(layerType) {
                case 'facility':
                    updateFacilityLayerOpacity(opacity);
                    break;
                case 'pipeline':
                    updatePipelineLayerOpacity(opacity);
                    break;
                case 'basemap':
                    updateBasemapOpacity(opacity);
                    break;
            }
        }

        // 更新设施图层透明度
        function updateFacilityLayerOpacity(opacity) {
            if (facilityLayerGroup) {
                facilityLayerGroup.getLayers().forEach(layer => {
                    if (layer.setOpacity) {
                        layer.setOpacity(opacity);
                    } else if (layer.setStyle) {
                        // 对于CircleMarker等矢量图层
                        const currentStyle = layer.options;
                        layer.setStyle({
                            fillOpacity: currentStyle.fillOpacity ? currentStyle.fillOpacity * opacity : opacity,
                            opacity: currentStyle.opacity ? currentStyle.opacity * opacity : opacity
                        });
                    } else if (layer.getElement) {
                        // 对于DivIcon标记
                        const element = layer.getElement();
                        if (element) {
                            element.style.opacity = opacity;
                        }
                    }
                });
            }
        }

        // 更新管道图层透明度
        function updatePipelineLayerOpacity(opacity) {
            if (pipelineLayerGroup) {
                pipelineLayerGroup.getLayers().forEach(layer => {
                    if (layer.setStyle) {
                        const currentStyle = layer.options;
                        layer.setStyle({
                            opacity: opacity,
                            fillOpacity: currentStyle.fillOpacity ? currentStyle.fillOpacity * opacity : opacity
                        });
                    }
                });
            }
        }

        // 更新底图透明度
        function updateBasemapOpacity(opacity) {
            if (currentTileLayer && currentTileLayer.setOpacity) {
                currentTileLayer.setOpacity(opacity);
            }
        }

        // 重置所有图层透明度为100%
        function resetAllOpacity() {
            const layerTypes = ['facility', 'pipeline', 'basemap'];
            
            layerTypes.forEach(layerType => {
                // 重置滑块值
                const slider = document.getElementById(`${layerType}OpacitySlider`);
                if (slider) {
                    slider.value = 100;
                }
                
                // 更新透明度
                updateLayerOpacity(layerType, 100);
            });
            
            console.log('已重置所有图层透明度为100%');
        }

        // 应用透明度到新创建的图层元素
        function applyOpacityToNewLayer(layer, layerType) {
            const opacity = layerOpacity[layerType] || 1.0;
            
            if (opacity < 1.0) {
                if (layer.setOpacity) {
                    layer.setOpacity(opacity);
                } else if (layer.setStyle) {
                    const currentStyle = layer.options || {};
                    layer.setStyle({
                        opacity: opacity,
                        fillOpacity: currentStyle.fillOpacity ? currentStyle.fillOpacity * opacity : opacity
                    });
                } else if (layer.getElement) {
                    const element = layer.getElement();
                    if (element) {
                        element.style.opacity = opacity;
                    }
                }
            }
        }

        // 确保全局函数可用
        window.toggleOpacityPanel = toggleOpacityPanel;
        window.updateLayerOpacity = updateLayerOpacity;
        window.resetAllOpacity = resetAllOpacity;

        // 显示详细信息视图
        function showDetailedView(facilityId) {
            const facility = facilityData.find(f => f.id === facilityId);
            if (!facility) return;
            
            // 创建详细信息侧边栏
            const detailPanel = document.createElement('div');
            detailPanel.id = 'detail-panel';
            detailPanel.style.cssText = `
                position: fixed;
                top: 60px;
                right: 20px;
                width: 350px;
                max-height: calc(100vh - 100px);
                background: white;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                z-index: 1001;
                overflow-y: auto;
                padding: 20px;
                font-family: 'Microsoft YaHei', sans-serif;
            `;
            
            detailPanel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #2f3640;">${facility.name} - 详细信息</h3>
                    <button onclick="closeDetailPanel()" style="
                        background: none; border: none; font-size: 20px; 
                        color: #666; cursor: pointer; padding: 5px;
                    ">&times;</button>
                </div>
                
                <!-- 实时状态图表 -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #666; font-size: 14px; margin-bottom: 10px;">实时状态</h4>
                    <canvas id="status-chart" width="310" height="120"></canvas>
                </div>
                
                <!-- 历史趋势 -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #666; font-size: 14px; margin-bottom: 10px;">24小时趋势</h4>
                    <canvas id="trend-chart" width="310" height="150"></canvas>
                </div>
                
                <!-- 详细属性表 -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #666; font-size: 14px; margin-bottom: 10px;">完整属性</h4>
                    <div id="property-table" style="font-size: 11px; line-height: 1.6;"></div>
                </div>
                
                <!-- 操作历史 -->
                <div>
                    <h4 style="color: #666; font-size: 14px; margin-bottom: 10px;">最近操作</h4>
                    <div id="operation-history" style="font-size: 11px; color: #666;"></div>
                </div>
            `;
            
            // 移除已存在的面板
            const existingPanel = document.getElementById('detail-panel');
            if (existingPanel) existingPanel.remove();
            
            document.body.appendChild(detailPanel);
            
            // 生成属性表
            generatePropertyTable(facility);
            generateOperationHistory(facility);
            generateStatusChart(facility);
            generateTrendChart(facility);
        }
        
        // 关闭详细信息面板
        function closeDetailPanel() {
            const panel = document.getElementById('detail-panel');
            if (panel) panel.remove();
        }
        
        // 生成属性表
        function generatePropertyTable(facility) {
            const table = document.getElementById('property-table');
            if (!table) return;
            
            const properties = [
                { label: 'ID', value: facility.id },
                { label: '名称', value: facility.name },
                { label: '类型', value: getFacilityTypeName(facility.type) },
                { label: '状态', value: getStatusName(facility.status) },
                { label: '经度', value: facility.lng.toFixed(6) },
                { label: '纬度', value: facility.lat.toFixed(6) },
                { label: '高程', value: facility.elevation.toFixed(2) + ' m' },
                { label: '压力', value: facility.pressure.toFixed(3) + ' MPa' },
                { label: '流量', value: facility.flow.toFixed(1) + ' L/s' },
                { label: '温度', value: facility.temperature.toFixed(1) + '°C' }
            ];
            
            // 添加类型特定属性
            if (facility.type === 'tank') {
                const level = facility.head - facility.elevation;
                properties.push(
                    { label: '水位', value: facility.head.toFixed(2) + ' m' },
                    { label: '液位', value: level.toFixed(2) + ' m' }
                );
            }
            
            if (facility.waterQuality) {
                properties.push(
                    { label: '余氯', value: facility.waterQuality.chlorine.toFixed(2) + ' mg/L' },
                    { label: 'pH值', value: facility.waterQuality.ph.toFixed(1) },
                    { label: '浊度', value: facility.waterQuality.turbidity.toFixed(2) + ' NTU' }
                );
            }
            
            table.innerHTML = properties.map(prop => `
                <div style="display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #f0f0f0;">
                    <span style="color: #666;">${prop.label}:</span>
                    <strong>${prop.value}</strong>
                </div>
            `).join('');
        }
        
        // 生成操作历史
        function generateOperationHistory(facility) {
            const history = document.getElementById('operation-history');
            if (!history) return;
            
            const operations = [
                { time: '2024-01-20 14:30', action: '参数调整', detail: '压力设定值调整为0.35MPa' },
                { time: '2024-01-20 09:15', action: '状态检查', detail: '例行巡检，设备运行正常' },
                { time: '2024-01-19 16:45', action: '报警处理', detail: '低压报警，已恢复正常' }
            ];
            
            history.innerHTML = operations.map(op => `
                <div style="margin-bottom: 8px; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                    <div style="font-weight: 600; margin-bottom: 2px;">${op.action}</div>
                    <div style="color: #666; font-size: 10px;">${op.time}</div>
                    <div style="margin-top: 2px;">${op.detail}</div>
                </div>
            `).join('');
        }
        
        // 生成状态图表（简化版）
        function generateStatusChart(facility) {
            const canvas = document.getElementById('status-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const metrics = [
                { label: '压力', value: facility.pressure * 100, max: 50, color: '#3498db' },
                { label: '流量', value: facility.flow, max: 200, color: '#2ecc71' },
                { label: '温度', value: facility.temperature, max: 50, color: '#e74c3c' }
            ];
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '10px Microsoft YaHei';
            
            metrics.forEach((metric, index) => {
                const y = 20 + index * 30;
                const width = (metric.value / metric.max) * 200;
                
                // 绘制背景条
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(80, y, 200, 15);
                
                // 绘制数值条
                ctx.fillStyle = metric.color;
                ctx.fillRect(80, y, width, 15);
                
                // 绘制标签
                ctx.fillStyle = '#333';
                ctx.fillText(metric.label, 10, y + 12);
                ctx.fillText(metric.value.toFixed(1), 285, y + 12);
            });
        }
        
        // 生成趋势图表（简化版）
        function generateTrendChart(facility) {
            const canvas = document.getElementById('trend-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 生成模拟数据
            const hours = 24;
            const pressureData = [];
            const flowData = [];
            
            for (let i = 0; i < hours; i++) {
                pressureData.push(facility.pressure + (Math.random() - 0.5) * 0.05);
                flowData.push(facility.flow + (Math.random() - 0.5) * 20);
            }
            
            // 绘制压力趋势线
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 2;
            ctx.beginPath();
            pressureData.forEach((pressure, index) => {
                const x = (index / (hours - 1)) * 280 + 15;
                const y = 30 + (1 - pressure / 0.5) * 50;
                if (index === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // 绘制流量趋势线
            ctx.strokeStyle = '#2ecc71';
            ctx.beginPath();
            flowData.forEach((flow, index) => {
                const x = (index / (hours - 1)) * 280 + 15;
                const y = 90 + (1 - flow / 200) * 50;
                if (index === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // 绘制图例
            ctx.font = '10px Microsoft YaHei';
            ctx.fillStyle = '#3498db';
            ctx.fillText('■ 压力 (MPa)', 15, 15);
            ctx.fillStyle = '#2ecc71';
            ctx.fillText('■ 流量 (L/s)', 100, 15);
        }
        
        // 显示趋势图
        function showTrendChart(facilityId) {
            console.log(`显示设施 ${facilityId} 的趋势图`);
            showDetailedView(facilityId);
        }
        
        // 显示控制面板
        function showControlPanel(facilityId) {
            const facility = facilityData.find(f => f.id === facilityId);
            if (!facility) return;
            
            const controlPanel = document.createElement('div');
            controlPanel.id = 'control-panel';
            controlPanel.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 400px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                z-index: 1002;
                padding: 25px;
                font-family: 'Microsoft YaHei', sans-serif;
            `;
            
            controlPanel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #2f3640;">${facility.name} - 控制面板</h3>
                    <button onclick="closeControlPanel()" style="
                        background: none; border: none; font-size: 20px; 
                        color: #666; cursor: pointer; padding: 5px;
                    ">&times;</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #666; font-size: 14px; margin-bottom: 10px;">设备控制</h4>
                    <button onclick="controlDevice('${facilityId}', 'start')" style="
                        padding: 8px 16px; margin-right: 10px; background: #2ecc71; 
                        color: white; border: none; border-radius: 6px; cursor: pointer;
                    ">启动</button>
                    <button onclick="controlDevice('${facilityId}', 'stop')" style="
                        padding: 8px 16px; margin-right: 10px; background: #e74c3c; 
                        color: white; border: none; border-radius: 6px; cursor: pointer;
                    ">停止</button>
                    <button onclick="controlDevice('${facilityId}', 'reset')" style="
                        padding: 8px 16px; background: #f39c12; 
                        color: white; border: none; border-radius: 6px; cursor: pointer;
                    ">复位</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #666; font-size: 14px; margin-bottom: 10px;">参数调节</h4>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px;">设定压力 (MPa):</label>
                        <input type="range" min="0.1" max="0.8" step="0.01" value="${facility.pressure}" 
                               onchange="updatePressure('${facilityId}', this.value)" 
                               style="width: 100%;">
                        <span id="pressure-value">${facility.pressure.toFixed(3)} MPa</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px;">流量设定 (L/s):</label>
                        <input type="range" min="0" max="200" step="1" value="${facility.flow}" 
                               onchange="updateFlow('${facilityId}', this.value)" 
                               style="width: 100%;">
                        <span id="flow-value">${facility.flow.toFixed(1)} L/s</span>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="applyChanges('${facilityId}')" style="
                        padding: 10px 20px; background: #4A90B8; color: white; 
                        border: none; border-radius: 6px; cursor: pointer; font-weight: 600;
                    ">应用更改</button>
                </div>
            `;
            
            // 移除已存在的面板
            const existingPanel = document.getElementById('control-panel');
            if (existingPanel) existingPanel.remove();
            
            document.body.appendChild(controlPanel);
        }
        
        // 关闭控制面板
        function closeControlPanel() {
            const panel = document.getElementById('control-panel');
            if (panel) panel.remove();
        }
        
        // 设备控制
        function controlDevice(facilityId, action) {
            console.log(`控制设备 ${facilityId}: ${action}`);
            // 这里可以调用后端API
            alert(`设备 ${facilityId} ${action} 指令已发送`);
        }
        
        // 更新压力
        function updatePressure(facilityId, value) {
            document.getElementById('pressure-value').textContent = `${parseFloat(value).toFixed(3)} MPa`;
        }
        
        // 更新流量
        function updateFlow(facilityId, value) {
            document.getElementById('flow-value').textContent = `${parseInt(value)} L/s`;
        }
        
        // 应用更改
        function applyChanges(facilityId) {
            console.log(`应用设备 ${facilityId} 的参数更改`);
            alert(`设备 ${facilityId} 参数更改已应用`);
            closeControlPanel();
        }
        
        // 在右侧面板显示设施详情
        function showFacilityInPanel(facility) {
            // 确保右侧面板展开
            if (rightPanelCollapsed) {
                toggleRightPanel();
            }
            
            // 切换到属性标签
            switchTabProgrammatically('properties');
            
            // 更新面板标题
            document.getElementById('panelTitle').textContent = `${facility.name} - 详细信息`;
            
            // 隐藏无选择提示，显示设施详情
            document.getElementById('noSelection').style.display = 'none';
            const facilityDetail = document.getElementById('selectedFacility');
            facilityDetail.style.display = 'block';
            
            // 生成设施详情HTML
            facilityDetail.innerHTML = createFacilityDetailHTML(facility);
            
            // 添加活跃状态指示
            setTimeout(() => {
                facilityDetail.style.animation = 'fadeIn 0.3s ease';
            }, 100);
        }
        
        // 程序化切换标签（不依赖event对象）
        function switchTabProgrammatically(tab) {
            // 移除所有激活状态
            document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // 激活指定标签
            const tabButton = document.querySelector(`[onclick="switchTab('${tab}')"]`);
            if (tabButton) tabButton.classList.add('active');
            
            // 显示对应内容
            const panels = {
                'properties': 'propertiesPanel',
                'layers': 'layersPanel', 
                'analysis': 'analysisPanel'
            };
            
            if (panels[tab]) {
                document.getElementById(panels[tab]).classList.add('active');
            }
        }
        
        // 创建设施详情HTML
        function createFacilityDetailHTML(facility) {
            const statusColor = getStatusColor(facility.status);
            const statusName = getStatusName(facility.status);
            const typeName = getFacilityTypeName(facility.type);
            
            // 根据设施类型生成核心指标卡片
            const coreMetrics = generateCoreMetricsHTML(facility);
            const detailMetrics = generateDetailMetricsHTML(facility);
            const qualityMetrics = generateQualityMetricsHTML(facility);
            
            return `
                <div class="facility-detail">
                    <div class="facility-header">
                        <div class="facility-info">
                            <h4>${facility.name}</h4>
                            <div class="facility-id">${typeName} · ID: ${facility.id}</div>
                        </div>
                        <div class="facility-status status-${facility.status === 'normal' ? 'normal' : facility.status === 'warning' ? 'warning' : 'critical'}">
                            ${statusName}
                        </div>
                    </div>
                    
                    <div class="metrics-grid">
                        ${coreMetrics}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h5 style="margin: 0 0 8px 0; font-size: 13px; color: #495057;">运行参数</h5>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 11px;">
                            ${detailMetrics}
                        </div>
                    </div>
                    
                    ${qualityMetrics ? `
                    <div style="margin-bottom: 15px;">
                        <h5 style="margin: 0 0 8px 0; font-size: 13px; color: #495057;">水质指标</h5>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 10px;">
                            ${qualityMetrics}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="detail-actions">
                        <button class="detail-btn primary" onclick="showDetailedTrend('${facility.id}')">趋势图</button>
                        <button class="detail-btn" onclick="showControlPanel('${facility.id}')">控制</button>
                        <button class="detail-btn" onclick="exportFacilityData('${facility.id}')">导出</button>
                    </div>
                    
                    <div style="margin-top: 12px; font-size: 10px; color: #6c757d; text-align: center;">
                        最后更新: ${new Date().toLocaleString('zh-CN', {hour12: false})}
                    </div>
                </div>
            `;
        }
        
        // 生成核心指标HTML
        function generateCoreMetricsHTML(facility) {
            let metrics = [];
            
            switch(facility.type) {
                case 'junction':
                    metrics = [
                        { label: '压力', value: `${facility.pressure.toFixed(3)}`, unit: 'MPa', status: getPressureStatus(facility.pressure) },
                        { label: '需水量', value: `${facility.demand || facility.flow.toFixed(1)}`, unit: 'L/s', status: 'normal' }
                    ];
                    break;
                    
                case 'reservoir':
                    metrics = [
                        { label: '水位', value: `${facility.head.toFixed(2)}`, unit: 'm', status: getHeadStatus(facility.head) },
                        { label: '供水量', value: `${facility.flow.toFixed(1)}`, unit: 'L/s', status: getFlowStatus(facility.flow) }
                    ];
                    break;
                    
                case 'tank':
                    const level = facility.head - facility.elevation;
                    metrics = [
                        { label: '液位', value: `${level.toFixed(2)}`, unit: 'm', status: getLevelStatus(level) },
                        { label: '流量', value: `${facility.flow > 0 ? '+' : ''}${facility.flow.toFixed(1)}`, unit: 'L/s', status: getFlowStatus(facility.flow) }
                    ];
                    break;
                    
                case 'pump_station':
                    metrics = [
                        { label: '流量', value: `${facility.flow.toFixed(1)}`, unit: 'L/s', status: getFlowStatus(facility.flow) },
                        { label: '扬程', value: `${facility.head.toFixed(1)}`, unit: 'm', status: 'normal' }
                    ];
                    break;
            }
            
            return metrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-value" style="color: ${getMetricTextColor(metric.status)};">
                        ${metric.value}<span style="font-size: 11px; font-weight: normal; margin-left: 2px;">${metric.unit}</span>
                    </div>
                    <div class="metric-label">${metric.label}</div>
                </div>
            `).join('');
        }
        
        // 生成详细参数HTML
        function generateDetailMetricsHTML(facility) {
            let metrics = [];
            
            // 通用参数
            metrics.push(
                `<div><span style="color: #6c757d;">高程:</span> <strong>${facility.elevation.toFixed(2)} m</strong></div>`,
                `<div><span style="color: #6c757d;">状态:</span> <strong style="color: ${getStatusColor(facility.status)};">${getStatusName(facility.status)}</strong></div>`
            );
            
            // 类型特定参数
            switch(facility.type) {
                case 'pump_station':
                    if (facility.speed) metrics.push(`<div><span style="color: #6c757d;">频率:</span> <strong>${facility.speed} Hz</strong></div>`);
                    if (facility.power) metrics.push(`<div><span style="color: #6c757d;">功率:</span> <strong>${facility.power} kW</strong></div>`);
                    break;
                    
                case 'tank':
                    const capacity = Math.PI * Math.pow(facility.diameter/2, 2) * facility.maxLevel;
                    metrics.push(`<div><span style="color: #6c757d;">容量:</span> <strong>${capacity.toFixed(0)} m³</strong></div>`);
                    break;
            }
            
            return metrics.join('');
        }
        
        // 生成水质指标HTML
        function generateQualityMetricsHTML(facility) {
            if (!facility.waterQuality) return null;
            
            const quality = facility.waterQuality;
            return [
                `<div><span style="color: #6c757d;">余氯:</span> <strong>${quality.chlorine.toFixed(2)} mg/L</strong></div>`,
                `<div><span style="color: #6c757d;">pH:</span> <strong>${quality.ph.toFixed(1)}</strong></div>`,
                `<div><span style="color: #6c757d;">浊度:</span> <strong>${quality.turbidity.toFixed(2)} NTU</strong></div>`
            ].join('');
        }
        
        // 显示详细趋势图
        function showDetailedTrend(facilityId) {
            // 切换到分析标签并显示趋势图
            switchTabProgrammatically('analysis');
            
            const analysisContent = document.getElementById('analysisContent');
            analysisContent.innerHTML = `
                <div style="padding: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #495057;">设施 ${facilityId} - 趋势分析</h4>
                    <canvas id="trendCanvas" width="340" height="200" style="border: 1px solid #dee2e6; border-radius: 4px;"></canvas>
                    <div style="margin-top: 10px; font-size: 11px; color: #6c757d; text-align: center;">
                        24小时历史数据趋势
                    </div>
                </div>
            `;
            
            // 绘制趋势图
            setTimeout(() => generateTrendChart(facilityData.find(f => f.id === facilityId)), 100);
        }
        
        // 导出设施数据
        function exportFacilityData(facilityId) {
            console.log(`导出设施 ${facilityId} 的数据`);
            alert(`设施 ${facilityId} 数据导出功能开发中...`);
        }
        
        // 在右侧面板显示管道详情
        function showPipelineInPanel(pipe) {
            // 确保右侧面板展开
            if (rightPanelCollapsed) {
                toggleRightPanel();
            }
            
            // 切换到属性标签
            switchTabProgrammatically('properties');
            
            // 更新面板标题
            document.getElementById('panelTitle').textContent = `管道 ${pipe.id} - 详细信息`;
            
            // 隐藏无选择提示，显示管道详情
            document.getElementById('noSelection').style.display = 'none';
            const facilityDetail = document.getElementById('selectedFacility');
            facilityDetail.style.display = 'block';
            
            // 生成管道详情HTML
            facilityDetail.innerHTML = createPipelineDetailHTML(pipe);
        }
        
        // 创建管道详情HTML
        function createPipelineDetailHTML(pipe) {
            const statusColor = getStatusColor(pipe.status);
            const statusName = getStatusName(pipe.status);
            
            // 计算管道特征参数
            const velocity = pipe.velocity || (pipe.flowRate / (Math.PI * Math.pow(pipe.diameter/2000, 2)));
            const unitLoss = pipe.headloss ? (pipe.headloss / (pipe.length/1000)) : 0;
            const absoluteFlow = Math.abs(pipe.flowRate);
            
            return `
                <div class="facility-detail">
                    <div class="facility-header">
                        <div class="facility-info">
                            <h4>管道 ${pipe.id}</h4>
                            <div class="facility-id">管道 · ${pipe.from} → ${pipe.to}</div>
                        </div>
                        <div class="facility-status status-${pipe.status === 'normal' ? 'normal' : 'warning'}">
                            ${statusName}
                        </div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value" style="color: ${getFlowTextColor(pipe.flowRate)};">
                                ${pipe.flowRate > 0 ? '+' : ''}${pipe.flowRate.toFixed(1)}<span style="font-size: 11px; font-weight: normal; margin-left: 2px;">L/s</span>
                            </div>
                            <div class="metric-label">流量</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" style="color: ${getVelocityTextColor(velocity)};">
                                ${velocity.toFixed(2)}<span style="font-size: 11px; font-weight: normal; margin-left: 2px;">m/s</span>
                            </div>
                            <div class="metric-label">流速</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h5 style="margin: 0 0 8px 0; font-size: 13px; color: #495057;">管道参数</h5>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 11px;">
                            <div><span style="color: #6c757d;">直径:</span> <strong>${pipe.diameter} mm</strong></div>
                            <div><span style="color: #6c757d;">长度:</span> <strong>${pipe.length.toFixed(1)} km</strong></div>
                            <div><span style="color: #6c757d;">材质:</span> <strong>${pipe.material || 'CI'}</strong></div>
                            <div><span style="color: #6c757d;">粗糙度:</span> <strong>${pipe.roughness}</strong></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h5 style="margin: 0 0 8px 0; font-size: 13px; color: #495057;">水力特性</h5>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 11px;">
                            <div><span style="color: #6c757d;">水头损失:</span> <strong style="color: ${pipe.headloss > 1 ? '#e74c3c' : '#27ae60'};">${pipe.headloss ? pipe.headloss.toFixed(4) : 'N/A'} m</strong></div>
                            <div><span style="color: #6c757d;">单位水损:</span> <strong style="color: ${unitLoss > 5 ? '#e74c3c' : '#27ae60'};">${unitLoss.toFixed(2)} m/km</strong></div>
                            <div><span style="color: #6c757d;">绝对流量:</span> <strong>${absoluteFlow.toFixed(1)} L/s</strong></div>
                            <div><span style="color: #6c757d;">状态:</span> <strong style="color: ${getStatusColor(pipe.status)};">${getStatusName(pipe.status)}</strong></div>
                        </div>
                    </div>
                    
                    <div class="detail-actions">
                        <button class="detail-btn primary" onclick="showPipeAnalysis('${pipe.id}')">水力分析</button>
                        <button class="detail-btn" onclick="showFlowTrend('${pipe.id}')">流量趋势</button>
                        <button class="detail-btn" onclick="exportPipelineData('${pipe.id}')">导出</button>
                    </div>
                    
                    <div style="margin-top: 12px; font-size: 10px; color: #6c757d; text-align: center;">
                        最后更新: ${new Date().toLocaleString('zh-CN', {hour12: false})}
                    </div>
                </div>
            `;
        }
        
        // 导出管道数据
        function exportPipelineData(pipeId) {
            console.log(`导出管道 ${pipeId} 的数据`);
            alert(`管道 ${pipeId} 数据导出功能开发中...`);
        }
        
        // 管道分析
        function showPipeAnalysis(pipeId) {
            const pipe = pipelineData.find(p => p.id === pipeId);
            if (!pipe) return;
            
            console.log(`显示管道 ${pipeId} 的水力分析`);
            alert(`管道 ${pipeId} 水力分析功能开发中...`);
        }
        
        // 流量趋势
        function showFlowTrend(pipeId) {
            console.log(`显示管道 ${pipeId} 的流量趋势`);
            alert(`管道 ${pipeId} 流量趋势分析功能开发中...`);
        }
    </script>
</body>
</html> 